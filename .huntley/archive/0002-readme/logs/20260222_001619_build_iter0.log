{"type":"system","subtype":"init","cwd":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","tools":["Task","TaskOutput","Bash","Glob","Grep","ExitPlanMode","Read","Edit","Write","NotebookEdit","WebFetch","TodoWrite","WebSearch","TaskStop","AskUserQuestion","Skill","EnterPlanMode","EnterWorktree","ToolSearch"],"mcp_servers":[{"name":"claude.ai Ruska Zoho","status":"needs-auth"},{"name":"playwright","status":"failed"}],"model":"claude-opus-4-6","permissionMode":"bypassPermissions","slash_commands":["keybindings-help","debug","claude-developer-platform","dev-browser","dev-browser:dev-browser","compact","context","cost","init","pr-comments","release-notes","review","security-review","extra-usage","insights"],"apiKeySource":"none","claude_code_version":"2.1.50","output_style":"default","agents":["Bash","general-purpose","statusline-setup","Explore","Plan","product-manager","master-orchestrator","system-architect","integration-validator"],"skills":["keybindings-help","debug","claude-developer-platform","dev-browser","dev-browser:dev-browser"],"plugins":[{"name":"dev-browser","path":"/home/ryaneggz/.claude/plugins/cache/dev-browser-marketplace/dev-browser/66682fb0513a"}],"uuid":"b3cf2fba-c478-44b6-82c9-037b0e5cc53d","fast_mode_state":"off"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01TfcxBrMMCbVFiXZt9yKAaY","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me analyze the current state:\n\n1. The IMPLEMENTATION_PLAN.md shows all Tiers 1-8 are complete\n2. The next priority is Tier 9 - README Documentation\n3. I need to study the specs and source code first, then implement the README\n\nLet me start by studying the specs and source code in parallel to understand what needs to be documented.","signature":"EvMDCkYICxgCKkDNwjZXiuMbiRdB7AGIs4GeQG2Kom+TwYP5dTVs4cvu/zqj48KD/ez1vdlBWjbncRAfcN2e+A7IHH1UnTBYqsllEgyjA/KGDrV7j5/9Yt8aDFWrKXXUG8KA8/WBKSIwmSI8gDsWJ9nX3S+b56B5LnKkgAgkrh7+TQ35i1rCEnIk/qGmSQaQ4cbhBY3sXwGZKtoCgZvj54kb+wr11E7ULWUCufyXCAUaGgZYothQpIKadUTQgEwpb0EGXBGW5s3ygJt9meaoQJAw4cHpydc3WrtyLl+UYHzpbUKBi3eQkjCs7YMYWNDk2c6t9wNT7glW5tty1BaxLHR87PvLAl/UFC4hGbTPH9BC94UtJE8SrgaPlBOr4Iy9qTKDIq3JC58l7VxGtgo9LLoS4itcRew4RNeh3GqAXGfiUEAnOfHAQ71MiKw1/7ekTpzpYbGB+UH5eSySnMzdNSuABVqg62ZsB7SFUXtKy0wcR9n+JkiZUbn0gAlvhM7MKT+zfwhmeQmxaMKr51gkjhEU6NDYkoPup/9gQ9l9Vn/6dOVRGZHppv21GRAYqPRmcJE6Mszhj3V8v4CoHBBnHHNHnKyqMIPVmtGzGWHmnxksavzjC1YOMGe2CnjWWhFS/+B8v9QMEvdIUubLFN9VSUIXKWbwABgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":0,"cache_read_input_tokens":25164,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":0},"output_tokens":10,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"d9dd6079-9d49-4a4a-9143-2f005aecb4b7"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01TfcxBrMMCbVFiXZt9yKAaY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016PCLJVBaP1gKzeuX2E7E3v","name":"TodoWrite","input":{"todos":[{"content":"Study specs and source code","status":"in_progress","activeForm":"Studying specs and source code"},{"content":"Author README.md per spec 01-setup-readme.md","status":"pending","activeForm":"Authoring README.md"},{"content":"Verify README code examples compile against public API","status":"pending","activeForm":"Verifying README code examples"},{"content":"Update IMPLEMENTATION_PLAN.md and commit/push","status":"pending","activeForm":"Updating plan and committing"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":0,"cache_read_input_tokens":25164,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":0},"output_tokens":10,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"91b283d2-57d1-4de8-9288-a31b882a6231"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016PCLJVBaP1gKzeuX2E7E3v","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"77a270a9-e7bd-4d7b-8f5f-285dad381e05","tool_use_result":{"oldTodos":[],"newTodos":[{"content":"Study specs and source code","status":"in_progress","activeForm":"Studying specs and source code"},{"content":"Author README.md per spec 01-setup-readme.md","status":"pending","activeForm":"Authoring README.md"},{"content":"Verify README code examples compile against public API","status":"pending","activeForm":"Verifying README code examples"},{"content":"Update IMPLEMENTATION_PLAN.md and commit/push","status":"pending","activeForm":"Updating plan and committing"}]}}
{"type":"rate_limit_event","rate_limit_info":{"status":"allowed","resetsAt":1771750800,"rateLimitType":"five_hour","overageStatus":"rejected","overageDisabledReason":"org_level_disabled","isUsingOverage":false},"uuid":"749c0fc8-e1f5-4602-9fd0-837de16300f1","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01GNwwZkjGmN5h5eH2CHehjN","type":"message","role":"assistant","content":[{"type":"text","text":"Let me study the specs and all source code in parallel."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":334,"cache_read_input_tokens":25164,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":334},"output_tokens":5,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"9a02fb77-19b6-4c5e-810a-8c98a2002d24"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01GNwwZkjGmN5h5eH2CHehjN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012VH1xZQy1bJCSAhDtuJPGD","name":"Task","input":{"description":"Study spec 01-setup-readme","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/specs/01-setup-readme.md and return its complete contents.","subagent_type":"Explore","model":"sonnet"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":334,"cache_read_input_tokens":25164,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":334},"output_tokens":5,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"4d7debba-c630-47eb-ada7-68ad7012fcbb"}
{"type":"user","message":{"role":"user","content":[{"type":"text","text":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/specs/01-setup-readme.md and return its complete contents."}]},"parent_tool_use_id":"toolu_012VH1xZQy1bJCSAhDtuJPGD","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"1dca9454-c015-4907-8d8d-1ce51e91a719"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01GNwwZkjGmN5h5eH2CHehjN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01N9xy9WFsMJnF7NSC2UqbTz","name":"Task","input":{"description":"Study src/index.ts exports","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/index.ts completely and return all its contents. This is the barrel export file for the library.","subagent_type":"Explore","model":"sonnet"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":334,"cache_read_input_tokens":25164,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":334},"output_tokens":5,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"fc9ac33b-7aef-475f-8e32-6b3d9e09a99b"}
{"type":"user","message":{"role":"user","content":[{"type":"text","text":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/index.ts completely and return all its contents. This is the barrel export file for the library."}]},"parent_tool_use_id":"toolu_01N9xy9WFsMJnF7NSC2UqbTz","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"25ae3d4e-263e-4d3c-86e5-731aa8c075f6"}
{"type":"assistant","message":{"model":"claude-sonnet-4-6","id":"msg_01UYBNxGqyedFt2iMK6tB44A","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JGipLMprozuMuCAuDhCS17","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/specs/01-setup-readme.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":537,"cache_read_input_tokens":10563,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":537},"output_tokens":19,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_012VH1xZQy1bJCSAhDtuJPGD","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"b6546fe2-5115-4b9d-b4d4-835654638738"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JGipLMprozuMuCAuDhCS17","type":"tool_result","content":"     1→## CONTEXT\n     2→\n     3→### SUGGESTED TOOLS & SKILLS TO USE\n     4→- **agent-browser**: validate frontend changes\n     5→- **curl**: validate api changes\n     6→\n     7→### USER STORIES\n     8→- As a developer I would like a README\n     9→\n    10→## GOAL\n    11→- Create a plan that outlines user stories, reproduction steps, and acceptance critieria that align to complete the task."}]},"parent_tool_use_id":"toolu_012VH1xZQy1bJCSAhDtuJPGD","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"0d40dacc-1aeb-4a39-be0d-f289756944e2"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01GNwwZkjGmN5h5eH2CHehjN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019HQB83uJ6b2VSsyKNye9j9","name":"Task","input":{"description":"Study src/types.ts","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/types.ts completely and return all its contents.","subagent_type":"Explore","model":"sonnet"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":334,"cache_read_input_tokens":25164,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":334},"output_tokens":5,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"7f41b4d7-9d04-4829-911b-d9ee49fdb404"}
{"type":"user","message":{"role":"user","content":[{"type":"text","text":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/types.ts completely and return all its contents."}]},"parent_tool_use_id":"toolu_019HQB83uJ6b2VSsyKNye9j9","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"675e33e6-a4ee-4384-b633-92e759fe68aa"}
{"type":"assistant","message":{"model":"claude-sonnet-4-6","id":"msg_01NsfoC67G5qqyj3pz8SwTtq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01V6qgRQPRbj69Sat8FEQssa","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/index.ts"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":544,"cache_read_input_tokens":10563,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":544},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01N9xy9WFsMJnF7NSC2UqbTz","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"b8bb0a71-6af3-4da2-ac84-8b41732a2f4f"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01V6qgRQPRbj69Sat8FEQssa","type":"tool_result","content":"     1→// Types\n     2→export type {\n     3→  AgentEventType,\n     4→  BaseEvent,\n     5→  ToolCallEvent,\n     6→  ToolResultEvent,\n     7→  ErrorEvent,\n     8→  HumanInputRequestedEvent,\n     9→  HumanInputReceivedEvent,\n    10→  MessageEvent,\n    11→  CompletionEvent,\n    12→  SummaryEvent,\n    13→  AgentEvent,\n    14→  AgentThread,\n    15→  TokenUsage,\n    16→  StopConditionContext,\n    17→  StopConditionResult,\n    18→  StopCondition,\n    19→  VerifyContext,\n    20→  VerifyResult,\n    21→  VerifyCompletion,\n    22→  ContextManagementConfig,\n    23→  MiddlewareContext,\n    24→  AgentMiddleware,\n    25→  DeepFactorAgentSettings,\n    26→  AgentResult,\n    27→  PendingResult,\n    28→} from \"./types.js\";\n    29→\n    30→// Stop conditions\n    31→export {\n    32→  maxIterations,\n    33→  maxTokens,\n    34→  maxInputTokens,\n    35→  maxOutputTokens,\n    36→  maxCost,\n    37→  calculateCost,\n    38→  MODEL_PRICING,\n    39→  evaluateStopConditions,\n    40→} from \"./stop-conditions.js\";\n    41→\n    42→// Middleware\n    43→export {\n    44→  composeMiddleware,\n    45→  todoMiddleware,\n    46→  errorRecoveryMiddleware,\n    47→} from \"./middleware.js\";\n    48→\n    49→// Context management\n    50→export { ContextManager, estimateTokens } from \"./context-manager.js\";\n    51→\n    52→// Agent\n    53→export { DeepFactorAgent, addUsage } from \"./agent.js\";\n    54→\n    55→// Factory\n    56→export { createDeepFactorAgent } from \"./create-agent.js\";\n    57→\n    58→// Human-in-the-loop\n    59→export { requestHumanInput } from \"./human-in-the-loop.js\";\n    60→"}]},"parent_tool_use_id":"toolu_01N9xy9WFsMJnF7NSC2UqbTz","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"5754292b-0758-43fd-9393-28eb1ae08c55"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01GNwwZkjGmN5h5eH2CHehjN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NNaDfKGwAaSCJUfopDMNs5","name":"Task","input":{"description":"Study src/agent.ts","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/agent.ts completely and return all its contents.","subagent_type":"Explore","model":"sonnet"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":334,"cache_read_input_tokens":25164,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":334},"output_tokens":5,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"ef789f10-816e-4167-afa0-3f617a71c48a"}
{"type":"user","message":{"role":"user","content":[{"type":"text","text":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/agent.ts completely and return all its contents."}]},"parent_tool_use_id":"toolu_01NNaDfKGwAaSCJUfopDMNs5","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"bc6e305d-2f4b-4134-9294-6ccf98c13781"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012VH1xZQy1bJCSAhDtuJPGD","type":"tool_result","content":[{"type":"text","text":"Here are the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/specs/01-setup-readme.md`:\n\n---\n\n## CONTEXT\n\n### SUGGESTED TOOLS & SKILLS TO USE\n- **agent-browser**: validate frontend changes\n- **curl**: validate api changes\n\n### USER STORIES\n- As a developer I would like a README\n\n## GOAL\n- Create a plan that outlines user stories, reproduction steps, and acceptance critieria that align to complete the task."},{"type":"text","text":"agentId: a75c7fa32e34bd691 (for resuming to continue this agent's work if needed)\n<usage>total_tokens: 11465\ntool_uses: 1\nduration_ms: 4219</usage>"}]}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"fe5b5506-dbd8-47b6-871d-9a6e895afca9","tool_use_result":{"status":"completed","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/specs/01-setup-readme.md and return its complete contents.","agentId":"a75c7fa32e34bd691","content":[{"type":"text","text":"Here are the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/specs/01-setup-readme.md`:\n\n---\n\n## CONTEXT\n\n### SUGGESTED TOOLS & SKILLS TO USE\n- **agent-browser**: validate frontend changes\n- **curl**: validate api changes\n\n### USER STORIES\n- As a developer I would like a README\n\n## GOAL\n- Create a plan that outlines user stories, reproduction steps, and acceptance critieria that align to complete the task."}],"totalDurationMs":4219,"totalTokens":11465,"totalToolUseCount":1,"usage":{"input_tokens":1,"cache_creation_input_tokens":244,"cache_read_input_tokens":11100,"output_tokens":120,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":244,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}}}
{"type":"assistant","message":{"model":"claude-sonnet-4-6","id":"msg_014fmsGLFf9ZUfP8pAqbWfzH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GmVTRt2iqqScCWrBfAF5mU","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/types.ts"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":534,"cache_read_input_tokens":10563,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":534},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_019HQB83uJ6b2VSsyKNye9j9","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"e01cbe5e-d4a6-4b5a-921b-56d8ab40ac8f"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GmVTRt2iqqScCWrBfAF5mU","type":"tool_result","content":"     1→import type { LanguageModel, ToolSet } from \"ai\";\n     2→\n     3→// --- Event Types ---\n     4→\n     5→export type AgentEventType =\n     6→  | \"tool_call\"\n     7→  | \"tool_result\"\n     8→  | \"error\"\n     9→  | \"human_input_requested\"\n    10→  | \"human_input_received\"\n    11→  | \"message\"\n    12→  | \"completion\"\n    13→  | \"summary\";\n    14→\n    15→export interface BaseEvent {\n    16→  type: AgentEventType;\n    17→  timestamp: number;\n    18→  iteration: number;\n    19→}\n    20→\n    21→export interface ToolCallEvent extends BaseEvent {\n    22→  type: \"tool_call\";\n    23→  toolName: string;\n    24→  toolCallId: string;\n    25→  args: Record<string, unknown>;\n    26→}\n    27→\n    28→export interface ToolResultEvent extends BaseEvent {\n    29→  type: \"tool_result\";\n    30→  toolCallId: string;\n    31→  result: unknown;\n    32→}\n    33→\n    34→export interface ErrorEvent extends BaseEvent {\n    35→  type: \"error\";\n    36→  error: string;\n    37→  toolCallId?: string;\n    38→  recoverable: boolean;\n    39→}\n    40→\n    41→export interface HumanInputRequestedEvent extends BaseEvent {\n    42→  type: \"human_input_requested\";\n    43→  question: string;\n    44→  context?: string;\n    45→  urgency?: \"low\" | \"medium\" | \"high\";\n    46→  format?: \"free_text\" | \"yes_no\" | \"multiple_choice\";\n    47→  choices?: string[];\n    48→}\n    49→\n    50→export interface HumanInputReceivedEvent extends BaseEvent {\n    51→  type: \"human_input_received\";\n    52→  response: string;\n    53→}\n    54→\n    55→export interface MessageEvent extends BaseEvent {\n    56→  type: \"message\";\n    57→  role: \"user\" | \"assistant\" | \"system\";\n    58→  content: string;\n    59→}\n    60→\n    61→export interface CompletionEvent extends BaseEvent {\n    62→  type: \"completion\";\n    63→  result: string;\n    64→  verified: boolean;\n    65→}\n    66→\n    67→export interface SummaryEvent extends BaseEvent {\n    68→  type: \"summary\";\n    69→  summarizedIterations: number[];\n    70→  summary: string;\n    71→}\n    72→\n    73→export type AgentEvent =\n    74→  | ToolCallEvent\n    75→  | ToolResultEvent\n    76→  | ErrorEvent\n    77→  | HumanInputRequestedEvent\n    78→  | HumanInputReceivedEvent\n    79→  | MessageEvent\n    80→  | CompletionEvent\n    81→  | SummaryEvent;\n    82→\n    83→// --- Thread ---\n    84→\n    85→export interface AgentThread {\n    86→  id: string;\n    87→  events: AgentEvent[];\n    88→  metadata: Record<string, unknown>;\n    89→  createdAt: number;\n    90→  updatedAt: number;\n    91→}\n    92→\n    93→// --- Token Usage ---\n    94→\n    95→export interface TokenUsage {\n    96→  inputTokens: number;\n    97→  outputTokens: number;\n    98→  totalTokens: number;\n    99→  cacheReadTokens?: number;\n   100→  cacheWriteTokens?: number;\n   101→}\n   102→\n   103→// --- Stop Conditions ---\n   104→\n   105→export interface StopConditionContext {\n   106→  iteration: number;\n   107→  usage: TokenUsage;\n   108→  model: string;\n   109→  thread: AgentThread;\n   110→}\n   111→\n   112→export interface StopConditionResult {\n   113→  stop: boolean;\n   114→  reason?: string;\n   115→}\n   116→\n   117→export type StopCondition = (ctx: StopConditionContext) => StopConditionResult;\n   118→\n   119→// --- Verification ---\n   120→\n   121→export interface VerifyContext {\n   122→  result: unknown;\n   123→  iteration: number;\n   124→  thread: AgentThread;\n   125→  originalPrompt: string;\n   126→}\n   127→\n   128→export interface VerifyResult {\n   129→  complete: boolean;\n   130→  reason?: string;\n   131→}\n   132→\n   133→export type VerifyCompletion = (ctx: VerifyContext) => Promise<VerifyResult>;\n   134→\n   135→// --- Context Management ---\n   136→\n   137→export interface ContextManagementConfig {\n   138→  maxContextTokens?: number;\n   139→  keepRecentIterations?: number;\n   140→}\n   141→\n   142→// --- Middleware ---\n   143→\n   144→export interface MiddlewareContext {\n   145→  thread: AgentThread;\n   146→  iteration: number;\n   147→  settings: DeepFactorAgentSettings;\n   148→}\n   149→\n   150→export interface AgentMiddleware {\n   151→  name: string;\n   152→  tools?: ToolSet;\n   153→  beforeIteration?: (ctx: MiddlewareContext) => Promise<void>;\n   154→  afterIteration?: (\n   155→    ctx: MiddlewareContext,\n   156→    result: unknown,\n   157→  ) => Promise<void>;\n   158→}\n   159→\n   160→// --- Agent Settings ---\n   161→\n   162→export interface DeepFactorAgentSettings<\n   163→  TTools extends ToolSet = ToolSet,\n   164→> {\n   165→  model: LanguageModel | string;\n   166→  tools?: TTools;\n   167→  instructions?: string;\n   168→  stopWhen?: StopCondition | StopCondition[];\n   169→  verifyCompletion?: VerifyCompletion;\n   170→  middleware?: AgentMiddleware[];\n   171→  interruptOn?: string[];\n   172→  contextManagement?: ContextManagementConfig;\n   173→  onIterationStart?: (iteration: number) => void;\n   174→  onIterationEnd?: (iteration: number, result: unknown) => void;\n   175→}\n   176→\n   177→// --- Results ---\n   178→\n   179→export interface AgentResult {\n   180→  response: string;\n   181→  thread: AgentThread;\n   182→  usage: TokenUsage;\n   183→  iterations: number;\n   184→  stopReason:\n   185→    | \"completed\"\n   186→    | \"stop_condition\"\n   187→    | \"max_errors\"\n   188→    | \"human_input_needed\";\n   189→  stopDetail?: string;\n   190→}\n   191→\n   192→export interface PendingResult extends AgentResult {\n   193→  stopReason: \"human_input_needed\";\n   194→  resume: (humanResponse: string) => Promise<AgentResult>;\n   195→}\n   196→"}]},"parent_tool_use_id":"toolu_019HQB83uJ6b2VSsyKNye9j9","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"ab1bf547-c7a7-4106-9750-eb130492fe60"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01GNwwZkjGmN5h5eH2CHehjN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QHAcRCQipPe8VqpF7Kenec","name":"Task","input":{"description":"Study src/create-agent.ts","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/create-agent.ts completely and return all its contents.","subagent_type":"Explore","model":"sonnet"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":334,"cache_read_input_tokens":25164,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":334},"output_tokens":5,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"c9223fee-46e6-45ca-a75f-e79aacd00623"}
{"type":"user","message":{"role":"user","content":[{"type":"text","text":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/create-agent.ts completely and return all its contents."}]},"parent_tool_use_id":"toolu_01QHAcRCQipPe8VqpF7Kenec","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"4eaf3ecd-e4bf-4332-8fe7-488a291bc9e1"}
{"type":"assistant","message":{"model":"claude-sonnet-4-6","id":"msg_01BKGmPfCZPYypKGwQ9DQR3x","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KDSjpE8qvY3pe1ZmtSdoHu","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/agent.ts"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":534,"cache_read_input_tokens":10563,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":534},"output_tokens":19,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01NNaDfKGwAaSCJUfopDMNs5","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"e63d0c0f-9944-497c-8978-e0ef336e7ee1"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KDSjpE8qvY3pe1ZmtSdoHu","type":"tool_result","content":"     1→import type { LanguageModel, ToolSet } from \"ai\";\n     2→import { generateText, streamText, stepCountIs } from \"ai\";\n     3→import type { ModelMessage } from \"@ai-sdk/provider-utils\";\n     4→import { composeMiddleware } from \"./middleware.js\";\n     5→import type { ComposedMiddleware } from \"./middleware.js\";\n     6→import { evaluateStopConditions } from \"./stop-conditions.js\";\n     7→import { ContextManager } from \"./context-manager.js\";\n     8→import type {\n     9→  AgentThread,\n    10→  AgentResult,\n    11→  PendingResult,\n    12→  TokenUsage,\n    13→  StopCondition,\n    14→  DeepFactorAgentSettings,\n    15→  ToolCallEvent,\n    16→  ToolResultEvent,\n    17→  MessageEvent as AgentMessageEvent,\n    18→  ErrorEvent,\n    19→  CompletionEvent,\n    20→  HumanInputRequestedEvent,\n    21→  HumanInputReceivedEvent,\n    22→  AgentMiddleware,\n    23→  MiddlewareContext,\n    24→} from \"./types.js\";\n    25→\n    26→let threadCounter = 0;\n    27→\n    28→function createThreadId(): string {\n    29→  return `thread_${Date.now()}_${++threadCounter}`;\n    30→}\n    31→\n    32→export function addUsage(a: TokenUsage, b: TokenUsage): TokenUsage {\n    33→  return {\n    34→    inputTokens: a.inputTokens + b.inputTokens,\n    35→    outputTokens: a.outputTokens + b.outputTokens,\n    36→    totalTokens: a.totalTokens + b.totalTokens,\n    37→    cacheReadTokens:\n    38→      (a.cacheReadTokens ?? 0) + (b.cacheReadTokens ?? 0) || undefined,\n    39→    cacheWriteTokens:\n    40→      (a.cacheWriteTokens ?? 0) + (b.cacheWriteTokens ?? 0) || undefined,\n    41→  };\n    42→}\n    43→\n    44→function extractUsage(sdkUsage: {\n    45→  inputTokens?: number | undefined;\n    46→  outputTokens?: number | undefined;\n    47→  totalTokens?: number | undefined;\n    48→  inputTokenDetails?: {\n    49→    cacheReadTokens?: number | undefined;\n    50→    cacheWriteTokens?: number | undefined;\n    51→  };\n    52→}): TokenUsage {\n    53→  return {\n    54→    inputTokens: sdkUsage.inputTokens ?? 0,\n    55→    outputTokens: sdkUsage.outputTokens ?? 0,\n    56→    totalTokens: sdkUsage.totalTokens ?? 0,\n    57→    cacheReadTokens:\n    58→      sdkUsage.inputTokenDetails?.cacheReadTokens ?? undefined,\n    59→    cacheWriteTokens:\n    60→      sdkUsage.inputTokenDetails?.cacheWriteTokens ?? undefined,\n    61→  };\n    62→}\n    63→\n    64→function compactError(error: unknown, maxLen = 500): string {\n    65→  const msg =\n    66→    error instanceof Error\n    67→      ? `${error.name}: ${error.message}`\n    68→      : String(error);\n    69→  return msg.length > maxLen ? msg.substring(0, maxLen) + \"...\" : msg;\n    70→}\n    71→\n    72→function createThread(): AgentThread {\n    73→  const now = Date.now();\n    74→  return {\n    75→    id: createThreadId(),\n    76→    events: [],\n    77→    metadata: {},\n    78→    createdAt: now,\n    79→    updatedAt: now,\n    80→  };\n    81→}\n    82→\n    83→export class DeepFactorAgent<TTools extends ToolSet = ToolSet> {\n    84→  private model: LanguageModel;\n    85→  private tools: TTools;\n    86→  private instructions: string;\n    87→  private stopConditions: StopCondition[];\n    88→  private verifyCompletion: DeepFactorAgentSettings[\"verifyCompletion\"];\n    89→  private composedMiddleware: ComposedMiddleware;\n    90→  private interruptOn: string[];\n    91→  private contextManager: ContextManager;\n    92→  private onIterationStart?: (iteration: number) => void;\n    93→  private onIterationEnd?: (iteration: number, result: unknown) => void;\n    94→  private modelId: string;\n    95→\n    96→  constructor(settings: DeepFactorAgentSettings<TTools>) {\n    97→    if (typeof settings.model === \"string\") {\n    98→      throw new Error(\n    99→        \"String model IDs are not supported. Please pass a LanguageModel instance.\",\n   100→      );\n   101→    }\n   102→    this.model = settings.model;\n   103→    this.modelId =\n   104→      typeof settings.model === \"object\" &&\n   105→      \"modelId\" in settings.model\n   106→        ? settings.model.modelId\n   107→        : \"unknown\";\n   108→    this.tools = (settings.tools ?? {}) as TTools;\n   109→    this.instructions = settings.instructions ?? \"\";\n   110→    this.verifyCompletion = settings.verifyCompletion;\n   111→    this.interruptOn = settings.interruptOn ?? [];\n   112→    this.onIterationStart = settings.onIterationStart;\n   113→    this.onIterationEnd = settings.onIterationEnd;\n   114→\n   115→    // Normalize stopWhen\n   116→    if (!settings.stopWhen) {\n   117→      this.stopConditions = [];\n   118→    } else if (Array.isArray(settings.stopWhen)) {\n   119→      this.stopConditions = settings.stopWhen;\n   120→    } else {\n   121→      this.stopConditions = [settings.stopWhen];\n   122→    }\n   123→\n   124→    // Compose middleware\n   125→    const middlewareList: AgentMiddleware[] = settings.middleware ?? [];\n   126→    this.composedMiddleware = composeMiddleware(middlewareList);\n   127→\n   128→    // Context management\n   129→    this.contextManager = new ContextManager(settings.contextManagement);\n   130→  }\n   131→\n   132→  private buildMessages(thread: AgentThread): {\n   133→    system: string | undefined;\n   134→    messages: ModelMessage[];\n   135→  } {\n   136→    const messages: ModelMessage[] = [];\n   137→\n   138→    // Build context injection from summaries\n   139→    const contextInjection =\n   140→      this.contextManager.buildContextInjection(thread);\n   141→    let system: string | undefined;\n   142→    if (this.instructions || contextInjection) {\n   143→      system = [contextInjection, this.instructions]\n   144→        .filter(Boolean)\n   145→        .join(\"\\n\\n\");\n   146→    }\n   147→\n   148→    // Convert thread events to messages\n   149→    for (const event of thread.events) {\n   150→      switch (event.type) {\n   151→        case \"message\": {\n   152→          if (event.role === \"user\") {\n   153→            messages.push({ role: \"user\", content: event.content });\n   154→          } else if (event.role === \"assistant\") {\n   155→            messages.push({ role: \"assistant\", content: event.content });\n   156→          } else if (event.role === \"system\") {\n   157→            // System messages injected as user messages with context marker\n   158→            messages.push({\n   159→              role: \"user\",\n   160→              content: `[System]: ${event.content}`,\n   161→            });\n   162→          }\n   163→          break;\n   164→        }\n   165→        case \"tool_call\": {\n   166→          // Tool calls are part of assistant messages - we'll let the SDK handle multi-step\n   167→          // They are included through the response.messages history\n   168→          break;\n   169→        }\n   170→        case \"tool_result\": {\n   171→          // Tool results are part of tool messages - handled by SDK\n   172→          break;\n   173→        }\n   174→        case \"human_input_received\": {\n   175→          messages.push({\n   176→            role: \"user\",\n   177→            content: `[Human Response]: ${event.response}`,\n   178→          });\n   179→          break;\n   180→        }\n   181→        case \"summary\": {\n   182→          // Summaries are injected via context injection in the system prompt\n   183→          break;\n   184→        }\n   185→        default:\n   186→          break;\n   187→      }\n   188→    }\n   189→\n   190→    return { system, messages };\n   191→  }\n   192→\n   193→  private appendResultEvents(\n   194→    thread: AgentThread,\n   195→    result: {\n   196→      text: string;\n   197→      steps: Array<{\n   198→        toolCalls: Array<{\n   199→          toolCallId: string;\n   200→          toolName: string;\n   201→          input?: unknown;\n   202→          args?: unknown;\n   203→        }>;\n   204→        toolResults: Array<{\n   205→          toolCallId: string;\n   206→          toolName?: string;\n   207→          output?: unknown;\n   208→          result?: unknown;\n   209→        }>;\n   210→        text: string;\n   211→      }>;\n   212→    },\n   213→    iteration: number,\n   214→  ): void {\n   215→    const now = Date.now();\n   216→\n   217→    for (const step of result.steps) {\n   218→      // Record tool calls\n   219→      for (const tc of step.toolCalls) {\n   220→        const toolCallEvent: ToolCallEvent = {\n   221→          type: \"tool_call\",\n   222→          toolName: tc.toolName,\n   223→          toolCallId: tc.toolCallId,\n   224→          args: (tc.input ?? tc.args ?? {}) as Record<string, unknown>,\n   225→          timestamp: now,\n   226→          iteration,\n   227→        };\n   228→        thread.events.push(toolCallEvent);\n   229→      }\n   230→\n   231→      // Record tool results\n   232→      for (const tr of step.toolResults) {\n   233→        const toolResultEvent: ToolResultEvent = {\n   234→          type: \"tool_result\",\n   235→          toolCallId: tr.toolCallId,\n   236→          result: tr.output ?? tr.result,\n   237→          timestamp: now,\n   238→          iteration,\n   239→        };\n   240→        thread.events.push(toolResultEvent);\n   241→      }\n   242→    }\n   243→\n   244→    // Record assistant message\n   245→    if (result.text) {\n   246→      const messageEvent: AgentMessageEvent = {\n   247→        type: \"message\",\n   248→        role: \"assistant\",\n   249→        content: result.text,\n   250→        timestamp: now,\n   251→        iteration,\n   252→      };\n   253→      thread.events.push(messageEvent);\n   254→    }\n   255→\n   256→    thread.updatedAt = now;\n   257→  }\n   258→\n   259→  private isPendingHumanInput(thread: AgentThread): boolean {\n   260→    // Check if the last relevant event is a human input request without a response\n   261→    const requestEvents = thread.events.filter(\n   262→      (e) => e.type === \"human_input_requested\",\n   263→    );\n   264→    const responseEvents = thread.events.filter(\n   265→      (e) => e.type === \"human_input_received\",\n   266→    );\n   267→    return requestEvents.length > responseEvents.length;\n   268→  }\n   269→\n   270→  private getLastHumanInputRequest(\n   271→    thread: AgentThread,\n   272→  ): HumanInputRequestedEvent | undefined {\n   273→    for (let i = thread.events.length - 1; i >= 0; i--) {\n   274→      if (thread.events[i].type === \"human_input_requested\") {\n   275→        return thread.events[i] as HumanInputRequestedEvent;\n   276→      }\n   277→    }\n   278→    return undefined;\n   279→  }\n   280→\n   281→  private checkInterruptOn(\n   282→    thread: AgentThread,\n   283→    iteration: number,\n   284→  ): string | null {\n   285→    // Check if any tool call in the current iteration matches interruptOn list\n   286→    if (this.interruptOn.length === 0) return null;\n   287→\n   288→    for (let i = thread.events.length - 1; i >= 0; i--) {\n   289→      const event = thread.events[i];\n   290→      if (event.iteration !== iteration) break;\n   291→      if (\n   292→        event.type === \"tool_call\" &&\n   293→        this.interruptOn.includes(event.toolName)\n   294→      ) {\n   295→        return event.toolName;\n   296→      }\n   297→    }\n   298→    return null;\n   299→  }\n   300→\n   301→  async loop(prompt: string): Promise<AgentResult | PendingResult> {\n   302→    const thread = createThread();\n   303→    return this.runLoop(thread, prompt, 1);\n   304→  }\n   305→\n   306→  private async runLoop(\n   307→    thread: AgentThread,\n   308→    prompt: string,\n   309→    startIteration: number,\n   310→  ): Promise<AgentResult | PendingResult> {\n   311→    // Push initial user message (only if this is the first call, not a resume)\n   312→    if (startIteration === 1) {\n   313→      thread.events.push({\n   314→        type: \"message\",\n   315→        role: \"user\",\n   316→        content: prompt,\n   317→        timestamp: Date.now(),\n   318→        iteration: 0,\n   319→      });\n   320→    }\n   321→\n   322→    let totalUsage: TokenUsage = {\n   323→      inputTokens: 0,\n   324→      outputTokens: 0,\n   325→      totalTokens: 0,\n   326→    };\n   327→    let iteration = startIteration;\n   328→    let consecutiveErrors = 0;\n   329→    let lastResponse = \"\";\n   330→\n   331→    // Merge middleware tools with user tools\n   332→    const allTools = {\n   333→      ...this.tools,\n   334→      ...this.composedMiddleware.tools,\n   335→    } as ToolSet;\n   336→\n   337→    while (true) {\n   338→      // Callback\n   339→      this.onIterationStart?.(iteration);\n   340→\n   341→      // Middleware: beforeIteration\n   342→      const middlewareCtx: MiddlewareContext = {\n   343→        thread,\n   344→        iteration,\n   345→        settings: {\n   346→          model: this.model,\n   347→          tools: this.tools,\n   348→          instructions: this.instructions,\n   349→        } as DeepFactorAgentSettings,\n   350→      };\n   351→      await this.composedMiddleware.beforeIteration(middlewareCtx);\n   352→\n   353→      // Context management: check if summarization needed\n   354→      if (this.contextManager.needsSummarization(thread)) {\n   355→        await this.contextManager.summarize(thread, this.model);\n   356→      }\n   357→\n   358→      // Build messages from thread\n   359→      const { system, messages } = this.buildMessages(thread);\n   360→\n   361→      try {\n   362→        const result = await generateText({\n   363→          model: this.model,\n   364→          system,\n   365→          messages,\n   366→          tools: allTools,\n   367→          stopWhen: stepCountIs(20),\n   368→        });\n   369→\n   370→        // Append events\n   371→        this.appendResultEvents(thread, result as any, iteration);\n   372→\n   373→        // Extract and accumulate usage\n   374→        const iterUsage = extractUsage(result.totalUsage);\n   375→        totalUsage = addUsage(totalUsage, iterUsage);\n   376→\n   377→        lastResponse = result.text;\n   378→\n   379→        // Handle todoMiddleware: store todos in thread metadata\n   380→        for (const step of result.steps) {\n   381→          for (const tr of step.toolResults as any[]) {\n   382→            if (tr.toolName === \"write_todos\" && tr.output?.todos) {\n   383→              thread.metadata.todos = tr.output.todos;\n   384→            }\n   385→            if (tr.toolName === \"read_todos\") {\n   386→              // Inject current todos into the result\n   387→              (tr as any).output = {\n   388→                todos: thread.metadata.todos ?? [],\n   389→              };\n   390→            }\n   391→          }\n   392→        }\n   393→\n   394→        // Check for requestHumanInput tool call\n   395→        let humanInputRequested = false;\n   396→        for (const step of result.steps) {\n   397→          for (const tc of step.toolCalls as any[]) {\n   398→            if (tc.toolName === \"requestHumanInput\") {\n   399→              const args = tc.input ?? tc.args ?? {};\n   400→              const hirEvent: HumanInputRequestedEvent = {\n   401→                type: \"human_input_requested\",\n   402→                question: args.question ?? \"\",\n   403→                context: args.context,\n   404→                urgency: args.urgency,\n   405→                format: args.format,\n   406→                choices: args.choices,\n   407→                timestamp: Date.now(),\n   408→                iteration,\n   409→              };\n   410→              thread.events.push(hirEvent);\n   411→              humanInputRequested = true;\n   412→            }\n   413→          }\n   414→        }\n   415→\n   416→        // Reset consecutive errors on success\n   417→        consecutiveErrors = 0;\n   418→\n   419→        // Middleware: afterIteration\n   420→        await this.composedMiddleware.afterIteration(\n   421→          middlewareCtx,\n   422→          result,\n   423→        );\n   424→\n   425→        // Callback\n   426→        this.onIterationEnd?.(iteration, result);\n   427→\n   428→        // Evaluate stop conditions\n   429→        const stopResult = evaluateStopConditions(this.stopConditions, {\n   430→          iteration,\n   431→          usage: totalUsage,\n   432→          model: this.modelId,\n   433→          thread,\n   434→        });\n   435→\n   436→        if (stopResult) {\n   437→          return {\n   438→            response: lastResponse,\n   439→            thread,\n   440→            usage: totalUsage,\n   441→            iterations: iteration,\n   442→            stopReason: \"stop_condition\",\n   443→            stopDetail: stopResult.reason,\n   444→          };\n   445→        }\n   446→\n   447→        // Check interruptOn\n   448→        const interruptedTool = this.checkInterruptOn(thread, iteration);\n   449→        if (interruptedTool) {\n   450→          thread.events.push({\n   451→            type: \"human_input_requested\",\n   452→            question: `Tool \"${interruptedTool}\" requires approval before execution.`,\n   453→            timestamp: Date.now(),\n   454→            iteration,\n   455→          });\n   456→\n   457→          const pendingResult: PendingResult = {\n   458→            response: lastResponse,\n   459→            thread,\n   460→            usage: totalUsage,\n   461→            iterations: iteration,\n   462→            stopReason: \"human_input_needed\",\n   463→            stopDetail: `Interrupted: tool \"${interruptedTool}\" requires approval`,\n   464→            resume: async (humanResponse: string) => {\n   465→              thread.events.push({\n   466→                type: \"human_input_received\",\n   467→                response: humanResponse,\n   468→                timestamp: Date.now(),\n   469→                iteration,\n   470→              });\n   471→              return this.runLoop(thread, prompt, iteration + 1);\n   472→            },\n   473→          };\n   474→          return pendingResult;\n   475→        }\n   476→\n   477→        // Check human input request\n   478→        if (humanInputRequested) {\n   479→          const pendingResult: PendingResult = {\n   480→            response: lastResponse,\n   481→            thread,\n   482→            usage: totalUsage,\n   483→            iterations: iteration,\n   484→            stopReason: \"human_input_needed\",\n   485→            stopDetail: \"Human input requested\",\n   486→            resume: async (humanResponse: string) => {\n   487→              thread.events.push({\n   488→                type: \"human_input_received\",\n   489→                response: humanResponse,\n   490→                timestamp: Date.now(),\n   491→                iteration,\n   492→              });\n   493→              return this.runLoop(thread, prompt, iteration + 1);\n   494→            },\n   495→          };\n   496→          return pendingResult;\n   497→        }\n   498→\n   499→        // Verification\n   500→        if (this.verifyCompletion) {\n   501→          const verifyResult = await this.verifyCompletion({\n   502→            result: lastResponse,\n   503→            iteration,\n   504→            thread,\n   505→            originalPrompt: prompt,\n   506→          });\n   507→\n   508→          if (verifyResult.complete) {\n   509→            const completionEvent: CompletionEvent = {\n   510→              type: \"completion\",\n   511→              result: lastResponse,\n   512→              verified: true,\n   513→              timestamp: Date.now(),\n   514→              iteration,\n   515→            };\n   516→            thread.events.push(completionEvent);\n   517→\n   518→            return {\n   519→              response: lastResponse,\n   520→              thread,\n   521→              usage: totalUsage,\n   522→              iterations: iteration,\n   523→              stopReason: \"completed\",\n   524→            };\n   525→          }\n   526→\n   527→          // Verification failed - inject feedback and continue\n   528→          if (verifyResult.reason) {\n   529→            thread.events.push({\n   530→              type: \"message\",\n   531→              role: \"user\",\n   532→              content: `Verification failed: ${verifyResult.reason}. Please try again.`,\n   533→              timestamp: Date.now(),\n   534→              iteration,\n   535→            });\n   536→          }\n   537→        } else {\n   538→          // No verification function - single iteration mode\n   539→          const completionEvent: CompletionEvent = {\n   540→            type: \"completion\",\n   541→            result: lastResponse,\n   542→            verified: false,\n   543→            timestamp: Date.now(),\n   544→            iteration,\n   545→          };\n   546→          thread.events.push(completionEvent);\n   547→\n   548→          return {\n   549→            response: lastResponse,\n   550→            thread,\n   551→            usage: totalUsage,\n   552→            iterations: iteration,\n   553→            stopReason: \"completed\",\n   554→          };\n   555→        }\n   556→      } catch (error) {\n   557→        consecutiveErrors++;\n   558→        const isRecoverable = consecutiveErrors < 3;\n   559→\n   560→        const errorEvent: ErrorEvent = {\n   561→          type: \"error\",\n   562→          error: compactError(error),\n   563→          recoverable: isRecoverable,\n   564→          timestamp: Date.now(),\n   565→          iteration,\n   566→        };\n   567→        thread.events.push(errorEvent);\n   568→\n   569→        // Middleware: afterIteration (even on error)\n   570→        await this.composedMiddleware.afterIteration(\n   571→          middlewareCtx,\n   572→          error,\n   573→        );\n   574→\n   575→        // Callback\n   576→        this.onIterationEnd?.(iteration, error);\n   577→\n   578→        if (!isRecoverable) {\n   579→          return {\n   580→            response: lastResponse,\n   581→            thread,\n   582→            usage: totalUsage,\n   583→            iterations: iteration,\n   584→            stopReason: \"max_errors\",\n   585→            stopDetail: `${consecutiveErrors} consecutive errors`,\n   586→          };\n   587→        }\n   588→\n   589→        // Continue to retry\n   590→      }\n   591→\n   592→      iteration++;\n   593→    }\n   594→  }\n   595→\n   596→  // eslint-disable-next-line @typescript-eslint/explicit-module-boundary-types\n   597→  stream(prompt: string): ReturnType<typeof streamText> {\n   598→    const thread = createThread();\n   599→\n   600→    // Push initial user message\n   601→    thread.events.push({\n   602→      type: \"message\",\n   603→      role: \"user\",\n   604→      content: prompt,\n   605→      timestamp: Date.now(),\n   606→      iteration: 0,\n   607→    });\n   608→\n   609→    const allTools = {\n   610→      ...this.tools,\n   611→      ...this.composedMiddleware.tools,\n   612→    } as ToolSet;\n   613→\n   614→    const { system, messages } = this.buildMessages(thread);\n   615→\n   616→    return streamText({\n   617→      model: this.model,\n   618→      system,\n   619→      messages,\n   620→      tools: allTools,\n   621→      stopWhen: stepCountIs(20),\n   622→    });\n   623→  }\n   624→}\n   625→"}]},"parent_tool_use_id":"toolu_01NNaDfKGwAaSCJUfopDMNs5","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"fc9640fb-458a-4d01-a532-738274723e1d"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01GNwwZkjGmN5h5eH2CHehjN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RdiPt4sCzRoqkeyECTFnFA","name":"Task","input":{"description":"Study src/stop-conditions.ts","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/stop-conditions.ts completely and return all its contents.","subagent_type":"Explore","model":"sonnet"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":334,"cache_read_input_tokens":25164,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":334},"output_tokens":5,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"9823ef5d-c680-4a2e-8b50-537dd5252b67"}
{"type":"user","message":{"role":"user","content":[{"type":"text","text":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/stop-conditions.ts completely and return all its contents."}]},"parent_tool_use_id":"toolu_01RdiPt4sCzRoqkeyECTFnFA","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"0d9984b3-10ec-4175-8df6-2d7af06cfdaa"}
{"type":"assistant","message":{"model":"claude-sonnet-4-6","id":"msg_01Tzs63qyjEzRTK4pHBJ6Q9x","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NyXmcgwvKd8Hkurm3bbiam","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/create-agent.ts"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":536,"cache_read_input_tokens":10563,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":536},"output_tokens":19,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01QHAcRCQipPe8VqpF7Kenec","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"d3f89f79-e589-4528-b564-e2fff69381bf"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NyXmcgwvKd8Hkurm3bbiam","type":"tool_result","content":"     1→import type { ToolSet } from \"ai\";\n     2→import { DeepFactorAgent } from \"./agent.js\";\n     3→import { maxIterations } from \"./stop-conditions.js\";\n     4→import { todoMiddleware, errorRecoveryMiddleware } from \"./middleware.js\";\n     5→import type { DeepFactorAgentSettings } from \"./types.js\";\n     6→\n     7→export function createDeepFactorAgent<\n     8→  TTools extends ToolSet = ToolSet,\n     9→>(settings: DeepFactorAgentSettings<TTools>): DeepFactorAgent<TTools> {\n    10→  const resolvedSettings: DeepFactorAgentSettings<TTools> = {\n    11→    ...settings,\n    12→    tools: settings.tools ?? ({} as TTools),\n    13→    instructions: settings.instructions ?? \"\",\n    14→    stopWhen: settings.stopWhen ?? [maxIterations(10)],\n    15→    verifyCompletion: settings.verifyCompletion,\n    16→    middleware: settings.middleware ?? [\n    17→      todoMiddleware(),\n    18→      errorRecoveryMiddleware(),\n    19→    ],\n    20→    interruptOn: settings.interruptOn ?? [],\n    21→    contextManagement: {\n    22→      maxContextTokens: 150000,\n    23→      keepRecentIterations: 3,\n    24→      ...settings.contextManagement,\n    25→    },\n    26→  };\n    27→\n    28→  return new DeepFactorAgent(resolvedSettings);\n    29→}\n    30→"}]},"parent_tool_use_id":"toolu_01QHAcRCQipPe8VqpF7Kenec","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"ec3a4e59-ebda-43af-925b-c4f01468a0d2"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01GNwwZkjGmN5h5eH2CHehjN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011gS8qvRtDZ9acZv5a9H5Tq","name":"Task","input":{"description":"Study src/middleware.ts","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/middleware.ts completely and return all its contents.","subagent_type":"Explore","model":"sonnet"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":334,"cache_read_input_tokens":25164,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":334},"output_tokens":5,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"3567c003-8119-49a4-be97-4ed5f5446db3"}
{"type":"user","message":{"role":"user","content":[{"type":"text","text":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/middleware.ts completely and return all its contents."}]},"parent_tool_use_id":"toolu_011gS8qvRtDZ9acZv5a9H5Tq","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"089e3ccd-2e5a-47d7-9ebd-df7ea617db65"}
{"type":"assistant","message":{"model":"claude-sonnet-4-6","id":"msg_014uecYcw8JbPLk8myX9Yt4v","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YZNxvy8nhGAcU7zw37Ye1m","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/stop-conditions.ts"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":536,"cache_read_input_tokens":10563,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":536},"output_tokens":19,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01RdiPt4sCzRoqkeyECTFnFA","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"bf09c2bf-129f-4f5a-92c9-17a274646ddb"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YZNxvy8nhGAcU7zw37Ye1m","type":"tool_result","content":"     1→import type {\n     2→  TokenUsage,\n     3→  StopCondition,\n     4→  StopConditionContext,\n     5→  StopConditionResult,\n     6→} from \"./types.js\";\n     7→\n     8→// --- Model Pricing (cost per token) ---\n     9→\n    10→export const MODEL_PRICING: Record<\n    11→  string,\n    12→  {\n    13→    input: number;\n    14→    output: number;\n    15→    cacheRead?: number;\n    16→    cacheWrite?: number;\n    17→  }\n    18→> = {\n    19→  // Anthropic\n    20→  \"claude-sonnet-4-5\": {\n    21→    input: 0.000003,\n    22→    output: 0.000015,\n    23→    cacheRead: 0.0000003,\n    24→    cacheWrite: 0.00000375,\n    25→  },\n    26→  \"claude-opus-4-5\": {\n    27→    input: 0.000015,\n    28→    output: 0.000075,\n    29→    cacheRead: 0.0000015,\n    30→    cacheWrite: 0.00001875,\n    31→  },\n    32→  \"claude-haiku-4-5\": {\n    33→    input: 0.0000008,\n    34→    output: 0.000004,\n    35→    cacheRead: 0.00000008,\n    36→    cacheWrite: 0.000001,\n    37→  },\n    38→  // OpenAI\n    39→  \"gpt-4o\": {\n    40→    input: 0.0000025,\n    41→    output: 0.00001,\n    42→  },\n    43→  \"gpt-4o-mini\": {\n    44→    input: 0.00000015,\n    45→    output: 0.0000006,\n    46→  },\n    47→  // Google\n    48→  \"gemini-2.5-pro\": {\n    49→    input: 0.00000125,\n    50→    output: 0.00001,\n    51→  },\n    52→  \"gemini-2.5-flash\": {\n    53→    input: 0.000000075,\n    54→    output: 0.0000003,\n    55→  },\n    56→};\n    57→\n    58→// --- Cost Calculation ---\n    59→\n    60→export function calculateCost(usage: TokenUsage, model: string): number {\n    61→  const pricing = MODEL_PRICING[model];\n    62→  if (!pricing) return 0;\n    63→\n    64→  let cost =\n    65→    usage.inputTokens * pricing.input + usage.outputTokens * pricing.output;\n    66→\n    67→  if (usage.cacheReadTokens !== undefined && pricing.cacheRead !== undefined) {\n    68→    cost += usage.cacheReadTokens * pricing.cacheRead;\n    69→  }\n    70→  if (\n    71→    usage.cacheWriteTokens !== undefined &&\n    72→    pricing.cacheWrite !== undefined\n    73→  ) {\n    74→    cost += usage.cacheWriteTokens * pricing.cacheWrite;\n    75→  }\n    76→\n    77→  return cost;\n    78→}\n    79→\n    80→// --- Stop Condition Factories ---\n    81→\n    82→export function maxIterations(n: number): StopCondition {\n    83→  return (ctx: StopConditionContext): StopConditionResult => {\n    84→    if (ctx.iteration >= n) {\n    85→      return { stop: true, reason: `Max iterations (${n}) reached` };\n    86→    }\n    87→    return { stop: false };\n    88→  };\n    89→}\n    90→\n    91→export function maxTokens(n: number): StopCondition {\n    92→  return (ctx: StopConditionContext): StopConditionResult => {\n    93→    if (ctx.usage.totalTokens >= n) {\n    94→      return {\n    95→        stop: true,\n    96→        reason: `Max tokens (${n}) reached: ${ctx.usage.totalTokens} total tokens used`,\n    97→      };\n    98→    }\n    99→    return { stop: false };\n   100→  };\n   101→}\n   102→\n   103→export function maxInputTokens(n: number): StopCondition {\n   104→  return (ctx: StopConditionContext): StopConditionResult => {\n   105→    if (ctx.usage.inputTokens >= n) {\n   106→      return {\n   107→        stop: true,\n   108→        reason: `Max input tokens (${n}) reached: ${ctx.usage.inputTokens} input tokens used`,\n   109→      };\n   110→    }\n   111→    return { stop: false };\n   112→  };\n   113→}\n   114→\n   115→export function maxOutputTokens(n: number): StopCondition {\n   116→  return (ctx: StopConditionContext): StopConditionResult => {\n   117→    if (ctx.usage.outputTokens >= n) {\n   118→      return {\n   119→        stop: true,\n   120→        reason: `Max output tokens (${n}) reached: ${ctx.usage.outputTokens} output tokens used`,\n   121→      };\n   122→    }\n   123→    return { stop: false };\n   124→  };\n   125→}\n   126→\n   127→export function maxCost(dollars: number, model?: string): StopCondition {\n   128→  return (ctx: StopConditionContext): StopConditionResult => {\n   129→    const modelToUse = model ?? ctx.model;\n   130→    const cost = calculateCost(ctx.usage, modelToUse);\n   131→    if (cost >= dollars) {\n   132→      return {\n   133→        stop: true,\n   134→        reason: `Max cost ($${dollars.toFixed(2)}) reached: $${cost.toFixed(4)} spent`,\n   135→      };\n   136→    }\n   137→    return { stop: false };\n   138→  };\n   139→}\n   140→\n   141→// --- Evaluator ---\n   142→\n   143→export function evaluateStopConditions(\n   144→  conditions: StopCondition[],\n   145→  ctx: StopConditionContext,\n   146→): StopConditionResult | null {\n   147→  for (const condition of conditions) {\n   148→    const result = condition(ctx);\n   149→    if (result.stop) {\n   150→      return result;\n   151→    }\n   152→  }\n   153→  return null;\n   154→}\n   155→"}]},"parent_tool_use_id":"toolu_01RdiPt4sCzRoqkeyECTFnFA","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"0af540be-2662-4413-80fe-69b01d9c3c9d"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01GNwwZkjGmN5h5eH2CHehjN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0179bA5dJmNgHuytE2MjrkaY","name":"Task","input":{"description":"Study src/context-manager.ts","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/context-manager.ts completely and return all its contents.","subagent_type":"Explore","model":"sonnet"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":334,"cache_read_input_tokens":25164,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":334},"output_tokens":5,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"885adca0-56a9-46d0-9954-3775ebf3abe7"}
{"type":"user","message":{"role":"user","content":[{"type":"text","text":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/context-manager.ts completely and return all its contents."}]},"parent_tool_use_id":"toolu_0179bA5dJmNgHuytE2MjrkaY","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"823fcd9c-6bc9-4352-a831-20f30937a933"}
{"type":"assistant","message":{"model":"claude-sonnet-4-6","id":"msg_01VkqtMfS2pnQgUXATDvwJxW","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FTnvKSiBRSVzjPZNJ7XT3j","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/middleware.ts"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":534,"cache_read_input_tokens":10563,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":534},"output_tokens":19,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_011gS8qvRtDZ9acZv5a9H5Tq","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"f876d95a-1ae4-4ddf-bee3-21d9c1cd2ac7"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FTnvKSiBRSVzjPZNJ7XT3j","type":"tool_result","content":"     1→import type { ToolSet } from \"ai\";\n     2→import { z } from \"zod\";\n     3→import type {\n     4→  AgentMiddleware,\n     5→  MiddlewareContext,\n     6→  ErrorEvent,\n     7→} from \"./types.js\";\n     8→\n     9→export interface ComposedMiddleware {\n    10→  tools: ToolSet;\n    11→  beforeIteration: (ctx: MiddlewareContext) => Promise<void>;\n    12→  afterIteration: (ctx: MiddlewareContext, result: unknown) => Promise<void>;\n    13→}\n    14→\n    15→export function composeMiddleware(\n    16→  middlewares: AgentMiddleware[],\n    17→): ComposedMiddleware {\n    18→  const tools: ToolSet = {};\n    19→\n    20→  for (const mw of middlewares) {\n    21→    if (mw.tools) {\n    22→      for (const [name, tool] of Object.entries(mw.tools)) {\n    23→        if (name in tools) {\n    24→          console.warn(\n    25→            `Middleware tool conflict: \"${name}\" from \"${mw.name}\" overrides a previous definition`,\n    26→          );\n    27→        }\n    28→        (tools as Record<string, unknown>)[name] = tool;\n    29→      }\n    30→    }\n    31→  }\n    32→\n    33→  const beforeIteration = async (ctx: MiddlewareContext): Promise<void> => {\n    34→    for (const mw of middlewares) {\n    35→      if (mw.beforeIteration) {\n    36→        await mw.beforeIteration(ctx);\n    37→      }\n    38→    }\n    39→  };\n    40→\n    41→  const afterIteration = async (\n    42→    ctx: MiddlewareContext,\n    43→    result: unknown,\n    44→  ): Promise<void> => {\n    45→    for (const mw of middlewares) {\n    46→      if (mw.afterIteration) {\n    47→        await mw.afterIteration(ctx, result);\n    48→      }\n    49→    }\n    50→  };\n    51→\n    52→  return { tools, beforeIteration, afterIteration };\n    53→}\n    54→\n    55→export function todoMiddleware(): AgentMiddleware {\n    56→  const todoSchema = z.object({\n    57→    todos: z.array(\n    58→      z.object({\n    59→        id: z.string(),\n    60→        text: z.string(),\n    61→        status: z.enum([\"pending\", \"in_progress\", \"done\"]),\n    62→      }),\n    63→    ),\n    64→  });\n    65→\n    66→  return {\n    67→    name: \"todo\",\n    68→    tools: {\n    69→      write_todos: {\n    70→        description: \"Create or update the todo list for planning and tracking progress\",\n    71→        parameters: todoSchema,\n    72→        execute: async (\n    73→          args: z.infer<typeof todoSchema>,\n    74→          { messages }: { messages?: unknown[] } = {},\n    75→        ) => {\n    76→          // Todos will be stored in thread.metadata.todos by the agent loop\n    77→          return { success: true, todos: args.todos };\n    78→        },\n    79→      },\n    80→      read_todos: {\n    81→        description: \"Read the current todo list\",\n    82→        parameters: z.object({}),\n    83→        execute: async () => {\n    84→          // The agent loop handles reading from thread.metadata.todos\n    85→          return { todos: [] };\n    86→        },\n    87→      },\n    88→    } as unknown as ToolSet,\n    89→  };\n    90→}\n    91→\n    92→export function errorRecoveryMiddleware(): AgentMiddleware {\n    93→  return {\n    94→    name: \"errorRecovery\",\n    95→    afterIteration: async (\n    96→      ctx: MiddlewareContext,\n    97→      _result: unknown,\n    98→    ): Promise<void> => {\n    99→      const { thread } = ctx;\n   100→      if (thread.events.length === 0) return;\n   101→\n   102→      const lastEvent = thread.events[thread.events.length - 1];\n   103→      if (lastEvent.type === \"error\") {\n   104→        const errorEvent = lastEvent as ErrorEvent;\n   105→        let errorMsg = errorEvent.error;\n   106→        if (errorMsg.length > 500) {\n   107→          errorMsg = errorMsg.substring(0, 500) + \"... [truncated]\";\n   108→        }\n   109→\n   110→        thread.events.push({\n   111→          type: \"message\",\n   112→          role: \"system\",\n   113→          content: `Error occurred: ${errorMsg}\\nConsider an alternative approach if the same error occurs again.`,\n   114→          timestamp: Date.now(),\n   115→          iteration: ctx.iteration,\n   116→        });\n   117→      }\n   118→    },\n   119→  };\n   120→}\n   121→"}]},"parent_tool_use_id":"toolu_011gS8qvRtDZ9acZv5a9H5Tq","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"a38e57ce-f126-4cd3-a307-c7d9318ff2ae"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01GNwwZkjGmN5h5eH2CHehjN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Fyi7ihU6HMVxVWk8StkCMJ","name":"Task","input":{"description":"Study src/human-in-the-loop.ts","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/human-in-the-loop.ts completely and return all its contents.","subagent_type":"Explore","model":"sonnet"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":334,"cache_read_input_tokens":25164,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":334},"output_tokens":5,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"fead5c1c-3d96-4dd4-a9a7-83b78d8a7d73"}
{"type":"user","message":{"role":"user","content":[{"type":"text","text":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/human-in-the-loop.ts completely and return all its contents."}]},"parent_tool_use_id":"toolu_01Fyi7ihU6HMVxVWk8StkCMJ","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"66108b9d-e07e-4f2d-9117-1520a722e234"}
{"type":"assistant","message":{"model":"claude-sonnet-4-6","id":"msg_019UyL5MNsZVZVigm2H6dXxQ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011RfUeKJSdftNX6u4RDUi6m","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/context-manager.ts"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":536,"cache_read_input_tokens":10563,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":536},"output_tokens":19,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_0179bA5dJmNgHuytE2MjrkaY","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"a4cdb9c5-aa0d-4f5b-91ed-f37473bf1ebb"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011RfUeKJSdftNX6u4RDUi6m","type":"tool_result","content":"     1→import type { LanguageModel } from \"ai\";\n     2→import { generateText } from \"ai\";\n     3→import type {\n     4→  AgentThread,\n     5→  ContextManagementConfig,\n     6→  SummaryEvent,\n     7→} from \"./types.js\";\n     8→\n     9→export function estimateTokens(text: string): number {\n    10→  if (text.length === 0) return 0;\n    11→  return Math.ceil(text.length / 3.5);\n    12→}\n    13→\n    14→export class ContextManager {\n    15→  private maxContextTokens: number;\n    16→  private keepRecentIterations: number;\n    17→\n    18→  constructor(config: ContextManagementConfig = {}) {\n    19→    this.maxContextTokens = config.maxContextTokens ?? 150000;\n    20→    this.keepRecentIterations = config.keepRecentIterations ?? 3;\n    21→  }\n    22→\n    23→  estimateThreadTokens(thread: AgentThread): number {\n    24→    let total = 0;\n    25→    for (const event of thread.events) {\n    26→      const serialized = JSON.stringify(event);\n    27→      total += estimateTokens(serialized);\n    28→    }\n    29→    return total;\n    30→  }\n    31→\n    32→  needsSummarization(thread: AgentThread): boolean {\n    33→    return this.estimateThreadTokens(thread) > this.maxContextTokens;\n    34→  }\n    35→\n    36→  async summarize(\n    37→    thread: AgentThread,\n    38→    model: LanguageModel,\n    39→  ): Promise<AgentThread> {\n    40→    // Group events by iteration\n    41→    const iterationMap = new Map<number, typeof thread.events>();\n    42→    for (const event of thread.events) {\n    43→      const iter = event.iteration;\n    44→      if (!iterationMap.has(iter)) {\n    45→        iterationMap.set(iter, []);\n    46→      }\n    47→      iterationMap.get(iter)!.push(event);\n    48→    }\n    49→\n    50→    const iterations = Array.from(iterationMap.keys()).sort((a, b) => a - b);\n    51→    if (iterations.length === 0) return thread;\n    52→\n    53→    const maxIteration = iterations[iterations.length - 1];\n    54→    const cutoff = maxIteration - this.keepRecentIterations;\n    55→\n    56→    // Identify old iterations to summarize (skip already-summarized events)\n    57→    const oldIterations = iterations.filter((i) => i <= cutoff);\n    58→    if (oldIterations.length === 0) return thread;\n    59→\n    60→    const summaryEvents: SummaryEvent[] = [];\n    61→\n    62→    for (const iter of oldIterations) {\n    63→      const events = iterationMap.get(iter)!;\n    64→      // Skip if already a single summary event\n    65→      if (events.length === 1 && events[0].type === \"summary\") continue;\n    66→\n    67→      const eventsText = events\n    68→        .map((e) => JSON.stringify(e))\n    69→        .join(\"\\n\");\n    70→\n    71→      try {\n    72→        const result = await generateText({\n    73→          model,\n    74→          messages: [\n    75→            {\n    76→              role: \"user\",\n    77→              content: `Summarize the following agent iteration events in 2-3 sentences. Focus on what tools were called, what was accomplished, and any errors:\\n\\n${eventsText}`,\n    78→            },\n    79→          ],\n    80→        });\n    81→\n    82→        summaryEvents.push({\n    83→          type: \"summary\",\n    84→          summarizedIterations: [iter],\n    85→          summary: result.text,\n    86→          timestamp: Date.now(),\n    87→          iteration: iter,\n    88→        });\n    89→      } catch {\n    90→        // If summarization fails, keep a simple summary\n    91→        summaryEvents.push({\n    92→          type: \"summary\",\n    93→          summarizedIterations: [iter],\n    94→          summary: `Iteration ${iter}: ${events.length} events (summarization failed)`,\n    95→          timestamp: Date.now(),\n    96→          iteration: iter,\n    97→        });\n    98→      }\n    99→    }\n   100→\n   101→    // Remove old iteration events, keep recent ones and summaries\n   102→    const newEvents = thread.events.filter(\n   103→      (e) => e.iteration > cutoff || e.type === \"summary\",\n   104→    );\n   105→\n   106→    // Add new summaries\n   107→    thread.events = [...summaryEvents, ...newEvents];\n   108→    thread.updatedAt = Date.now();\n   109→\n   110→    return thread;\n   111→  }\n   112→\n   113→  buildContextInjection(thread: AgentThread): string {\n   114→    const summaries = thread.events.filter(\n   115→      (e): e is SummaryEvent => e.type === \"summary\",\n   116→    );\n   117→\n   118→    if (summaries.length === 0) return \"\";\n   119→\n   120→    let injection = \"## Previous Iteration Summaries\\n\\n\";\n   121→    for (const s of summaries) {\n   122→      const iters = s.summarizedIterations.join(\", \");\n   123→      injection += `### Iteration(s) ${iters}\\n${s.summary}\\n\\n`;\n   124→    }\n   125→\n   126→    return injection;\n   127→  }\n   128→}\n   129→"}]},"parent_tool_use_id":"toolu_0179bA5dJmNgHuytE2MjrkaY","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"4ce71bff-7db6-4229-902a-12e06c6a41dd"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01GNwwZkjGmN5h5eH2CHehjN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01ReqGnN35y2QyYNvyYcjPwx","name":"Task","input":{"description":"Study package.json","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/package.json completely and return all its contents.","subagent_type":"Explore","model":"sonnet"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":334,"cache_read_input_tokens":25164,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":334},"output_tokens":5,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"c0c9ca8a-110b-4ed0-8541-4518c54a3566"}
{"type":"user","message":{"role":"user","content":[{"type":"text","text":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/package.json completely and return all its contents."}]},"parent_tool_use_id":"toolu_01ReqGnN35y2QyYNvyYcjPwx","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"25e55a96-9408-46fb-8110-4a092157e53f"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01GNwwZkjGmN5h5eH2CHehjN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MrYfXu5gCmYgFtqPDY9fpd","name":"Glob","input":{"pattern":"specs/*.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":334,"cache_read_input_tokens":25164,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":334},"output_tokens":5,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"d95afafd-d222-47d6-9803-0e97e26316ea"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MrYfXu5gCmYgFtqPDY9fpd","type":"tool_result","content":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/specs/01-setup-readme.md"}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"0157de80-5930-404e-9a98-ab63d0d7febd","tool_use_result":{"filenames":["/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/specs/01-setup-readme.md"],"durationMs":132,"numFiles":1,"truncated":false}}
{"type":"assistant","message":{"model":"claude-sonnet-4-6","id":"msg_0127NcEs5z1Pb3jxohY2zwsf","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Lx8b3nnoaTo4tBCEeGYLgt","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/human-in-the-loop.ts"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":540,"cache_read_input_tokens":10563,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":540},"output_tokens":19,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01Fyi7ihU6HMVxVWk8StkCMJ","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"2e0d14fc-ea20-46d1-9c25-583d95133901"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Lx8b3nnoaTo4tBCEeGYLgt","type":"tool_result","content":"     1→import { z } from \"zod\";\n     2→import type { ToolSet } from \"ai\";\n     3→\n     4→export const requestHumanInputSchema = z.object({\n     5→  question: z.string().describe(\"The question to ask the human\"),\n     6→  context: z.string().optional().describe(\"Background context for the question\"),\n     7→  urgency: z\n     8→    .enum([\"low\", \"medium\", \"high\"])\n     9→    .optional()\n    10→    .default(\"medium\")\n    11→    .describe(\"How urgent is this request\"),\n    12→  format: z\n    13→    .enum([\"free_text\", \"yes_no\", \"multiple_choice\"])\n    14→    .optional()\n    15→    .default(\"free_text\")\n    16→    .describe(\"Expected response format\"),\n    17→  choices: z\n    18→    .array(z.string())\n    19→    .optional()\n    20→    .describe(\"Options for multiple_choice format\"),\n    21→});\n    22→\n    23→export const requestHumanInput = {\n    24→  description:\n    25→    \"Request input or approval from a human. Use when you need clarification, confirmation, or a decision.\",\n    26→  parameters: requestHumanInputSchema,\n    27→  execute: async (args: z.infer<typeof requestHumanInputSchema>) => {\n    28→    // The actual pause mechanism is handled by the agent loop.\n    29→    // This tool's execute function returns the args so the loop can detect it.\n    30→    return {\n    31→      requested: true,\n    32→      question: args.question,\n    33→      context: args.context,\n    34→      urgency: args.urgency,\n    35→      format: args.format,\n    36→      choices: args.choices,\n    37→    };\n    38→  },\n    39→} as unknown as ToolSet[string];\n    40→"}]},"parent_tool_use_id":"toolu_01Fyi7ihU6HMVxVWk8StkCMJ","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"d89d8f6b-6e36-47bc-bf77-aa5f5df7a100"}
{"type":"assistant","message":{"model":"claude-sonnet-4-6","id":"msg_01TAJkf4u331WeaY9iqDcXgq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QSnA1itcfQYKjPPrwzETDz","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/package.json"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":532,"cache_read_input_tokens":10563,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":532},"output_tokens":19,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01ReqGnN35y2QyYNvyYcjPwx","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"b4b4344d-2162-473a-af25-92e9ff9b462c"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QSnA1itcfQYKjPPrwzETDz","type":"tool_result","content":"     1→{\n     2→  \"name\": \"deep-factor-agent\",\n     3→  \"version\": \"0.0.0\",\n     4→  \"type\": \"module\",\n     5→  \"main\": \"./dist/index.js\",\n     6→  \"types\": \"./dist/index.d.ts\",\n     7→  \"exports\": {\n     8→    \".\": {\n     9→      \"import\": \"./dist/index.js\",\n    10→      \"types\": \"./dist/index.d.ts\"\n    11→    }\n    12→  },\n    13→  \"scripts\": {\n    14→    \"build\": \"tsc\",\n    15→    \"dev\": \"tsc --watch\",\n    16→    \"test\": \"vitest run\",\n    17→    \"test:watch\": \"vitest\",\n    18→    \"type-check\": \"tsc --noEmit\"\n    19→  },\n    20→  \"peerDependencies\": {\n    21→    \"zod\": \">=4.0.0\"\n    22→  },\n    23→  \"dependencies\": {\n    24→    \"@ai-sdk/provider-utils\": \"^4.0.15\",\n    25→    \"ai\": \"^6.0.97\"\n    26→  },\n    27→  \"devDependencies\": {\n    28→    \"@types/node\": \"^25.3.0\",\n    29→    \"typescript\": \"^5.9.3\",\n    30→    \"vitest\": \"^4.0.18\"\n    31→  }\n    32→}\n    33→"}]},"parent_tool_use_id":"toolu_01ReqGnN35y2QyYNvyYcjPwx","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"257b1221-e0cd-4077-ba28-222501142993"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01N9xy9WFsMJnF7NSC2UqbTz","type":"tool_result","content":[{"type":"text","text":"Here are the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/index.ts`:\n\n```typescript\n// Types\nexport type {\n  AgentEventType,\n  BaseEvent,\n  ToolCallEvent,\n  ToolResultEvent,\n  ErrorEvent,\n  HumanInputRequestedEvent,\n  HumanInputReceivedEvent,\n  MessageEvent,\n  CompletionEvent,\n  SummaryEvent,\n  AgentEvent,\n  AgentThread,\n  TokenUsage,\n  StopConditionContext,\n  StopConditionResult,\n  StopCondition,\n  VerifyContext,\n  VerifyResult,\n  VerifyCompletion,\n  ContextManagementConfig,\n  MiddlewareContext,\n  AgentMiddleware,\n  DeepFactorAgentSettings,\n  AgentResult,\n  PendingResult,\n} from \"./types.js\";\n\n// Stop conditions\nexport {\n  maxIterations,\n  maxTokens,\n  maxInputTokens,\n  maxOutputTokens,\n  maxCost,\n  calculateCost,\n  MODEL_PRICING,\n  evaluateStopConditions,\n} from \"./stop-conditions.js\";\n\n// Middleware\nexport {\n  composeMiddleware,\n  todoMiddleware,\n  errorRecoveryMiddleware,\n} from \"./middleware.js\";\n\n// Context management\nexport { ContextManager, estimateTokens } from \"./context-manager.js\";\n\n// Agent\nexport { DeepFactorAgent, addUsage } from \"./agent.js\";\n\n// Factory\nexport { createDeepFactorAgent } from \"./create-agent.js\";\n\n// Human-in-the-loop\nexport { requestHumanInput } from \"./human-in-the-loop.js\";\n```\n\nThe file is 59 lines long and serves as the barrel export for the library, organized into 6 sections:\n\n1. **Types** - All TypeScript type exports from `./types.js` (28 types total including events, agent settings, stop conditions, middleware, and results)\n2. **Stop conditions** - Utilities for controlling agent execution limits (iterations, tokens, cost) from `./stop-conditions.js`\n3. **Middleware** - Middleware composition and built-in middleware (`todoMiddleware`, `errorRecoveryMiddleware`) from `./middleware.js`\n4. **Context management** - `ContextManager` class and `estimateTokens` helper from `./context-manager.js`\n5. **Agent** - The core `DeepFactorAgent` class and `addUsage` helper from `./agent.js`\n6. **Factory** - `createDeepFactorAgent` factory function from `./create-agent.js`\n7. **Human-in-the-loop** - `requestHumanInput` from `./human-in-the-loop.js`"},{"type":"text","text":"agentId: af09b971e97c5530e (for resuming to continue this agent's work if needed)\n<usage>total_tokens: 12525\ntool_uses: 1\nduration_ms: 10481</usage>"}]}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"c70b018f-d090-4423-81cd-24fa07a3dbe9","tool_use_result":{"status":"completed","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/index.ts completely and return all its contents. This is the barrel export file for the library.","agentId":"af09b971e97c5530e","content":[{"type":"text","text":"Here are the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/index.ts`:\n\n```typescript\n// Types\nexport type {\n  AgentEventType,\n  BaseEvent,\n  ToolCallEvent,\n  ToolResultEvent,\n  ErrorEvent,\n  HumanInputRequestedEvent,\n  HumanInputReceivedEvent,\n  MessageEvent,\n  CompletionEvent,\n  SummaryEvent,\n  AgentEvent,\n  AgentThread,\n  TokenUsage,\n  StopConditionContext,\n  StopConditionResult,\n  StopCondition,\n  VerifyContext,\n  VerifyResult,\n  VerifyCompletion,\n  ContextManagementConfig,\n  MiddlewareContext,\n  AgentMiddleware,\n  DeepFactorAgentSettings,\n  AgentResult,\n  PendingResult,\n} from \"./types.js\";\n\n// Stop conditions\nexport {\n  maxIterations,\n  maxTokens,\n  maxInputTokens,\n  maxOutputTokens,\n  maxCost,\n  calculateCost,\n  MODEL_PRICING,\n  evaluateStopConditions,\n} from \"./stop-conditions.js\";\n\n// Middleware\nexport {\n  composeMiddleware,\n  todoMiddleware,\n  errorRecoveryMiddleware,\n} from \"./middleware.js\";\n\n// Context management\nexport { ContextManager, estimateTokens } from \"./context-manager.js\";\n\n// Agent\nexport { DeepFactorAgent, addUsage } from \"./agent.js\";\n\n// Factory\nexport { createDeepFactorAgent } from \"./create-agent.js\";\n\n// Human-in-the-loop\nexport { requestHumanInput } from \"./human-in-the-loop.js\";\n```\n\nThe file is 59 lines long and serves as the barrel export for the library, organized into 6 sections:\n\n1. **Types** - All TypeScript type exports from `./types.js` (28 types total including events, agent settings, stop conditions, middleware, and results)\n2. **Stop conditions** - Utilities for controlling agent execution limits (iterations, tokens, cost) from `./stop-conditions.js`\n3. **Middleware** - Middleware composition and built-in middleware (`todoMiddleware`, `errorRecoveryMiddleware`) from `./middleware.js`\n4. **Context management** - `ContextManager` class and `estimateTokens` helper from `./context-manager.js`\n5. **Agent** - The core `DeepFactorAgent` class and `addUsage` helper from `./agent.js`\n6. **Factory** - `createDeepFactorAgent` factory function from `./create-agent.js`\n7. **Human-in-the-loop** - `requestHumanInput` from `./human-in-the-loop.js`"}],"totalDurationMs":10481,"totalTokens":12525,"totalToolUseCount":1,"usage":{"input_tokens":1,"cache_creation_input_tokens":722,"cache_read_input_tokens":11107,"output_tokens":695,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":722,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}}}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QHAcRCQipPe8VqpF7Kenec","type":"tool_result","content":[{"type":"text","text":"Here are the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/create-agent.ts`:\n\n```typescript\nimport type { ToolSet } from \"ai\";\nimport { DeepFactorAgent } from \"./agent.js\";\nimport { maxIterations } from \"./stop-conditions.js\";\nimport { todoMiddleware, errorRecoveryMiddleware } from \"./middleware.js\";\nimport type { DeepFactorAgentSettings } from \"./types.js\";\n\nexport function createDeepFactorAgent<\n  TTools extends ToolSet = ToolSet,\n>(settings: DeepFactorAgentSettings<TTools>): DeepFactorAgent<TTools> {\n  const resolvedSettings: DeepFactorAgentSettings<TTools> = {\n    ...settings,\n    tools: settings.tools ?? ({} as TTools),\n    instructions: settings.instructions ?? \"\",\n    stopWhen: settings.stopWhen ?? [maxIterations(10)],\n    verifyCompletion: settings.verifyCompletion,\n    middleware: settings.middleware ?? [\n      todoMiddleware(),\n      errorRecoveryMiddleware(),\n    ],\n    interruptOn: settings.interruptOn ?? [],\n    contextManagement: {\n      maxContextTokens: 150000,\n      keepRecentIterations: 3,\n      ...settings.contextManagement,\n    },\n  };\n\n  return new DeepFactorAgent(resolvedSettings);\n}\n```\n\nThe file is 29 lines long and exports a single factory function `createDeepFactorAgent`. Here is a summary of what it does:\n\n- It is a generic factory function typed on `TTools extends ToolSet`.\n- It accepts a `DeepFactorAgentSettings<TTools>` object.\n- It applies default values for several settings:\n  - `tools`: defaults to an empty object `{}`\n  - `instructions`: defaults to an empty string `\"\"`\n  - `stopWhen`: defaults to `[maxIterations(10)]`\n  - `middleware`: defaults to `[todoMiddleware(), errorRecoveryMiddleware()]`\n  - `interruptOn`: defaults to an empty array `[]`\n  - `contextManagement`: defaults to `{ maxContextTokens: 150000, keepRecentIterations: 3 }`, with any provided values merged on top\n- It constructs and returns a new `DeepFactorAgent` instance with the resolved settings."},{"type":"text","text":"agentId: ad9d9e8fad2c2fea4 (for resuming to continue this agent's work if needed)\n<usage>total_tokens: 12216\ntool_uses: 1\nduration_ms: 8287</usage>"}]}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"5cd87246-ba32-49b9-a73d-9bd88fd7a00c","tool_use_result":{"status":"completed","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/create-agent.ts completely and return all its contents.","agentId":"ad9d9e8fad2c2fea4","content":[{"type":"text","text":"Here are the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/create-agent.ts`:\n\n```typescript\nimport type { ToolSet } from \"ai\";\nimport { DeepFactorAgent } from \"./agent.js\";\nimport { maxIterations } from \"./stop-conditions.js\";\nimport { todoMiddleware, errorRecoveryMiddleware } from \"./middleware.js\";\nimport type { DeepFactorAgentSettings } from \"./types.js\";\n\nexport function createDeepFactorAgent<\n  TTools extends ToolSet = ToolSet,\n>(settings: DeepFactorAgentSettings<TTools>): DeepFactorAgent<TTools> {\n  const resolvedSettings: DeepFactorAgentSettings<TTools> = {\n    ...settings,\n    tools: settings.tools ?? ({} as TTools),\n    instructions: settings.instructions ?? \"\",\n    stopWhen: settings.stopWhen ?? [maxIterations(10)],\n    verifyCompletion: settings.verifyCompletion,\n    middleware: settings.middleware ?? [\n      todoMiddleware(),\n      errorRecoveryMiddleware(),\n    ],\n    interruptOn: settings.interruptOn ?? [],\n    contextManagement: {\n      maxContextTokens: 150000,\n      keepRecentIterations: 3,\n      ...settings.contextManagement,\n    },\n  };\n\n  return new DeepFactorAgent(resolvedSettings);\n}\n```\n\nThe file is 29 lines long and exports a single factory function `createDeepFactorAgent`. Here is a summary of what it does:\n\n- It is a generic factory function typed on `TTools extends ToolSet`.\n- It accepts a `DeepFactorAgentSettings<TTools>` object.\n- It applies default values for several settings:\n  - `tools`: defaults to an empty object `{}`\n  - `instructions`: defaults to an empty string `\"\"`\n  - `stopWhen`: defaults to `[maxIterations(10)]`\n  - `middleware`: defaults to `[todoMiddleware(), errorRecoveryMiddleware()]`\n  - `interruptOn`: defaults to an empty array `[]`\n  - `contextManagement`: defaults to `{ maxContextTokens: 150000, keepRecentIterations: 3 }`, with any provided values merged on top\n- It constructs and returns a new `DeepFactorAgent` instance with the resolved settings."}],"totalDurationMs":8287,"totalTokens":12216,"totalToolUseCount":1,"usage":{"input_tokens":1,"cache_creation_input_tokens":534,"cache_read_input_tokens":11099,"output_tokens":582,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":534,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}}}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019HQB83uJ6b2VSsyKNye9j9","type":"tool_result","content":[{"type":"text","text":"Here is the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/types.ts`:\n\n---\n\n**File:** `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/types.ts`\n\n**Total lines:** 196\n\n**Summary of what the file defines:**\n\n**Imports**\n- `LanguageModel` and `ToolSet` from the `\"ai\"` package.\n\n**Event Types**\n- `AgentEventType` - a union of string literals: `\"tool_call\"`, `\"tool_result\"`, `\"error\"`, `\"human_input_requested\"`, `\"human_input_received\"`, `\"message\"`, `\"completion\"`, `\"summary\"`.\n- `BaseEvent` - base interface with `type`, `timestamp`, and `iteration`.\n- Specific event interfaces extending `BaseEvent`:\n  - `ToolCallEvent` - includes `toolName`, `toolCallId`, `args`.\n  - `ToolResultEvent` - includes `toolCallId`, `result`.\n  - `ErrorEvent` - includes `error`, optional `toolCallId`, and `recoverable`.\n  - `HumanInputRequestedEvent` - includes `question`, optional `context`, `urgency`, `format`, and `choices`.\n  - `HumanInputReceivedEvent` - includes `response`.\n  - `MessageEvent` - includes `role` and `content`.\n  - `CompletionEvent` - includes `result` and `verified`.\n  - `SummaryEvent` - includes `summarizedIterations` and `summary`.\n- `AgentEvent` - a discriminated union of all event interfaces.\n\n**Thread**\n- `AgentThread` - includes `id`, `events`, `metadata`, `createdAt`, `updatedAt`.\n\n**Token Usage**\n- `TokenUsage` - includes `inputTokens`, `outputTokens`, `totalTokens`, optional `cacheReadTokens` and `cacheWriteTokens`.\n\n**Stop Conditions**\n- `StopConditionContext` - includes `iteration`, `usage`, `model`, `thread`.\n- `StopConditionResult` - includes `stop` and optional `reason`.\n- `StopCondition` - a function type `(ctx: StopConditionContext) => StopConditionResult`.\n\n**Verification**\n- `VerifyContext` - includes `result`, `iteration`, `thread`, `originalPrompt`.\n- `VerifyResult` - includes `complete` and optional `reason`.\n- `VerifyCompletion` - an async function type `(ctx: VerifyContext) => Promise<VerifyResult>`.\n\n**Context Management**\n- `ContextManagementConfig` - optional `maxContextTokens` and `keepRecentIterations`.\n\n**Middleware**\n- `MiddlewareContext` - includes `thread`, `iteration`, `settings`.\n- `AgentMiddleware` - includes `name`, optional `tools`, optional `beforeIteration` and `afterIteration` hooks.\n\n**Agent Settings**\n- `DeepFactorAgentSettings<TTools extends ToolSet>` - the main configuration interface including `model`, `tools`, `instructions`, `stopWhen`, `verifyCompletion`, `middleware`, `interruptOn`, `contextManagement`, and lifecycle callbacks `onIterationStart`/`onIterationEnd`.\n\n**Results**\n- `AgentResult` - includes `response`, `thread`, `usage`, `iterations`, `stopReason`, and optional `stopDetail`.\n- `PendingResult` - extends `AgentResult` with `stopReason: \"human_input_needed\"` and a `resume` function to continue execution after human input."},{"type":"text","text":"agentId: a216f69e7da19fc36 (for resuming to continue this agent's work if needed)\n<usage>total_tokens: 14008\ntool_uses: 1\nduration_ms: 13098</usage>"}]}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"f1f95dda-2790-418e-8a67-07a7ff584fb6","tool_use_result":{"status":"completed","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/types.ts completely and return all its contents.","agentId":"a216f69e7da19fc36","content":[{"type":"text","text":"Here is the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/types.ts`:\n\n---\n\n**File:** `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/types.ts`\n\n**Total lines:** 196\n\n**Summary of what the file defines:**\n\n**Imports**\n- `LanguageModel` and `ToolSet` from the `\"ai\"` package.\n\n**Event Types**\n- `AgentEventType` - a union of string literals: `\"tool_call\"`, `\"tool_result\"`, `\"error\"`, `\"human_input_requested\"`, `\"human_input_received\"`, `\"message\"`, `\"completion\"`, `\"summary\"`.\n- `BaseEvent` - base interface with `type`, `timestamp`, and `iteration`.\n- Specific event interfaces extending `BaseEvent`:\n  - `ToolCallEvent` - includes `toolName`, `toolCallId`, `args`.\n  - `ToolResultEvent` - includes `toolCallId`, `result`.\n  - `ErrorEvent` - includes `error`, optional `toolCallId`, and `recoverable`.\n  - `HumanInputRequestedEvent` - includes `question`, optional `context`, `urgency`, `format`, and `choices`.\n  - `HumanInputReceivedEvent` - includes `response`.\n  - `MessageEvent` - includes `role` and `content`.\n  - `CompletionEvent` - includes `result` and `verified`.\n  - `SummaryEvent` - includes `summarizedIterations` and `summary`.\n- `AgentEvent` - a discriminated union of all event interfaces.\n\n**Thread**\n- `AgentThread` - includes `id`, `events`, `metadata`, `createdAt`, `updatedAt`.\n\n**Token Usage**\n- `TokenUsage` - includes `inputTokens`, `outputTokens`, `totalTokens`, optional `cacheReadTokens` and `cacheWriteTokens`.\n\n**Stop Conditions**\n- `StopConditionContext` - includes `iteration`, `usage`, `model`, `thread`.\n- `StopConditionResult` - includes `stop` and optional `reason`.\n- `StopCondition` - a function type `(ctx: StopConditionContext) => StopConditionResult`.\n\n**Verification**\n- `VerifyContext` - includes `result`, `iteration`, `thread`, `originalPrompt`.\n- `VerifyResult` - includes `complete` and optional `reason`.\n- `VerifyCompletion` - an async function type `(ctx: VerifyContext) => Promise<VerifyResult>`.\n\n**Context Management**\n- `ContextManagementConfig` - optional `maxContextTokens` and `keepRecentIterations`.\n\n**Middleware**\n- `MiddlewareContext` - includes `thread`, `iteration`, `settings`.\n- `AgentMiddleware` - includes `name`, optional `tools`, optional `beforeIteration` and `afterIteration` hooks.\n\n**Agent Settings**\n- `DeepFactorAgentSettings<TTools extends ToolSet>` - the main configuration interface including `model`, `tools`, `instructions`, `stopWhen`, `verifyCompletion`, `middleware`, `interruptOn`, `contextManagement`, and lifecycle callbacks `onIterationStart`/`onIterationEnd`.\n\n**Results**\n- `AgentResult` - includes `response`, `thread`, `usage`, `iterations`, `stopReason`, and optional `stopDetail`.\n- `PendingResult` - extends `AgentResult` with `stopReason: \"human_input_needed\"` and a `resume` function to continue execution after human input."}],"totalDurationMs":13098,"totalTokens":14008,"totalToolUseCount":1,"usage":{"input_tokens":1,"cache_creation_input_tokens":2027,"cache_read_input_tokens":11097,"output_tokens":883,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":2027,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}}}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01ReqGnN35y2QyYNvyYcjPwx","type":"tool_result","content":[{"type":"text","text":"Here are the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/package.json`:\n\n```json\n{\n  \"name\": \"deep-factor-agent\",\n  \"version\": \"0.0.0\",\n  \"type\": \"module\",\n  \"main\": \"./dist/index.js\",\n  \"types\": \"./dist/index.d.ts\",\n  \"exports\": {\n    \".\": {\n      \"import\": \"./dist/index.js\",\n      \"types\": \"./dist/index.d.ts\"\n    }\n  },\n  \"scripts\": {\n    \"build\": \"tsc\",\n    \"dev\": \"tsc --watch\",\n    \"test\": \"vitest run\",\n    \"test:watch\": \"vitest\",\n    \"type-check\": \"tsc --noEmit\"\n  },\n  \"peerDependencies\": {\n    \"zod\": \">=4.0.0\"\n  },\n  \"dependencies\": {\n    \"@ai-sdk/provider-utils\": \"^4.0.15\",\n    \"ai\": \"^6.0.97\"\n  },\n  \"devDependencies\": {\n    \"@types/node\": \"^25.3.0\",\n    \"typescript\": \"^5.9.3\",\n    \"vitest\": \"^4.0.18\"\n  }\n}\n```\n\nKey details from the file:\n\n- **Package name**: `deep-factor-agent`\n- **Version**: `0.0.0`\n- **Module type**: ESM (`\"type\": \"module\"`)\n- **Entry points**: `./dist/index.js` (main) and `./dist/index.d.ts` (types)\n- **Scripts**: build with `tsc`, dev watch mode, tests via `vitest`, and type-checking\n- **Peer dependency**: `zod` version 4.0.0 or higher\n- **Runtime dependencies**: `@ai-sdk/provider-utils` and `ai` (Vercel AI SDK)\n- **Dev dependencies**: Node.js types, TypeScript 5.9.3, and Vitest 4.0.18"},{"type":"text","text":"agentId: a3311f4fba71fb5c5 (for resuming to continue this agent's work if needed)\n<usage>total_tokens: 12125\ntool_uses: 1\nduration_ms: 7290</usage>"}]}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"7becb887-1f4d-42f0-8f53-5684c91dd121","tool_use_result":{"status":"completed","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/package.json completely and return all its contents.","agentId":"a3311f4fba71fb5c5","content":[{"type":"text","text":"Here are the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/package.json`:\n\n```json\n{\n  \"name\": \"deep-factor-agent\",\n  \"version\": \"0.0.0\",\n  \"type\": \"module\",\n  \"main\": \"./dist/index.js\",\n  \"types\": \"./dist/index.d.ts\",\n  \"exports\": {\n    \".\": {\n      \"import\": \"./dist/index.js\",\n      \"types\": \"./dist/index.d.ts\"\n    }\n  },\n  \"scripts\": {\n    \"build\": \"tsc\",\n    \"dev\": \"tsc --watch\",\n    \"test\": \"vitest run\",\n    \"test:watch\": \"vitest\",\n    \"type-check\": \"tsc --noEmit\"\n  },\n  \"peerDependencies\": {\n    \"zod\": \">=4.0.0\"\n  },\n  \"dependencies\": {\n    \"@ai-sdk/provider-utils\": \"^4.0.15\",\n    \"ai\": \"^6.0.97\"\n  },\n  \"devDependencies\": {\n    \"@types/node\": \"^25.3.0\",\n    \"typescript\": \"^5.9.3\",\n    \"vitest\": \"^4.0.18\"\n  }\n}\n```\n\nKey details from the file:\n\n- **Package name**: `deep-factor-agent`\n- **Version**: `0.0.0`\n- **Module type**: ESM (`\"type\": \"module\"`)\n- **Entry points**: `./dist/index.js` (main) and `./dist/index.d.ts` (types)\n- **Scripts**: build with `tsc`, dev watch mode, tests via `vitest`, and type-checking\n- **Peer dependency**: `zod` version 4.0.0 or higher\n- **Runtime dependencies**: `@ai-sdk/provider-utils` and `ai` (Vercel AI SDK)\n- **Dev dependencies**: Node.js types, TypeScript 5.9.3, and Vitest 4.0.18"}],"totalDurationMs":7290,"totalTokens":12125,"totalToolUseCount":1,"usage":{"input_tokens":1,"cache_creation_input_tokens":516,"cache_read_input_tokens":11095,"output_tokens":513,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":516,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}}}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Fyi7ihU6HMVxVWk8StkCMJ","type":"tool_result","content":[{"type":"text","text":"Here are the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/human-in-the-loop.ts`:\n\n```typescript\nimport { z } from \"zod\";\nimport type { ToolSet } from \"ai\";\n\nexport const requestHumanInputSchema = z.object({\n  question: z.string().describe(\"The question to ask the human\"),\n  context: z.string().optional().describe(\"Background context for the question\"),\n  urgency: z\n    .enum([\"low\", \"medium\", \"high\"])\n    .optional()\n    .default(\"medium\")\n    .describe(\"How urgent is this request\"),\n  format: z\n    .enum([\"free_text\", \"yes_no\", \"multiple_choice\"])\n    .optional()\n    .default(\"free_text\")\n    .describe(\"Expected response format\"),\n  choices: z\n    .array(z.string())\n    .optional()\n    .describe(\"Options for multiple_choice format\"),\n});\n\nexport const requestHumanInput = {\n  description:\n    \"Request input or approval from a human. Use when you need clarification, confirmation, or a decision.\",\n  parameters: requestHumanInputSchema,\n  execute: async (args: z.infer<typeof requestHumanInputSchema>) => {\n    // The actual pause mechanism is handled by the agent loop.\n    // This tool's execute function returns the args so the loop can detect it.\n    return {\n      requested: true,\n      question: args.question,\n      context: args.context,\n      urgency: args.urgency,\n      format: args.format,\n      choices: args.choices,\n    };\n  },\n} as unknown as ToolSet[string];\n```\n\nThe file is 39 lines long and exports two things:\n\n1. `requestHumanInputSchema` - A Zod schema defining the shape of a human input request with fields:\n   - `question` (required string) - the question to ask\n   - `context` (optional string) - background context\n   - `urgency` (optional enum: \"low\" | \"medium\" | \"high\", defaults to \"medium\")\n   - `format` (optional enum: \"free_text\" | \"yes_no\" | \"multiple_choice\", defaults to \"free_text\")\n   - `choices` (optional string array) - options for multiple_choice format\n\n2. `requestHumanInput` - A tool object (typed as `ToolSet[string]`) with a description and an `execute` function that returns the input args along with a `requested: true` flag, intended to signal the agent loop to pause and await human input."},{"type":"text","text":"agentId: a2bc1b8cd4939a53c (for resuming to continue this agent's work if needed)\n<usage>total_tokens: 12353\ntool_uses: 1\nduration_ms: 9216</usage>"}]}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"92b1c228-7863-4dd5-91a5-3c988b182261","tool_use_result":{"status":"completed","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/human-in-the-loop.ts completely and return all its contents.","agentId":"a2bc1b8cd4939a53c","content":[{"type":"text","text":"Here are the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/human-in-the-loop.ts`:\n\n```typescript\nimport { z } from \"zod\";\nimport type { ToolSet } from \"ai\";\n\nexport const requestHumanInputSchema = z.object({\n  question: z.string().describe(\"The question to ask the human\"),\n  context: z.string().optional().describe(\"Background context for the question\"),\n  urgency: z\n    .enum([\"low\", \"medium\", \"high\"])\n    .optional()\n    .default(\"medium\")\n    .describe(\"How urgent is this request\"),\n  format: z\n    .enum([\"free_text\", \"yes_no\", \"multiple_choice\"])\n    .optional()\n    .default(\"free_text\")\n    .describe(\"Expected response format\"),\n  choices: z\n    .array(z.string())\n    .optional()\n    .describe(\"Options for multiple_choice format\"),\n});\n\nexport const requestHumanInput = {\n  description:\n    \"Request input or approval from a human. Use when you need clarification, confirmation, or a decision.\",\n  parameters: requestHumanInputSchema,\n  execute: async (args: z.infer<typeof requestHumanInputSchema>) => {\n    // The actual pause mechanism is handled by the agent loop.\n    // This tool's execute function returns the args so the loop can detect it.\n    return {\n      requested: true,\n      question: args.question,\n      context: args.context,\n      urgency: args.urgency,\n      format: args.format,\n      choices: args.choices,\n    };\n  },\n} as unknown as ToolSet[string];\n```\n\nThe file is 39 lines long and exports two things:\n\n1. `requestHumanInputSchema` - A Zod schema defining the shape of a human input request with fields:\n   - `question` (required string) - the question to ask\n   - `context` (optional string) - background context\n   - `urgency` (optional enum: \"low\" | \"medium\" | \"high\", defaults to \"medium\")\n   - `format` (optional enum: \"free_text\" | \"yes_no\" | \"multiple_choice\", defaults to \"free_text\")\n   - `choices` (optional string array) - options for multiple_choice format\n\n2. `requestHumanInput` - A tool object (typed as `ToolSet[string]`) with a description and an `execute` function that returns the input args along with a `requested: true` flag, intended to signal the agent loop to pause and await human input."}],"totalDurationMs":9216,"totalTokens":12353,"totalToolUseCount":1,"usage":{"input_tokens":1,"cache_creation_input_tokens":623,"cache_read_input_tokens":11103,"output_tokens":626,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":623,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}}}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RdiPt4sCzRoqkeyECTFnFA","type":"tool_result","content":[{"type":"text","text":"Here is the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/stop-conditions.ts`:\n\n---\n\n**File:** `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/stop-conditions.ts`\n\n**Total lines:** 155\n\n---\n\n**Imports (lines 1-6)**\n\nImports four types from `./types.js`: `TokenUsage`, `StopCondition`, `StopConditionContext`, and `StopConditionResult`.\n\n---\n\n**Model Pricing (lines 10-56)**\n\nAn exported constant `MODEL_PRICING` — a `Record<string, { input, output, cacheRead?, cacheWrite? }>` mapping model names to per-token costs:\n\n- Anthropic models: `claude-sonnet-4-5`, `claude-opus-4-5`, `claude-haiku-4-5` (all with cache read/write pricing)\n- OpenAI models: `gpt-4o`, `gpt-4o-mini` (no cache pricing)\n- Google models: `gemini-2.5-pro`, `gemini-2.5-flash` (no cache pricing)\n\n---\n\n**Cost Calculation (lines 60-78)**\n\n`calculateCost(usage: TokenUsage, model: string): number`\n\nComputes total cost by multiplying `inputTokens` and `outputTokens` by model pricing, and optionally adds `cacheReadTokens` and `cacheWriteTokens` costs if both usage and pricing exist. Returns `0` if the model is not found.\n\n---\n\n**Stop Condition Factories (lines 82-139)**\n\nFour factory functions that each return a `StopCondition` (a function `(ctx) => StopConditionResult`):\n\n- `maxIterations(n)` - stops when `ctx.iteration >= n`\n- `maxTokens(n)` - stops when `ctx.usage.totalTokens >= n`\n- `maxInputTokens(n)` - stops when `ctx.usage.inputTokens >= n`\n- `maxOutputTokens(n)` - stops when `ctx.usage.outputTokens >= n`\n- `maxCost(dollars, model?)` - stops when calculated cost >= `dollars`; uses `ctx.model` if `model` is not provided\n\n---\n\n**Evaluator (lines 143-154)**\n\n`evaluateStopConditions(conditions: StopCondition[], ctx: StopConditionContext): StopConditionResult | null`\n\nIterates through all conditions, returning the first `StopConditionResult` where `stop === true`, or `null` if none trigger."},{"type":"text","text":"agentId: a698b52e54d130644 (for resuming to continue this agent's work if needed)\n<usage>total_tokens: 13620\ntool_uses: 1\nduration_ms: 12744</usage>"}]}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"42aebb4b-6c2b-4a4a-83c0-66ff51c13c97","tool_use_result":{"status":"completed","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/stop-conditions.ts completely and return all its contents.","agentId":"a698b52e54d130644","content":[{"type":"text","text":"Here is the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/stop-conditions.ts`:\n\n---\n\n**File:** `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/stop-conditions.ts`\n\n**Total lines:** 155\n\n---\n\n**Imports (lines 1-6)**\n\nImports four types from `./types.js`: `TokenUsage`, `StopCondition`, `StopConditionContext`, and `StopConditionResult`.\n\n---\n\n**Model Pricing (lines 10-56)**\n\nAn exported constant `MODEL_PRICING` — a `Record<string, { input, output, cacheRead?, cacheWrite? }>` mapping model names to per-token costs:\n\n- Anthropic models: `claude-sonnet-4-5`, `claude-opus-4-5`, `claude-haiku-4-5` (all with cache read/write pricing)\n- OpenAI models: `gpt-4o`, `gpt-4o-mini` (no cache pricing)\n- Google models: `gemini-2.5-pro`, `gemini-2.5-flash` (no cache pricing)\n\n---\n\n**Cost Calculation (lines 60-78)**\n\n`calculateCost(usage: TokenUsage, model: string): number`\n\nComputes total cost by multiplying `inputTokens` and `outputTokens` by model pricing, and optionally adds `cacheReadTokens` and `cacheWriteTokens` costs if both usage and pricing exist. Returns `0` if the model is not found.\n\n---\n\n**Stop Condition Factories (lines 82-139)**\n\nFour factory functions that each return a `StopCondition` (a function `(ctx) => StopConditionResult`):\n\n- `maxIterations(n)` - stops when `ctx.iteration >= n`\n- `maxTokens(n)` - stops when `ctx.usage.totalTokens >= n`\n- `maxInputTokens(n)` - stops when `ctx.usage.inputTokens >= n`\n- `maxOutputTokens(n)` - stops when `ctx.usage.outputTokens >= n`\n- `maxCost(dollars, model?)` - stops when calculated cost >= `dollars`; uses `ctx.model` if `model` is not provided\n\n---\n\n**Evaluator (lines 143-154)**\n\n`evaluateStopConditions(conditions: StopCondition[], ctx: StopConditionContext): StopConditionResult | null`\n\nIterates through all conditions, returning the first `StopConditionResult` where `stop === true`, or `null` if none trigger."}],"totalDurationMs":12744,"totalTokens":13620,"totalToolUseCount":1,"usage":{"input_tokens":1,"cache_creation_input_tokens":1883,"cache_read_input_tokens":11099,"output_tokens":637,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":1883,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}}}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011gS8qvRtDZ9acZv5a9H5Tq","type":"tool_result","content":[{"type":"text","text":"Here is the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/middleware.ts`:\n\n---\n\n**File:** `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/middleware.ts`\n\n**Line count:** 121 lines\n\n**Imports:**\n- `ToolSet` from `\"ai\"`\n- `z` from `\"zod\"`\n- `AgentMiddleware`, `MiddlewareContext`, `ErrorEvent` from `\"./types.js\"`\n\n---\n\n**Exported Interface: `ComposedMiddleware`**\n\n```typescript\nexport interface ComposedMiddleware {\n  tools: ToolSet;\n  beforeIteration: (ctx: MiddlewareContext) => Promise<void>;\n  afterIteration: (ctx: MiddlewareContext, result: unknown) => Promise<void>;\n}\n```\n\n---\n\n**Exported Function: `composeMiddleware`**\n\nTakes an array of `AgentMiddleware` objects and returns a `ComposedMiddleware`. It:\n1. Merges all tools from each middleware into a single `ToolSet`, warning on name conflicts.\n2. Composes `beforeIteration` hooks by calling each middleware's `beforeIteration` in sequence.\n3. Composes `afterIteration` hooks by calling each middleware's `afterIteration` in sequence.\n\n---\n\n**Exported Function: `todoMiddleware`**\n\nReturns an `AgentMiddleware` named `\"todo\"` with two tools:\n\n- `write_todos` - Creates or updates a todo list. Parameters: `{ todos: Array<{ id: string, text: string, status: \"pending\" | \"in_progress\" | \"done\" }> }`. Returns `{ success: true, todos }`.\n- `read_todos` - Reads the current todo list. No parameters. Returns `{ todos: [] }` (the agent loop handles the actual read from `thread.metadata.todos`).\n\n---\n\n**Exported Function: `errorRecoveryMiddleware`**\n\nReturns an `AgentMiddleware` named `\"errorRecovery\"` with an `afterIteration` hook that:\n1. Checks if the last event on the thread is an `\"error\"` type event.\n2. If so, truncates the error message to 500 characters if needed.\n3. Pushes a `\"message\"` system event onto `thread.events` suggesting the agent consider an alternative approach if the error recurs."},{"type":"text","text":"agentId: ac3f7dfad8f3bb1ad (for resuming to continue this agent's work if needed)\n<usage>total_tokens: 13162\ntool_uses: 1\nduration_ms: 11798</usage>"}]}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"a034428e-ee61-41e4-8ab9-0d842cefbd8a","tool_use_result":{"status":"completed","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/middleware.ts completely and return all its contents.","agentId":"ac3f7dfad8f3bb1ad","content":[{"type":"text","text":"Here is the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/middleware.ts`:\n\n---\n\n**File:** `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/middleware.ts`\n\n**Line count:** 121 lines\n\n**Imports:**\n- `ToolSet` from `\"ai\"`\n- `z` from `\"zod\"`\n- `AgentMiddleware`, `MiddlewareContext`, `ErrorEvent` from `\"./types.js\"`\n\n---\n\n**Exported Interface: `ComposedMiddleware`**\n\n```typescript\nexport interface ComposedMiddleware {\n  tools: ToolSet;\n  beforeIteration: (ctx: MiddlewareContext) => Promise<void>;\n  afterIteration: (ctx: MiddlewareContext, result: unknown) => Promise<void>;\n}\n```\n\n---\n\n**Exported Function: `composeMiddleware`**\n\nTakes an array of `AgentMiddleware` objects and returns a `ComposedMiddleware`. It:\n1. Merges all tools from each middleware into a single `ToolSet`, warning on name conflicts.\n2. Composes `beforeIteration` hooks by calling each middleware's `beforeIteration` in sequence.\n3. Composes `afterIteration` hooks by calling each middleware's `afterIteration` in sequence.\n\n---\n\n**Exported Function: `todoMiddleware`**\n\nReturns an `AgentMiddleware` named `\"todo\"` with two tools:\n\n- `write_todos` - Creates or updates a todo list. Parameters: `{ todos: Array<{ id: string, text: string, status: \"pending\" | \"in_progress\" | \"done\" }> }`. Returns `{ success: true, todos }`.\n- `read_todos` - Reads the current todo list. No parameters. Returns `{ todos: [] }` (the agent loop handles the actual read from `thread.metadata.todos`).\n\n---\n\n**Exported Function: `errorRecoveryMiddleware`**\n\nReturns an `AgentMiddleware` named `\"errorRecovery\"` with an `afterIteration` hook that:\n1. Checks if the last event on the thread is an `\"error\"` type event.\n2. If so, truncates the error message to 500 characters if needed.\n3. Pushes a `\"message\"` system event onto `thread.events` suggesting the agent consider an alternative approach if the error recurs."}],"totalDurationMs":11798,"totalTokens":13162,"totalToolUseCount":1,"usage":{"input_tokens":1,"cache_creation_input_tokens":1478,"cache_read_input_tokens":11097,"output_tokens":586,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":1478,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}}}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0179bA5dJmNgHuytE2MjrkaY","type":"tool_result","content":[{"type":"text","text":"Here are the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/context-manager.ts`:\n\n---\n\n**File:** `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/context-manager.ts`\n\n**Lines:** 128\n\n---\n\n**Imports (lines 1-7)**\n\n```typescript\nimport type { LanguageModel } from \"ai\";\nimport { generateText } from \"ai\";\nimport type {\n  AgentThread,\n  ContextManagementConfig,\n  SummaryEvent,\n} from \"./types.js\";\n```\n\n---\n\n**`estimateTokens` function (lines 9-12)**\n\nA standalone utility that approximates token count from a string using the ratio of 1 token per 3.5 characters.\n\n```typescript\nexport function estimateTokens(text: string): number {\n  if (text.length === 0) return 0;\n  return Math.ceil(text.length / 3.5);\n}\n```\n\n---\n\n**`ContextManager` class (lines 14-128)**\n\nA class that manages context window size for an agent thread by summarizing old iterations.\n\n**Constructor (lines 18-21)**\n\nAccepts a `ContextManagementConfig` with defaults:\n- `maxContextTokens`: 150,000\n- `keepRecentIterations`: 3\n\n**`estimateThreadTokens` (lines 23-30)**\n\nIterates all events in a thread, serializes each to JSON, and sums estimated tokens.\n\n**`needsSummarization` (lines 32-34)**\n\nReturns `true` if the estimated token count of the thread exceeds `maxContextTokens`.\n\n**`summarize` (lines 36-111)**\n\nThe core async method that:\n1. Groups events by their `iteration` number.\n2. Determines which iterations are \"old\" (beyond `keepRecentIterations` from the max).\n3. For each old iteration (skipping already-summarized events), calls the LLM via `generateText` to produce a 2-3 sentence summary.\n4. On failure, falls back to a simple placeholder summary.\n5. Replaces old iteration events with the new `SummaryEvent` objects and preserves recent events.\n\n**`buildContextInjection` (lines 113-127)**\n\nExtracts all `SummaryEvent`s from the thread and formats them into a markdown string under the heading `## Previous Iteration Summaries`, grouping by summarized iteration numbers."},{"type":"text","text":"agentId: a16332779cadf7d5a (for resuming to continue this agent's work if needed)\n<usage>total_tokens: 13358\ntool_uses: 1\nduration_ms: 13238</usage>"}]}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"bea94704-2141-405f-9d0d-818b8a1e84b4","tool_use_result":{"status":"completed","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/context-manager.ts completely and return all its contents.","agentId":"a16332779cadf7d5a","content":[{"type":"text","text":"Here are the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/context-manager.ts`:\n\n---\n\n**File:** `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/context-manager.ts`\n\n**Lines:** 128\n\n---\n\n**Imports (lines 1-7)**\n\n```typescript\nimport type { LanguageModel } from \"ai\";\nimport { generateText } from \"ai\";\nimport type {\n  AgentThread,\n  ContextManagementConfig,\n  SummaryEvent,\n} from \"./types.js\";\n```\n\n---\n\n**`estimateTokens` function (lines 9-12)**\n\nA standalone utility that approximates token count from a string using the ratio of 1 token per 3.5 characters.\n\n```typescript\nexport function estimateTokens(text: string): number {\n  if (text.length === 0) return 0;\n  return Math.ceil(text.length / 3.5);\n}\n```\n\n---\n\n**`ContextManager` class (lines 14-128)**\n\nA class that manages context window size for an agent thread by summarizing old iterations.\n\n**Constructor (lines 18-21)**\n\nAccepts a `ContextManagementConfig` with defaults:\n- `maxContextTokens`: 150,000\n- `keepRecentIterations`: 3\n\n**`estimateThreadTokens` (lines 23-30)**\n\nIterates all events in a thread, serializes each to JSON, and sums estimated tokens.\n\n**`needsSummarization` (lines 32-34)**\n\nReturns `true` if the estimated token count of the thread exceeds `maxContextTokens`.\n\n**`summarize` (lines 36-111)**\n\nThe core async method that:\n1. Groups events by their `iteration` number.\n2. Determines which iterations are \"old\" (beyond `keepRecentIterations` from the max).\n3. For each old iteration (skipping already-summarized events), calls the LLM via `generateText` to produce a 2-3 sentence summary.\n4. On failure, falls back to a simple placeholder summary.\n5. Replaces old iteration events with the new `SummaryEvent` objects and preserves recent events.\n\n**`buildContextInjection` (lines 113-127)**\n\nExtracts all `SummaryEvent`s from the thread and formats them into a markdown string under the heading `## Previous Iteration Summaries`, grouping by summarized iteration numbers."}],"totalDurationMs":13238,"totalTokens":13358,"totalToolUseCount":1,"usage":{"input_tokens":1,"cache_creation_input_tokens":1658,"cache_read_input_tokens":11099,"output_tokens":600,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":1658,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}}}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NNaDfKGwAaSCJUfopDMNs5","type":"tool_result","content":[{"type":"text","text":"Here is the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/agent.ts`:\n\n---\n\n**File:** `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/agent.ts`\n\n**Total lines:** 624\n\n**Overview of the file's structure:**\n\n**Imports (lines 1-24)**\nImports from the `ai` SDK (`LanguageModel`, `ToolSet`, `generateText`, `streamText`, `stepCountIs`), internal modules (`middleware`, `stop-conditions`, `context-manager`), and a comprehensive set of types from `./types.js`.\n\n**Utility Functions (lines 26-81)**\n\n- `createThreadId()` - generates unique thread IDs using timestamp + counter\n- `addUsage(a, b)` - merges two `TokenUsage` objects by summing their fields\n- `extractUsage(sdkUsage)` - normalizes SDK usage data into the internal `TokenUsage` shape\n- `compactError(error, maxLen)` - converts errors to strings, truncating at 500 chars\n- `createThread()` - creates a new `AgentThread` with a fresh ID, empty events, and timestamps\n\n**`DeepFactorAgent` Class (lines 83-624)**\n\nThis is the core class, generic over `TTools extends ToolSet`.\n\nPrivate fields:\n- `model`, `tools`, `instructions`, `stopConditions`, `verifyCompletion`\n- `composedMiddleware`, `interruptOn`, `contextManager`\n- `onIterationStart`, `onIterationEnd`, `modelId`\n\nKey private methods:\n- `buildMessages(thread)` (lines 132-191) - Converts thread events into a `system` prompt + `messages` array for the LLM\n- `appendResultEvents(thread, result, iteration)` (lines 193-257) - Records tool calls, tool results, and assistant messages back into the thread\n- `isPendingHumanInput(thread)` (lines 259-268) - Checks if there is an unanswered human input request\n- `getLastHumanInputRequest(thread)` (lines 270-279) - Finds the most recent `human_input_requested` event\n- `checkInterruptOn(thread, iteration)` (lines 281-299) - Checks if a tool call in the current iteration matches the `interruptOn` list\n\nPublic methods:\n- `loop(prompt)` (lines 301-304) - Entry point that creates a thread and calls `runLoop`\n- `runLoop(thread, prompt, startIteration)` (lines 306-594) - The main agentic loop using `generateText` with up to 20 steps per call. Handles: middleware hooks, context summarization, stop conditions, `interruptOn` interruptions, human input requests, completion verification, and error recovery (up to 3 consecutive errors)\n- `stream(prompt)` (lines 597-623) - A simpler non-looping path using `streamText` that returns the stream directly"},{"type":"text","text":"agentId: ad3715d6e63d8b850 (for resuming to continue this agent's work if needed)\n<usage>total_tokens: 18879\ntool_uses: 1\nduration_ms: 18110</usage>"}]}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"3ff9dc63-b246-4db8-adc5-8dfeb46f248d","tool_use_result":{"status":"completed","prompt":"Read the file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/agent.ts completely and return all its contents.","agentId":"ad3715d6e63d8b850","content":[{"type":"text","text":"Here is the complete contents of `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/agent.ts`:\n\n---\n\n**File:** `/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/agent.ts`\n\n**Total lines:** 624\n\n**Overview of the file's structure:**\n\n**Imports (lines 1-24)**\nImports from the `ai` SDK (`LanguageModel`, `ToolSet`, `generateText`, `streamText`, `stepCountIs`), internal modules (`middleware`, `stop-conditions`, `context-manager`), and a comprehensive set of types from `./types.js`.\n\n**Utility Functions (lines 26-81)**\n\n- `createThreadId()` - generates unique thread IDs using timestamp + counter\n- `addUsage(a, b)` - merges two `TokenUsage` objects by summing their fields\n- `extractUsage(sdkUsage)` - normalizes SDK usage data into the internal `TokenUsage` shape\n- `compactError(error, maxLen)` - converts errors to strings, truncating at 500 chars\n- `createThread()` - creates a new `AgentThread` with a fresh ID, empty events, and timestamps\n\n**`DeepFactorAgent` Class (lines 83-624)**\n\nThis is the core class, generic over `TTools extends ToolSet`.\n\nPrivate fields:\n- `model`, `tools`, `instructions`, `stopConditions`, `verifyCompletion`\n- `composedMiddleware`, `interruptOn`, `contextManager`\n- `onIterationStart`, `onIterationEnd`, `modelId`\n\nKey private methods:\n- `buildMessages(thread)` (lines 132-191) - Converts thread events into a `system` prompt + `messages` array for the LLM\n- `appendResultEvents(thread, result, iteration)` (lines 193-257) - Records tool calls, tool results, and assistant messages back into the thread\n- `isPendingHumanInput(thread)` (lines 259-268) - Checks if there is an unanswered human input request\n- `getLastHumanInputRequest(thread)` (lines 270-279) - Finds the most recent `human_input_requested` event\n- `checkInterruptOn(thread, iteration)` (lines 281-299) - Checks if a tool call in the current iteration matches the `interruptOn` list\n\nPublic methods:\n- `loop(prompt)` (lines 301-304) - Entry point that creates a thread and calls `runLoop`\n- `runLoop(thread, prompt, startIteration)` (lines 306-594) - The main agentic loop using `generateText` with up to 20 steps per call. Handles: middleware hooks, context summarization, stop conditions, `interruptOn` interruptions, human input requests, completion verification, and error recovery (up to 3 consecutive errors)\n- `stream(prompt)` (lines 597-623) - A simpler non-looping path using `streamText` that returns the stream directly"}],"totalDurationMs":18110,"totalTokens":18879,"totalToolUseCount":1,"usage":{"input_tokens":1,"cache_creation_input_tokens":7052,"cache_read_input_tokens":11097,"output_tokens":729,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":7052,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01C3epxmyu7Wx1gZkLaPbRZ7","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I now have all the information I need to write the README. Let me summarize what I've learned:\n\n1. The library is called `deep-factor-agent` - a TypeScript library implementing a loop-based AI agent\n2. Stack: TypeScript 5.x, Vercel AI SDK v6+, Zod v4+ (peer dep), ESM only\n3. Public API exports from src/index.ts\n4. Factory function `createDeepFactorAgent` with defaults\n5. Stop conditions: maxIterations, maxTokens, maxInputTokens, maxOutputTokens, maxCost\n6. Middleware: composeMiddleware, todoMiddleware, errorRecoveryMiddleware\n\n\n7. Context management with token estimation, human-in-the-loop capabilities, and the core DeepFactorAgent class with loop and stream methods\n\nNow I'm ready to write the README following the acceptance criteria, starting with the project name, description, installation, and quick start example, then moving into the various usage patterns. Now I'm looking at the other key methods and return types—the stream method for real-time output, the structure of AgentResult with response, thread, usage, iterations and stop reason details, and PendingResult which extends that for human-in-the-loop scenarios with a resume function. I'm also noting the stop condition utilities like maxCost that can be parameterized by dollars and optionally a specific model.","signature":"Eo4RCkYICxgCKkCC+P+QBbYtWlbSf6dp9W+2hkYg10DsyZOfwMgJlNdfDQ2PlLv4dZdZq7V7m/GlLIMJx++T6bB9ukW3s00W9OFVEgzgs3sF2lO7z/8uZ30aDB96g9m/3ihEop/iLiIwvQJnfM4Yp5B2jj/DmB+yRx4mqZZ1cv4pLka3kj26LWFaJ93yaqdeuSeSCMyh4FKUKvUPLbBK00k27Kf4T5dSbz6ywY08eZ4ZUhjgMeukzdQM5roZLsqdQ39NlAzrSO+b2zi8J3EyayPxskvBYhTrXUP007Ye3WwEkU5Aeh9uAPyFVGPIkhvccrWZTidg6twb6WnX+f41Rg2EBqZOv63K/CYeCLUH4T56cn3JeRWUYey4Q846VPd4y9BZoySJu8C8ngYVDgl/5fJ/g6WluLP74fx9NOBtR4fPSnrpzOkw9F8s8e5ePmhlM9LIMy7LpPF2sNGpcoLwafh+6cGcNFUpPk/zX4/3URxciepIJDKUg6uo/W7UxiYvUFehNGeMEnvYpFXLC09bzicWnCVv1pU2Y2Wr+CLxWEhFr9YNldqTRAKgSn3P0V0324pOlybrx4bKjUD/4vX4hKVKBQPpVtO1OByxZiVMWjSXjNcGjrmq1MPzaV+88PctEyyAJ0Z2EQHzbyL7q1/Trx6XHbZNCmiVVMTaZCY/5rQ5NMzMp104d8t66nLy0LLGbxvPBv4e0V3D0mqh2FESjSokxpNeDfdLceMJxSj1YYedz9+oBmRfoaTSYTS3ICcq00vbCtbLWMgOCoeOHutFsAyBUezQZrogx0MUh/B42nilKClRXePWyWyUYCI51emD6YiUvStDnncX310RadxmJ8eo3wyZxI8bPEMDaR7gFvdO6sl2HvmymVjAcsVZuQyr87O+98gv6hexwfVyx1FvaJcWHU5lBnbtqBo7yBzFy/fx4+bvDXkYdu9FgghCVXj+7S95sASRp3Ac0BXwF3hiDT1DQLYPjEqmHWKUU/QfjhAukSNpi+2Q2Bdn60HPFNanZ5AAYkXmsK/mrzW+ptJPatffMJMEMP4apQO6liyGKe61IgT+iCmH8ZKFrci1xwaIeh22lnguAMoPrJGJMKaEuuLpaNdcSamcQRgm0zBEVe6BIXfIP2YLXSwRXRRSEyaikvJnTiIO8ODOpFok/hqCNlGToKVNj2KjN8CxlO8W0tSM6TeMp5EwVlsA6IIqIIo0GjYWtGVoRyJCTm/mXKfRnLZrtiCNR5w2lzuFl5rEuU0Zcw6YG+scBihZ/yZ0Hzb/0tuDQ5ypuwz1KbnSskY42wLlZ6pS8EHHp4fPpQR4KRNRnhmxiqo+DuiVrFuCVuix8jDSIl/fbDiJ9NwQs3/RoLt6RkhKDPYXU+uGcA3OuS/klVRRstTy/FX1rYTlsXEvyD/RDe9sDh8LT94SqxfbTe/NqC18L83JW+c3UoFsYsSUkrokwqHc63t2vmUCXFJMKnv+bbNoTrZk6/7B8phmFc78dLaTNeKLxCup9M4H0loFas3QWzYyQ0cHlHm4T6sv9zY7Um/UAOZN5bc86ZyzehRYYyyn+0T1dvEkx1a0bE0RwISGPBRuhsMFoXvLwdxLHBmoFUqLD85DwhxAc+9FoN8KQUTIZCBg50enCMxhC6Mp3m8pKLTWLKZRVnjESKAyRyiXvjgFQmQ+mBvNxoRDYj8hSyCWywRXyuCt3U1/uINsCF1Yfq1SaKGouolxrUyJlv7NhyaKhKudjWL4bgJpEQGfYK2hOkz17ygDZgRawLpmUVJI/zprzSsoj4eIsFaxMigfBgvBpW31ReanxLRdDv5u/6tzfYWVINbwPzhsn64MjoCsbtsH2JuSLKEijwqTCarMwGRx5cJhmUiCYHNpXG8cUI6xy5EYSJlJrAbCtOvHBMRXZ5l+wplwJIoiF22zNlWcP8LjoHQRp76uiaM+3E7eOSQjp+8bzRu8L7is8LOnEsxEmtiWrJbkO2A7YtcIxibFY2WWYBZ17KZ+LCaT7PwC/BQE6soofiH6YFL3AeF00GWDmsOmKVK6BMKvpkT/dTg58PnazsGWSa0g0dtwdwKWR+eBb0H0bodA6Ud8Y5WRt3sQKBsUMHK5+DMmBu1SCItekcF/rHSBl6zGxPmw+Hk7hdd91ZeD49SDU8A0kOcjMugNEXAWjDvWOFGpZjc5VWAeQgQlQrf+C3UJ+oD7sLuMFSPtHu0Qgo4wmqukYsIUbTfPIcQpQ6r7QHrEL5T0N909St5uR6uK/MKWqr34KhoZPYBXv5hzA3Kcaf4yDKQ9BkmSm/f7tAHVxAZm5yh0/W7uUwwEwcqRIad6qoIcF/L+okvKF/bRD9C2nZM5q50YKA1qIyL4x6lvuZx5K17k01aXxp4Y6+2Xh1pmaw6jWAJ7AozbOHuyR1rkMLbCCRhCUyg26Utb3Mo+NS0LpDu0Rt3IaaPWawuBw4iTozRdO+dgvY0gkFxA7DBsG630BOPPSaGnOa0NzKs18Fy8KWYxm6LNMAF7JihXvziL9+Dq9bsWHRg/ZTL/PaAjqq++HruVHC0yKRv0mS/7HqGgt5eyyBdbZM6pknzjnoYc8hFP1ciou7Mgsq1xrBQcYiJEpYtmK47umoXXZJONCSym1dNZAnnrHDElO8bFEEF0cD6y1lS5u/5XEq37pM+zE+4wdSf+HSuR5rpf31nltbkmWPslP2J/sMgfyqMj93t1J/9L7BShLOlSTFrGMxnSgOaK4o7aKJqJhKK6F4NkGth/mZNEVx+5DSPchztmnmZf0Kc+cMVwmmB4JQ6Rzr4Hau5YQ0B4v4aFP4dkpzPqTS89i2Oo4vL7T8rnhBjcSxNI+VFyDvODvs6xvMKkydJgH1ehKciFmRTVUijXXZmo9Fmf0kaLaiSDfUBFFEilxFuaXvmVHSJDruSDjl4WoLry0CYo62cFGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":8454,"cache_read_input_tokens":25498,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":8454},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"3b9c7c69-0504-4263-af20-e4b3d55c04bf"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01C3epxmyu7Wx1gZkLaPbRZ7","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011KH5tBW7PieR3MnRvYHDhk","name":"TodoWrite","input":{"todos":[{"content":"Study specs and source code","status":"completed","activeForm":"Studying specs and source code"},{"content":"Author README.md per spec 01-setup-readme.md","status":"in_progress","activeForm":"Authoring README.md"},{"content":"Verify README code examples compile against public API","status":"pending","activeForm":"Verifying README code examples"},{"content":"Update IMPLEMENTATION_PLAN.md and commit/push","status":"pending","activeForm":"Updating plan and committing"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":8454,"cache_read_input_tokens":25498,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":8454},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"252e78c8-f244-414a-a165-0931807ebd89"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011KH5tBW7PieR3MnRvYHDhk","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"9d9f139c-cc3e-45cb-8f49-f42e92af1c43","tool_use_result":{"oldTodos":[{"content":"Study specs and source code","status":"in_progress","activeForm":"Studying specs and source code"},{"content":"Author README.md per spec 01-setup-readme.md","status":"pending","activeForm":"Authoring README.md"},{"content":"Verify README code examples compile against public API","status":"pending","activeForm":"Verifying README code examples"},{"content":"Update IMPLEMENTATION_PLAN.md and commit/push","status":"pending","activeForm":"Updating plan and committing"}],"newTodos":[{"content":"Study specs and source code","status":"completed","activeForm":"Studying specs and source code"},{"content":"Author README.md per spec 01-setup-readme.md","status":"in_progress","activeForm":"Authoring README.md"},{"content":"Verify README code examples compile against public API","status":"pending","activeForm":"Verifying README code examples"},{"content":"Update IMPLEMENTATION_PLAN.md and commit/push","status":"pending","activeForm":"Updating plan and committing"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01E4kaB3PuAfKZbudBW8qVtA","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have a thorough understanding of the entire public API. Let me author the README."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":821,"cache_read_input_tokens":33952,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":821},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"6977d5c0-eb71-450d-9e82-b8d3c09ed6a5"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01E4kaB3PuAfKZbudBW8qVtA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LYX13mjtNcb32EyacN71pp","name":"Write","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md","content":"# deep-factor-agent\n\nA TypeScript library for building loop-based AI agents with middleware, verification, stop conditions, human-in-the-loop, and context management — aligned with the [12-factor agent](https://github.com/humanlayer/12-factor-agents) methodology.\n\n## Overview\n\n`deep-factor-agent` wraps the [Vercel AI SDK v6](https://sdk.vercel.ai/) in an opinionated agent loop that gives you fine-grained control over iteration limits, cost guardrails, completion verification, context window management, and human escalation — all through a declarative configuration surface.\n\n**Why a loop-based agent?** Single-shot LLM calls are rarely enough for non-trivial tasks. An agentic loop lets the model call tools, observe results, reflect, and iterate until the task is truly done — while stop conditions and middleware keep execution safe and observable.\n\n### Key capabilities\n\n- **Agentic loop** — iterative tool-calling with automatic message history\n- **Stop conditions** — cap iterations, tokens, or dollar cost\n- **Completion verification** — optionally verify the agent actually finished the task\n- **Middleware** — inject tools and lifecycle hooks (built-in: todo tracking, error recovery)\n- **Human-in-the-loop** — pause execution, collect human input, and resume\n- **Context management** — automatic summarization when the context window fills up\n- **Streaming** — stream the first LLM turn for real-time UIs\n\n## Installation\n\n```bash\npnpm add deep-factor-agent ai zod\n```\n\n`ai` (Vercel AI SDK v6+) is a runtime dependency. `zod` (v4+) is a **peer dependency** — you must install it yourself.\n\nYou also need a model provider, e.g.:\n\n```bash\npnpm add @ai-sdk/anthropic\n# or @ai-sdk/openai, @ai-sdk/google, etc.\n```\n\n## Quick Start\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  instructions: \"You are a helpful assistant.\",\n  stopWhen: [maxIterations(5)],\n});\n\nconst result = await agent.loop(\"What is the capital of France?\");\n\nconsole.log(result.response);   // \"The capital of France is Paris.\"\nconsole.log(result.iterations); // number of loop iterations used\nconsole.log(result.usage);      // { inputTokens, outputTokens, totalTokens }\n```\n\n## Usage Examples\n\n### Minimal agent (model only)\n\n```typescript\nimport { createDeepFactorAgent } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n});\n\nconst result = await agent.loop(\"Hello!\");\nconsole.log(result.response);\n```\n\nAll other settings use sensible defaults — see the [Defaults table](#defaults) below.\n\n### Agent with tools and verification\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\nimport { z } from \"zod\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  instructions: \"Use the weather tool to answer weather questions.\",\n  tools: {\n    getWeather: {\n      description: \"Get weather for a city\",\n      parameters: z.object({ city: z.string() }),\n      execute: async ({ city }) => `72°F and sunny in ${city}`,\n    },\n  },\n  stopWhen: [maxIterations(10)],\n  verifyCompletion: async ({ result }) => ({\n    complete: result.includes(\"°F\"),\n    reason: \"Response must contain a temperature\",\n  }),\n});\n\nconst result = await agent.loop(\"What's the weather in Austin?\");\n```\n\n### Stop conditions\n\n```typescript\nimport {\n  createDeepFactorAgent,\n  maxIterations,\n  maxTokens,\n  maxInputTokens,\n  maxOutputTokens,\n  maxCost,\n} from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  stopWhen: [\n    maxIterations(20),          // stop after 20 loop iterations\n    maxTokens(100_000),         // stop at 100k total tokens\n    maxInputTokens(80_000),     // stop at 80k input tokens\n    maxOutputTokens(20_000),    // stop at 20k output tokens\n    maxCost(0.50),              // stop at $0.50 spend\n  ],\n});\n```\n\nMultiple conditions can be combined — the first one that triggers ends the loop.\n\n### Human-in-the-loop\n\n```typescript\nimport {\n  createDeepFactorAgent,\n  requestHumanInput,\n  maxIterations,\n} from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  tools: { requestHumanInput },\n  interruptOn: [\"requestHumanInput\"],\n  stopWhen: [maxIterations(10)],\n});\n\nconst result = await agent.loop(\"Ask the user what color they prefer.\");\n\nif (result.stopReason === \"human_input_needed\") {\n  console.log(\"Agent is waiting for input\");\n\n  // Provide the human's answer and resume the loop\n  const finalResult = await result.resume(\"Blue\");\n  console.log(finalResult.response);\n}\n```\n\n### Middleware\n\n```typescript\nimport {\n  createDeepFactorAgent,\n  todoMiddleware,\n  errorRecoveryMiddleware,\n  maxIterations,\n} from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\n// Built-in middleware (these are the defaults)\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  middleware: [todoMiddleware(), errorRecoveryMiddleware()],\n  stopWhen: [maxIterations(10)],\n});\n```\n\n**Custom middleware:**\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport type { AgentMiddleware } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst loggingMiddleware: AgentMiddleware = {\n  name: \"logging\",\n  beforeIteration: async (ctx) => {\n    console.log(`Starting iteration ${ctx.iteration}`);\n  },\n  afterIteration: async (ctx) => {\n    console.log(`Finished iteration ${ctx.iteration}`);\n  },\n};\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  middleware: [loggingMiddleware],\n  stopWhen: [maxIterations(5)],\n});\n```\n\n### Streaming\n\n```typescript\nimport { createDeepFactorAgent } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n});\n\nconst stream = await agent.stream(\"Tell me a story.\");\n\nfor await (const chunk of stream.textStream) {\n  process.stdout.write(chunk);\n}\n```\n\n### Context management\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  stopWhen: [maxIterations(50)],\n  contextManagement: {\n    maxContextTokens: 100_000,  // summarize when context exceeds this\n    keepRecentIterations: 5,    // always keep the last 5 iterations intact\n  },\n});\n```\n\nWhen the context window fills up, older iterations are automatically summarized by the model so the agent can keep working without losing important history.\n\n## Defaults\n\nWhen using `createDeepFactorAgent`, unspecified settings receive these defaults:\n\n| Setting | Default |\n|---|---|\n| `tools` | `{}` (no tools) |\n| `instructions` | `\"\"` (empty) |\n| `stopWhen` | `[maxIterations(10)]` |\n| `verifyCompletion` | `undefined` (no verification) |\n| `middleware` | `[todoMiddleware(), errorRecoveryMiddleware()]` |\n| `interruptOn` | `[]` (no interruptions) |\n| `contextManagement.maxContextTokens` | `150000` |\n| `contextManagement.keepRecentIterations` | `3` |\n\n## API Reference\n\n### Factory\n\n| Export | Description |\n|---|---|\n| `createDeepFactorAgent(settings)` | Creates a `DeepFactorAgent` with sensible defaults. The primary entry point. |\n\n### Agent Class\n\n| Export | Description |\n|---|---|\n| `DeepFactorAgent` | Core agent class. Use `createDeepFactorAgent` unless you need full control. |\n| `.loop(prompt)` | Run the agentic loop. Returns `AgentResult` or `PendingResult`. |\n| `.stream(prompt)` | Stream the first LLM turn (non-looping). Returns the AI SDK stream result. |\n| `addUsage(a, b)` | Merge two `TokenUsage` objects by summing their fields. |\n\n### Stop Conditions\n\n| Export | Description |\n|---|---|\n| `maxIterations(n)` | Stop after `n` loop iterations. |\n| `maxTokens(n)` | Stop when total tokens reach `n`. |\n| `maxInputTokens(n)` | Stop when input tokens reach `n`. |\n| `maxOutputTokens(n)` | Stop when output tokens reach `n`. |\n| `maxCost(dollars, model?)` | Stop when estimated cost reaches `dollars`. |\n| `calculateCost(usage, model)` | Calculate cost for a given `TokenUsage` and model name. |\n| `MODEL_PRICING` | Built-in pricing table for common models (Anthropic, OpenAI, Google). |\n| `evaluateStopConditions(conditions, ctx)` | Evaluate an array of stop conditions against a context. |\n\n### Middleware\n\n| Export | Description |\n|---|---|\n| `composeMiddleware(middlewares)` | Compose an array of `AgentMiddleware` into a single middleware with merged tools and chained hooks. |\n| `todoMiddleware()` | Built-in middleware that gives the agent `write_todos` and `read_todos` tools. |\n| `errorRecoveryMiddleware()` | Built-in middleware that injects recovery guidance after errors. |\n\n### Context Management\n\n| Export | Description |\n|---|---|\n| `ContextManager` | Manages context window size by summarizing old iterations when the token limit is exceeded. |\n| `estimateTokens(text)` | Approximate token count for a string (~1 token per 3.5 characters). |\n\n### Human-in-the-Loop\n\n| Export | Description |\n|---|---|\n| `requestHumanInput` | A tool that pauses the agent loop to collect human input. Use with `interruptOn: [\"requestHumanInput\"]`. |\n\n### Types\n\nAll types are exported for use in your code:\n\n| Type | Description |\n|---|---|\n| `DeepFactorAgentSettings<TTools>` | Configuration for `createDeepFactorAgent`. |\n| `AgentResult` | Return type of `loop()` — contains `response`, `thread`, `usage`, `iterations`, `stopReason`. |\n| `PendingResult` | Extends `AgentResult` when `stopReason` is `\"human_input_needed\"` — adds `resume(input)`. |\n| `AgentThread` | The conversation thread with `id`, `events`, `metadata`. |\n| `TokenUsage` | Token counts: `inputTokens`, `outputTokens`, `totalTokens`, optional cache fields. |\n| `StopCondition` | A function `(ctx: StopConditionContext) => StopConditionResult`. |\n| `StopConditionContext` | Context passed to stop conditions: `iteration`, `usage`, `model`, `thread`. |\n| `StopConditionResult` | Result from a stop condition: `{ stop: boolean, reason?: string }`. |\n| `VerifyCompletion` | Async function to verify the agent completed its task. |\n| `VerifyContext` | Context passed to `verifyCompletion`: `result`, `iteration`, `thread`, `originalPrompt`. |\n| `VerifyResult` | Result from verification: `{ complete: boolean, reason?: string }`. |\n| `AgentMiddleware` | Middleware definition with `name`, optional `tools`, and lifecycle hooks. |\n| `MiddlewareContext` | Context passed to middleware hooks: `thread`, `iteration`, `settings`. |\n| `ContextManagementConfig` | Config for context management: `maxContextTokens`, `keepRecentIterations`. |\n| `AgentEvent` | Discriminated union of all event types in the thread. |\n\n## Architecture: 12-Factor Agent Alignment\n\nThis library is designed around the [12-factor agent](https://github.com/humanlayer/12-factor-agents) principles:\n\n1. **Natural language to tool calls** — the agent loop translates prompts into tool invocations\n2. **Own your prompts** — `instructions` are plain strings you control, not hidden behind abstractions\n3. **Own your context window** — `ContextManager` gives you explicit control over context size and summarization\n4. **Tools are just functions** — standard Vercel AI SDK tool definitions, no proprietary wrapper\n5. **Unified LLM interface** — any model provider supported by the AI SDK works out of the box\n6. **Use structured outputs** — Zod schemas for tool parameters and validation\n7. **Own your control flow** — the loop, stop conditions, and middleware are all configurable\n8. **Compact errors into context** — `errorRecoveryMiddleware` feeds truncated errors back into the conversation\n9. **Own your threads** — `AgentThread` gives you full access to conversation history and metadata\n10. **Small, focused agents** — the library encourages composing single-purpose agents\n11. **Trigger from anywhere** — `loop()` and `stream()` can be called from any runtime (server, CLI, edge)\n12. **Make agents observable** — thread events, token tracking, and lifecycle callbacks provide full visibility\n\n## Development\n\n```bash\npnpm install        # install dependencies\npnpm build          # compile TypeScript\npnpm test           # run tests (vitest)\npnpm type-check     # type-check without emitting\npnpm dev            # watch mode\n```\n\n## License\n\nMIT\n"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":821,"cache_read_input_tokens":33952,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":821},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"799743e4-c13d-4c18-bf9c-50c235cc257d"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LYX13mjtNcb32EyacN71pp","type":"tool_result","content":"File created successfully at: /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md"}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"dda1dad0-1b8c-4b95-a9f1-77283b14b9a1","tool_use_result":{"type":"create","filePath":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md","content":"# deep-factor-agent\n\nA TypeScript library for building loop-based AI agents with middleware, verification, stop conditions, human-in-the-loop, and context management — aligned with the [12-factor agent](https://github.com/humanlayer/12-factor-agents) methodology.\n\n## Overview\n\n`deep-factor-agent` wraps the [Vercel AI SDK v6](https://sdk.vercel.ai/) in an opinionated agent loop that gives you fine-grained control over iteration limits, cost guardrails, completion verification, context window management, and human escalation — all through a declarative configuration surface.\n\n**Why a loop-based agent?** Single-shot LLM calls are rarely enough for non-trivial tasks. An agentic loop lets the model call tools, observe results, reflect, and iterate until the task is truly done — while stop conditions and middleware keep execution safe and observable.\n\n### Key capabilities\n\n- **Agentic loop** — iterative tool-calling with automatic message history\n- **Stop conditions** — cap iterations, tokens, or dollar cost\n- **Completion verification** — optionally verify the agent actually finished the task\n- **Middleware** — inject tools and lifecycle hooks (built-in: todo tracking, error recovery)\n- **Human-in-the-loop** — pause execution, collect human input, and resume\n- **Context management** — automatic summarization when the context window fills up\n- **Streaming** — stream the first LLM turn for real-time UIs\n\n## Installation\n\n```bash\npnpm add deep-factor-agent ai zod\n```\n\n`ai` (Vercel AI SDK v6+) is a runtime dependency. `zod` (v4+) is a **peer dependency** — you must install it yourself.\n\nYou also need a model provider, e.g.:\n\n```bash\npnpm add @ai-sdk/anthropic\n# or @ai-sdk/openai, @ai-sdk/google, etc.\n```\n\n## Quick Start\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  instructions: \"You are a helpful assistant.\",\n  stopWhen: [maxIterations(5)],\n});\n\nconst result = await agent.loop(\"What is the capital of France?\");\n\nconsole.log(result.response);   // \"The capital of France is Paris.\"\nconsole.log(result.iterations); // number of loop iterations used\nconsole.log(result.usage);      // { inputTokens, outputTokens, totalTokens }\n```\n\n## Usage Examples\n\n### Minimal agent (model only)\n\n```typescript\nimport { createDeepFactorAgent } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n});\n\nconst result = await agent.loop(\"Hello!\");\nconsole.log(result.response);\n```\n\nAll other settings use sensible defaults — see the [Defaults table](#defaults) below.\n\n### Agent with tools and verification\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\nimport { z } from \"zod\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  instructions: \"Use the weather tool to answer weather questions.\",\n  tools: {\n    getWeather: {\n      description: \"Get weather for a city\",\n      parameters: z.object({ city: z.string() }),\n      execute: async ({ city }) => `72°F and sunny in ${city}`,\n    },\n  },\n  stopWhen: [maxIterations(10)],\n  verifyCompletion: async ({ result }) => ({\n    complete: result.includes(\"°F\"),\n    reason: \"Response must contain a temperature\",\n  }),\n});\n\nconst result = await agent.loop(\"What's the weather in Austin?\");\n```\n\n### Stop conditions\n\n```typescript\nimport {\n  createDeepFactorAgent,\n  maxIterations,\n  maxTokens,\n  maxInputTokens,\n  maxOutputTokens,\n  maxCost,\n} from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  stopWhen: [\n    maxIterations(20),          // stop after 20 loop iterations\n    maxTokens(100_000),         // stop at 100k total tokens\n    maxInputTokens(80_000),     // stop at 80k input tokens\n    maxOutputTokens(20_000),    // stop at 20k output tokens\n    maxCost(0.50),              // stop at $0.50 spend\n  ],\n});\n```\n\nMultiple conditions can be combined — the first one that triggers ends the loop.\n\n### Human-in-the-loop\n\n```typescript\nimport {\n  createDeepFactorAgent,\n  requestHumanInput,\n  maxIterations,\n} from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  tools: { requestHumanInput },\n  interruptOn: [\"requestHumanInput\"],\n  stopWhen: [maxIterations(10)],\n});\n\nconst result = await agent.loop(\"Ask the user what color they prefer.\");\n\nif (result.stopReason === \"human_input_needed\") {\n  console.log(\"Agent is waiting for input\");\n\n  // Provide the human's answer and resume the loop\n  const finalResult = await result.resume(\"Blue\");\n  console.log(finalResult.response);\n}\n```\n\n### Middleware\n\n```typescript\nimport {\n  createDeepFactorAgent,\n  todoMiddleware,\n  errorRecoveryMiddleware,\n  maxIterations,\n} from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\n// Built-in middleware (these are the defaults)\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  middleware: [todoMiddleware(), errorRecoveryMiddleware()],\n  stopWhen: [maxIterations(10)],\n});\n```\n\n**Custom middleware:**\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport type { AgentMiddleware } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst loggingMiddleware: AgentMiddleware = {\n  name: \"logging\",\n  beforeIteration: async (ctx) => {\n    console.log(`Starting iteration ${ctx.iteration}`);\n  },\n  afterIteration: async (ctx) => {\n    console.log(`Finished iteration ${ctx.iteration}`);\n  },\n};\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  middleware: [loggingMiddleware],\n  stopWhen: [maxIterations(5)],\n});\n```\n\n### Streaming\n\n```typescript\nimport { createDeepFactorAgent } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n});\n\nconst stream = await agent.stream(\"Tell me a story.\");\n\nfor await (const chunk of stream.textStream) {\n  process.stdout.write(chunk);\n}\n```\n\n### Context management\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  stopWhen: [maxIterations(50)],\n  contextManagement: {\n    maxContextTokens: 100_000,  // summarize when context exceeds this\n    keepRecentIterations: 5,    // always keep the last 5 iterations intact\n  },\n});\n```\n\nWhen the context window fills up, older iterations are automatically summarized by the model so the agent can keep working without losing important history.\n\n## Defaults\n\nWhen using `createDeepFactorAgent`, unspecified settings receive these defaults:\n\n| Setting | Default |\n|---|---|\n| `tools` | `{}` (no tools) |\n| `instructions` | `\"\"` (empty) |\n| `stopWhen` | `[maxIterations(10)]` |\n| `verifyCompletion` | `undefined` (no verification) |\n| `middleware` | `[todoMiddleware(), errorRecoveryMiddleware()]` |\n| `interruptOn` | `[]` (no interruptions) |\n| `contextManagement.maxContextTokens` | `150000` |\n| `contextManagement.keepRecentIterations` | `3` |\n\n## API Reference\n\n### Factory\n\n| Export | Description |\n|---|---|\n| `createDeepFactorAgent(settings)` | Creates a `DeepFactorAgent` with sensible defaults. The primary entry point. |\n\n### Agent Class\n\n| Export | Description |\n|---|---|\n| `DeepFactorAgent` | Core agent class. Use `createDeepFactorAgent` unless you need full control. |\n| `.loop(prompt)` | Run the agentic loop. Returns `AgentResult` or `PendingResult`. |\n| `.stream(prompt)` | Stream the first LLM turn (non-looping). Returns the AI SDK stream result. |\n| `addUsage(a, b)` | Merge two `TokenUsage` objects by summing their fields. |\n\n### Stop Conditions\n\n| Export | Description |\n|---|---|\n| `maxIterations(n)` | Stop after `n` loop iterations. |\n| `maxTokens(n)` | Stop when total tokens reach `n`. |\n| `maxInputTokens(n)` | Stop when input tokens reach `n`. |\n| `maxOutputTokens(n)` | Stop when output tokens reach `n`. |\n| `maxCost(dollars, model?)` | Stop when estimated cost reaches `dollars`. |\n| `calculateCost(usage, model)` | Calculate cost for a given `TokenUsage` and model name. |\n| `MODEL_PRICING` | Built-in pricing table for common models (Anthropic, OpenAI, Google). |\n| `evaluateStopConditions(conditions, ctx)` | Evaluate an array of stop conditions against a context. |\n\n### Middleware\n\n| Export | Description |\n|---|---|\n| `composeMiddleware(middlewares)` | Compose an array of `AgentMiddleware` into a single middleware with merged tools and chained hooks. |\n| `todoMiddleware()` | Built-in middleware that gives the agent `write_todos` and `read_todos` tools. |\n| `errorRecoveryMiddleware()` | Built-in middleware that injects recovery guidance after errors. |\n\n### Context Management\n\n| Export | Description |\n|---|---|\n| `ContextManager` | Manages context window size by summarizing old iterations when the token limit is exceeded. |\n| `estimateTokens(text)` | Approximate token count for a string (~1 token per 3.5 characters). |\n\n### Human-in-the-Loop\n\n| Export | Description |\n|---|---|\n| `requestHumanInput` | A tool that pauses the agent loop to collect human input. Use with `interruptOn: [\"requestHumanInput\"]`. |\n\n### Types\n\nAll types are exported for use in your code:\n\n| Type | Description |\n|---|---|\n| `DeepFactorAgentSettings<TTools>` | Configuration for `createDeepFactorAgent`. |\n| `AgentResult` | Return type of `loop()` — contains `response`, `thread`, `usage`, `iterations`, `stopReason`. |\n| `PendingResult` | Extends `AgentResult` when `stopReason` is `\"human_input_needed\"` — adds `resume(input)`. |\n| `AgentThread` | The conversation thread with `id`, `events`, `metadata`. |\n| `TokenUsage` | Token counts: `inputTokens`, `outputTokens`, `totalTokens`, optional cache fields. |\n| `StopCondition` | A function `(ctx: StopConditionContext) => StopConditionResult`. |\n| `StopConditionContext` | Context passed to stop conditions: `iteration`, `usage`, `model`, `thread`. |\n| `StopConditionResult` | Result from a stop condition: `{ stop: boolean, reason?: string }`. |\n| `VerifyCompletion` | Async function to verify the agent completed its task. |\n| `VerifyContext` | Context passed to `verifyCompletion`: `result`, `iteration`, `thread`, `originalPrompt`. |\n| `VerifyResult` | Result from verification: `{ complete: boolean, reason?: string }`. |\n| `AgentMiddleware` | Middleware definition with `name`, optional `tools`, and lifecycle hooks. |\n| `MiddlewareContext` | Context passed to middleware hooks: `thread`, `iteration`, `settings`. |\n| `ContextManagementConfig` | Config for context management: `maxContextTokens`, `keepRecentIterations`. |\n| `AgentEvent` | Discriminated union of all event types in the thread. |\n\n## Architecture: 12-Factor Agent Alignment\n\nThis library is designed around the [12-factor agent](https://github.com/humanlayer/12-factor-agents) principles:\n\n1. **Natural language to tool calls** — the agent loop translates prompts into tool invocations\n2. **Own your prompts** — `instructions` are plain strings you control, not hidden behind abstractions\n3. **Own your context window** — `ContextManager` gives you explicit control over context size and summarization\n4. **Tools are just functions** — standard Vercel AI SDK tool definitions, no proprietary wrapper\n5. **Unified LLM interface** — any model provider supported by the AI SDK works out of the box\n6. **Use structured outputs** — Zod schemas for tool parameters and validation\n7. **Own your control flow** — the loop, stop conditions, and middleware are all configurable\n8. **Compact errors into context** — `errorRecoveryMiddleware` feeds truncated errors back into the conversation\n9. **Own your threads** — `AgentThread` gives you full access to conversation history and metadata\n10. **Small, focused agents** — the library encourages composing single-purpose agents\n11. **Trigger from anywhere** — `loop()` and `stream()` can be called from any runtime (server, CLI, edge)\n12. **Make agents observable** — thread events, token tracking, and lifecycle callbacks provide full visibility\n\n## Development\n\n```bash\npnpm install        # install dependencies\npnpm build          # compile TypeScript\npnpm test           # run tests (vitest)\npnpm type-check     # type-check without emitting\npnpm dev            # watch mode\n```\n\n## License\n\nMIT\n","structuredPatch":[],"originalFile":null}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_017ouELjMPh34rUCHfF6ShzR","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me verify the code examples compile against the actual public API."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":3875,"cache_read_input_tokens":34773,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":3875},"output_tokens":3,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"4608f6bd-ed95-4b6f-a3e0-fde3b6086403"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_017ouELjMPh34rUCHfF6ShzR","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01N3dPawNfFr2nHLKHZi4taK","name":"TodoWrite","input":{"todos":[{"content":"Study specs and source code","status":"completed","activeForm":"Studying specs and source code"},{"content":"Author README.md per spec 01-setup-readme.md","status":"completed","activeForm":"Authoring README.md"},{"content":"Verify README code examples compile against public API","status":"in_progress","activeForm":"Verifying README code examples"},{"content":"Update IMPLEMENTATION_PLAN.md and commit/push","status":"pending","activeForm":"Updating plan and committing"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":3875,"cache_read_input_tokens":34773,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":3875},"output_tokens":3,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"c87d6118-fc70-4931-ae95-1ba404ab8177"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01N3dPawNfFr2nHLKHZi4taK","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"3fad9c58-bddb-4398-814c-c652747184f8","tool_use_result":{"oldTodos":[{"content":"Study specs and source code","status":"completed","activeForm":"Studying specs and source code"},{"content":"Author README.md per spec 01-setup-readme.md","status":"in_progress","activeForm":"Authoring README.md"},{"content":"Verify README code examples compile against public API","status":"pending","activeForm":"Verifying README code examples"},{"content":"Update IMPLEMENTATION_PLAN.md and commit/push","status":"pending","activeForm":"Updating plan and committing"}],"newTodos":[{"content":"Study specs and source code","status":"completed","activeForm":"Studying specs and source code"},{"content":"Author README.md per spec 01-setup-readme.md","status":"completed","activeForm":"Authoring README.md"},{"content":"Verify README code examples compile against public API","status":"in_progress","activeForm":"Verifying README code examples"},{"content":"Update IMPLEMENTATION_PLAN.md and commit/push","status":"pending","activeForm":"Updating plan and committing"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01SE5kBQ9QDfTsg15CPQTVwe","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","name":"Task","input":{"description":"Verify README examples compile","prompt":"You are verifying that the README code examples for the `deep-factor-agent` library use the correct public API. \n\nRead /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md and cross-reference every import, function call, and type name against the actual source files:\n\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/index.ts (barrel exports)\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/create-agent.ts (factory)\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/agent.ts (DeepFactorAgent class)\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/stop-conditions.ts\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/middleware.ts\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/human-in-the-loop.ts\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/types.ts\n\nCheck for:\n1. All imports reference names that are actually exported from src/index.ts\n2. Function signatures match (parameter names, types, return types)\n3. Settings object properties match DeepFactorAgentSettings interface\n4. Type names are correct\n5. The `stream()` method returns the correct type/shape (check what streamText returns in the agent.ts)\n6. The `requestHumanInput` is used correctly (it's a tool object, not a function call)\n7. The `resume()` method exists on PendingResult\n8. `AgentMiddleware` type has the correct shape (name, beforeIteration, afterIteration)\n\nReport any mismatches or errors you find. Be thorough.","subagent_type":"general-purpose","model":"opus"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":247,"cache_read_input_tokens":38648,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":247},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"a14fcf26-fdcf-4b89-afb8-348e3f2900d7"}
{"type":"user","message":{"role":"user","content":[{"type":"text","text":"You are verifying that the README code examples for the `deep-factor-agent` library use the correct public API. \n\nRead /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md and cross-reference every import, function call, and type name against the actual source files:\n\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/index.ts (barrel exports)\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/create-agent.ts (factory)\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/agent.ts (DeepFactorAgent class)\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/stop-conditions.ts\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/middleware.ts\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/human-in-the-loop.ts\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/types.ts\n\nCheck for:\n1. All imports reference names that are actually exported from src/index.ts\n2. Function signatures match (parameter names, types, return types)\n3. Settings object properties match DeepFactorAgentSettings interface\n4. Type names are correct\n5. The `stream()` method returns the correct type/shape (check what streamText returns in the agent.ts)\n6. The `requestHumanInput` is used correctly (it's a tool object, not a function call)\n7. The `resume()` method exists on PendingResult\n8. `AgentMiddleware` type has the correct shape (name, beforeIteration, afterIteration)\n\nReport any mismatches or errors you find. Be thorough."}]},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"8f38e853-b09b-4522-be17-aa55fbccc305"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01QdSD6rBHJvfpGW7iEDtidw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BcHcQsufHa5CghQw8b5Nou","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":1736,"cache_read_input_tokens":10745,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1736},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"f4aa9bab-d292-40ed-9dd3-96155d3f1b0e"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BcHcQsufHa5CghQw8b5Nou","type":"tool_result","content":"     1→# deep-factor-agent\n     2→\n     3→A TypeScript library for building loop-based AI agents with middleware, verification, stop conditions, human-in-the-loop, and context management — aligned with the [12-factor agent](https://github.com/humanlayer/12-factor-agents) methodology.\n     4→\n     5→## Overview\n     6→\n     7→`deep-factor-agent` wraps the [Vercel AI SDK v6](https://sdk.vercel.ai/) in an opinionated agent loop that gives you fine-grained control over iteration limits, cost guardrails, completion verification, context window management, and human escalation — all through a declarative configuration surface.\n     8→\n     9→**Why a loop-based agent?** Single-shot LLM calls are rarely enough for non-trivial tasks. An agentic loop lets the model call tools, observe results, reflect, and iterate until the task is truly done — while stop conditions and middleware keep execution safe and observable.\n    10→\n    11→### Key capabilities\n    12→\n    13→- **Agentic loop** — iterative tool-calling with automatic message history\n    14→- **Stop conditions** — cap iterations, tokens, or dollar cost\n    15→- **Completion verification** — optionally verify the agent actually finished the task\n    16→- **Middleware** — inject tools and lifecycle hooks (built-in: todo tracking, error recovery)\n    17→- **Human-in-the-loop** — pause execution, collect human input, and resume\n    18→- **Context management** — automatic summarization when the context window fills up\n    19→- **Streaming** — stream the first LLM turn for real-time UIs\n    20→\n    21→## Installation\n    22→\n    23→```bash\n    24→pnpm add deep-factor-agent ai zod\n    25→```\n    26→\n    27→`ai` (Vercel AI SDK v6+) is a runtime dependency. `zod` (v4+) is a **peer dependency** — you must install it yourself.\n    28→\n    29→You also need a model provider, e.g.:\n    30→\n    31→```bash\n    32→pnpm add @ai-sdk/anthropic\n    33→# or @ai-sdk/openai, @ai-sdk/google, etc.\n    34→```\n    35→\n    36→## Quick Start\n    37→\n    38→```typescript\n    39→import { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\n    40→import { anthropic } from \"@ai-sdk/anthropic\";\n    41→\n    42→const agent = createDeepFactorAgent({\n    43→  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n    44→  instructions: \"You are a helpful assistant.\",\n    45→  stopWhen: [maxIterations(5)],\n    46→});\n    47→\n    48→const result = await agent.loop(\"What is the capital of France?\");\n    49→\n    50→console.log(result.response);   // \"The capital of France is Paris.\"\n    51→console.log(result.iterations); // number of loop iterations used\n    52→console.log(result.usage);      // { inputTokens, outputTokens, totalTokens }\n    53→```\n    54→\n    55→## Usage Examples\n    56→\n    57→### Minimal agent (model only)\n    58→\n    59→```typescript\n    60→import { createDeepFactorAgent } from \"deep-factor-agent\";\n    61→import { anthropic } from \"@ai-sdk/anthropic\";\n    62→\n    63→const agent = createDeepFactorAgent({\n    64→  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n    65→});\n    66→\n    67→const result = await agent.loop(\"Hello!\");\n    68→console.log(result.response);\n    69→```\n    70→\n    71→All other settings use sensible defaults — see the [Defaults table](#defaults) below.\n    72→\n    73→### Agent with tools and verification\n    74→\n    75→```typescript\n    76→import { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\n    77→import { anthropic } from \"@ai-sdk/anthropic\";\n    78→import { z } from \"zod\";\n    79→\n    80→const agent = createDeepFactorAgent({\n    81→  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n    82→  instructions: \"Use the weather tool to answer weather questions.\",\n    83→  tools: {\n    84→    getWeather: {\n    85→      description: \"Get weather for a city\",\n    86→      parameters: z.object({ city: z.string() }),\n    87→      execute: async ({ city }) => `72°F and sunny in ${city}`,\n    88→    },\n    89→  },\n    90→  stopWhen: [maxIterations(10)],\n    91→  verifyCompletion: async ({ result }) => ({\n    92→    complete: result.includes(\"°F\"),\n    93→    reason: \"Response must contain a temperature\",\n    94→  }),\n    95→});\n    96→\n    97→const result = await agent.loop(\"What's the weather in Austin?\");\n    98→```\n    99→\n   100→### Stop conditions\n   101→\n   102→```typescript\n   103→import {\n   104→  createDeepFactorAgent,\n   105→  maxIterations,\n   106→  maxTokens,\n   107→  maxInputTokens,\n   108→  maxOutputTokens,\n   109→  maxCost,\n   110→} from \"deep-factor-agent\";\n   111→import { anthropic } from \"@ai-sdk/anthropic\";\n   112→\n   113→const agent = createDeepFactorAgent({\n   114→  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n   115→  stopWhen: [\n   116→    maxIterations(20),          // stop after 20 loop iterations\n   117→    maxTokens(100_000),         // stop at 100k total tokens\n   118→    maxInputTokens(80_000),     // stop at 80k input tokens\n   119→    maxOutputTokens(20_000),    // stop at 20k output tokens\n   120→    maxCost(0.50),              // stop at $0.50 spend\n   121→  ],\n   122→});\n   123→```\n   124→\n   125→Multiple conditions can be combined — the first one that triggers ends the loop.\n   126→\n   127→### Human-in-the-loop\n   128→\n   129→```typescript\n   130→import {\n   131→  createDeepFactorAgent,\n   132→  requestHumanInput,\n   133→  maxIterations,\n   134→} from \"deep-factor-agent\";\n   135→import { anthropic } from \"@ai-sdk/anthropic\";\n   136→\n   137→const agent = createDeepFactorAgent({\n   138→  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n   139→  tools: { requestHumanInput },\n   140→  interruptOn: [\"requestHumanInput\"],\n   141→  stopWhen: [maxIterations(10)],\n   142→});\n   143→\n   144→const result = await agent.loop(\"Ask the user what color they prefer.\");\n   145→\n   146→if (result.stopReason === \"human_input_needed\") {\n   147→  console.log(\"Agent is waiting for input\");\n   148→\n   149→  // Provide the human's answer and resume the loop\n   150→  const finalResult = await result.resume(\"Blue\");\n   151→  console.log(finalResult.response);\n   152→}\n   153→```\n   154→\n   155→### Middleware\n   156→\n   157→```typescript\n   158→import {\n   159→  createDeepFactorAgent,\n   160→  todoMiddleware,\n   161→  errorRecoveryMiddleware,\n   162→  maxIterations,\n   163→} from \"deep-factor-agent\";\n   164→import { anthropic } from \"@ai-sdk/anthropic\";\n   165→\n   166→// Built-in middleware (these are the defaults)\n   167→const agent = createDeepFactorAgent({\n   168→  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n   169→  middleware: [todoMiddleware(), errorRecoveryMiddleware()],\n   170→  stopWhen: [maxIterations(10)],\n   171→});\n   172→```\n   173→\n   174→**Custom middleware:**\n   175→\n   176→```typescript\n   177→import { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\n   178→import type { AgentMiddleware } from \"deep-factor-agent\";\n   179→import { anthropic } from \"@ai-sdk/anthropic\";\n   180→\n   181→const loggingMiddleware: AgentMiddleware = {\n   182→  name: \"logging\",\n   183→  beforeIteration: async (ctx) => {\n   184→    console.log(`Starting iteration ${ctx.iteration}`);\n   185→  },\n   186→  afterIteration: async (ctx) => {\n   187→    console.log(`Finished iteration ${ctx.iteration}`);\n   188→  },\n   189→};\n   190→\n   191→const agent = createDeepFactorAgent({\n   192→  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n   193→  middleware: [loggingMiddleware],\n   194→  stopWhen: [maxIterations(5)],\n   195→});\n   196→```\n   197→\n   198→### Streaming\n   199→\n   200→```typescript\n   201→import { createDeepFactorAgent } from \"deep-factor-agent\";\n   202→import { anthropic } from \"@ai-sdk/anthropic\";\n   203→\n   204→const agent = createDeepFactorAgent({\n   205→  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n   206→});\n   207→\n   208→const stream = await agent.stream(\"Tell me a story.\");\n   209→\n   210→for await (const chunk of stream.textStream) {\n   211→  process.stdout.write(chunk);\n   212→}\n   213→```\n   214→\n   215→### Context management\n   216→\n   217→```typescript\n   218→import { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\n   219→import { anthropic } from \"@ai-sdk/anthropic\";\n   220→\n   221→const agent = createDeepFactorAgent({\n   222→  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n   223→  stopWhen: [maxIterations(50)],\n   224→  contextManagement: {\n   225→    maxContextTokens: 100_000,  // summarize when context exceeds this\n   226→    keepRecentIterations: 5,    // always keep the last 5 iterations intact\n   227→  },\n   228→});\n   229→```\n   230→\n   231→When the context window fills up, older iterations are automatically summarized by the model so the agent can keep working without losing important history.\n   232→\n   233→## Defaults\n   234→\n   235→When using `createDeepFactorAgent`, unspecified settings receive these defaults:\n   236→\n   237→| Setting | Default |\n   238→|---|---|\n   239→| `tools` | `{}` (no tools) |\n   240→| `instructions` | `\"\"` (empty) |\n   241→| `stopWhen` | `[maxIterations(10)]` |\n   242→| `verifyCompletion` | `undefined` (no verification) |\n   243→| `middleware` | `[todoMiddleware(), errorRecoveryMiddleware()]` |\n   244→| `interruptOn` | `[]` (no interruptions) |\n   245→| `contextManagement.maxContextTokens` | `150000` |\n   246→| `contextManagement.keepRecentIterations` | `3` |\n   247→\n   248→## API Reference\n   249→\n   250→### Factory\n   251→\n   252→| Export | Description |\n   253→|---|---|\n   254→| `createDeepFactorAgent(settings)` | Creates a `DeepFactorAgent` with sensible defaults. The primary entry point. |\n   255→\n   256→### Agent Class\n   257→\n   258→| Export | Description |\n   259→|---|---|\n   260→| `DeepFactorAgent` | Core agent class. Use `createDeepFactorAgent` unless you need full control. |\n   261→| `.loop(prompt)` | Run the agentic loop. Returns `AgentResult` or `PendingResult`. |\n   262→| `.stream(prompt)` | Stream the first LLM turn (non-looping). Returns the AI SDK stream result. |\n   263→| `addUsage(a, b)` | Merge two `TokenUsage` objects by summing their fields. |\n   264→\n   265→### Stop Conditions\n   266→\n   267→| Export | Description |\n   268→|---|---|\n   269→| `maxIterations(n)` | Stop after `n` loop iterations. |\n   270→| `maxTokens(n)` | Stop when total tokens reach `n`. |\n   271→| `maxInputTokens(n)` | Stop when input tokens reach `n`. |\n   272→| `maxOutputTokens(n)` | Stop when output tokens reach `n`. |\n   273→| `maxCost(dollars, model?)` | Stop when estimated cost reaches `dollars`. |\n   274→| `calculateCost(usage, model)` | Calculate cost for a given `TokenUsage` and model name. |\n   275→| `MODEL_PRICING` | Built-in pricing table for common models (Anthropic, OpenAI, Google). |\n   276→| `evaluateStopConditions(conditions, ctx)` | Evaluate an array of stop conditions against a context. |\n   277→\n   278→### Middleware\n   279→\n   280→| Export | Description |\n   281→|---|---|\n   282→| `composeMiddleware(middlewares)` | Compose an array of `AgentMiddleware` into a single middleware with merged tools and chained hooks. |\n   283→| `todoMiddleware()` | Built-in middleware that gives the agent `write_todos` and `read_todos` tools. |\n   284→| `errorRecoveryMiddleware()` | Built-in middleware that injects recovery guidance after errors. |\n   285→\n   286→### Context Management\n   287→\n   288→| Export | Description |\n   289→|---|---|\n   290→| `ContextManager` | Manages context window size by summarizing old iterations when the token limit is exceeded. |\n   291→| `estimateTokens(text)` | Approximate token count for a string (~1 token per 3.5 characters). |\n   292→\n   293→### Human-in-the-Loop\n   294→\n   295→| Export | Description |\n   296→|---|---|\n   297→| `requestHumanInput` | A tool that pauses the agent loop to collect human input. Use with `interruptOn: [\"requestHumanInput\"]`. |\n   298→\n   299→### Types\n   300→\n   301→All types are exported for use in your code:\n   302→\n   303→| Type | Description |\n   304→|---|---|\n   305→| `DeepFactorAgentSettings<TTools>` | Configuration for `createDeepFactorAgent`. |\n   306→| `AgentResult` | Return type of `loop()` — contains `response`, `thread`, `usage`, `iterations`, `stopReason`. |\n   307→| `PendingResult` | Extends `AgentResult` when `stopReason` is `\"human_input_needed\"` — adds `resume(input)`. |\n   308→| `AgentThread` | The conversation thread with `id`, `events`, `metadata`. |\n   309→| `TokenUsage` | Token counts: `inputTokens`, `outputTokens`, `totalTokens`, optional cache fields. |\n   310→| `StopCondition` | A function `(ctx: StopConditionContext) => StopConditionResult`. |\n   311→| `StopConditionContext` | Context passed to stop conditions: `iteration`, `usage`, `model`, `thread`. |\n   312→| `StopConditionResult` | Result from a stop condition: `{ stop: boolean, reason?: string }`. |\n   313→| `VerifyCompletion` | Async function to verify the agent completed its task. |\n   314→| `VerifyContext` | Context passed to `verifyCompletion`: `result`, `iteration`, `thread`, `originalPrompt`. |\n   315→| `VerifyResult` | Result from verification: `{ complete: boolean, reason?: string }`. |\n   316→| `AgentMiddleware` | Middleware definition with `name`, optional `tools`, and lifecycle hooks. |\n   317→| `MiddlewareContext` | Context passed to middleware hooks: `thread`, `iteration`, `settings`. |\n   318→| `ContextManagementConfig` | Config for context management: `maxContextTokens`, `keepRecentIterations`. |\n   319→| `AgentEvent` | Discriminated union of all event types in the thread. |\n   320→\n   321→## Architecture: 12-Factor Agent Alignment\n   322→\n   323→This library is designed around the [12-factor agent](https://github.com/humanlayer/12-factor-agents) principles:\n   324→\n   325→1. **Natural language to tool calls** — the agent loop translates prompts into tool invocations\n   326→2. **Own your prompts** — `instructions` are plain strings you control, not hidden behind abstractions\n   327→3. **Own your context window** — `ContextManager` gives you explicit control over context size and summarization\n   328→4. **Tools are just functions** — standard Vercel AI SDK tool definitions, no proprietary wrapper\n   329→5. **Unified LLM interface** — any model provider supported by the AI SDK works out of the box\n   330→6. **Use structured outputs** — Zod schemas for tool parameters and validation\n   331→7. **Own your control flow** — the loop, stop conditions, and middleware are all configurable\n   332→8. **Compact errors into context** — `errorRecoveryMiddleware` feeds truncated errors back into the conversation\n   333→9. **Own your threads** — `AgentThread` gives you full access to conversation history and metadata\n   334→10. **Small, focused agents** — the library encourages composing single-purpose agents\n   335→11. **Trigger from anywhere** — `loop()` and `stream()` can be called from any runtime (server, CLI, edge)\n   336→12. **Make agents observable** — thread events, token tracking, and lifecycle callbacks provide full visibility\n   337→\n   338→## Development\n   339→\n   340→```bash\n   341→pnpm install        # install dependencies\n   342→pnpm build          # compile TypeScript\n   343→pnpm test           # run tests (vitest)\n   344→pnpm type-check     # type-check without emitting\n   345→pnpm dev            # watch mode\n   346→```\n   347→\n   348→## License\n   349→\n   350→MIT\n   351→"}]},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"76f29ff4-9eeb-41b8-8d70-6b24cff59413"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01QdSD6rBHJvfpGW7iEDtidw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KC7jsL3ugPyK3LgPp33aaT","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/index.ts"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":1736,"cache_read_input_tokens":10745,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1736},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"d48b159e-a932-4f41-8213-f0e29f96dc22"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KC7jsL3ugPyK3LgPp33aaT","type":"tool_result","content":"     1→// Types\n     2→export type {\n     3→  AgentEventType,\n     4→  BaseEvent,\n     5→  ToolCallEvent,\n     6→  ToolResultEvent,\n     7→  ErrorEvent,\n     8→  HumanInputRequestedEvent,\n     9→  HumanInputReceivedEvent,\n    10→  MessageEvent,\n    11→  CompletionEvent,\n    12→  SummaryEvent,\n    13→  AgentEvent,\n    14→  AgentThread,\n    15→  TokenUsage,\n    16→  StopConditionContext,\n    17→  StopConditionResult,\n    18→  StopCondition,\n    19→  VerifyContext,\n    20→  VerifyResult,\n    21→  VerifyCompletion,\n    22→  ContextManagementConfig,\n    23→  MiddlewareContext,\n    24→  AgentMiddleware,\n    25→  DeepFactorAgentSettings,\n    26→  AgentResult,\n    27→  PendingResult,\n    28→} from \"./types.js\";\n    29→\n    30→// Stop conditions\n    31→export {\n    32→  maxIterations,\n    33→  maxTokens,\n    34→  maxInputTokens,\n    35→  maxOutputTokens,\n    36→  maxCost,\n    37→  calculateCost,\n    38→  MODEL_PRICING,\n    39→  evaluateStopConditions,\n    40→} from \"./stop-conditions.js\";\n    41→\n    42→// Middleware\n    43→export {\n    44→  composeMiddleware,\n    45→  todoMiddleware,\n    46→  errorRecoveryMiddleware,\n    47→} from \"./middleware.js\";\n    48→\n    49→// Context management\n    50→export { ContextManager, estimateTokens } from \"./context-manager.js\";\n    51→\n    52→// Agent\n    53→export { DeepFactorAgent, addUsage } from \"./agent.js\";\n    54→\n    55→// Factory\n    56→export { createDeepFactorAgent } from \"./create-agent.js\";\n    57→\n    58→// Human-in-the-loop\n    59→export { requestHumanInput } from \"./human-in-the-loop.js\";\n    60→"}]},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"7c3a5613-dbe4-46be-8c95-99fdba49ea71"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01QdSD6rBHJvfpGW7iEDtidw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UTXxxAfcA6jLFAqruZy8kH","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/create-agent.ts"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":1736,"cache_read_input_tokens":10745,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1736},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"3cf67286-8760-4652-9873-98fd485153d6"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UTXxxAfcA6jLFAqruZy8kH","type":"tool_result","content":"     1→import type { ToolSet } from \"ai\";\n     2→import { DeepFactorAgent } from \"./agent.js\";\n     3→import { maxIterations } from \"./stop-conditions.js\";\n     4→import { todoMiddleware, errorRecoveryMiddleware } from \"./middleware.js\";\n     5→import type { DeepFactorAgentSettings } from \"./types.js\";\n     6→\n     7→export function createDeepFactorAgent<\n     8→  TTools extends ToolSet = ToolSet,\n     9→>(settings: DeepFactorAgentSettings<TTools>): DeepFactorAgent<TTools> {\n    10→  const resolvedSettings: DeepFactorAgentSettings<TTools> = {\n    11→    ...settings,\n    12→    tools: settings.tools ?? ({} as TTools),\n    13→    instructions: settings.instructions ?? \"\",\n    14→    stopWhen: settings.stopWhen ?? [maxIterations(10)],\n    15→    verifyCompletion: settings.verifyCompletion,\n    16→    middleware: settings.middleware ?? [\n    17→      todoMiddleware(),\n    18→      errorRecoveryMiddleware(),\n    19→    ],\n    20→    interruptOn: settings.interruptOn ?? [],\n    21→    contextManagement: {\n    22→      maxContextTokens: 150000,\n    23→      keepRecentIterations: 3,\n    24→      ...settings.contextManagement,\n    25→    },\n    26→  };\n    27→\n    28→  return new DeepFactorAgent(resolvedSettings);\n    29→}\n    30→"}]},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"a1b665e6-a015-4223-a16f-4c7214e5b5f1"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01QdSD6rBHJvfpGW7iEDtidw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WVQXjcNqws2qmrmyhKGtLY","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/agent.ts"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":1736,"cache_read_input_tokens":10745,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1736},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"f9d1584f-0d3c-44b3-9651-68030c6db229"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WVQXjcNqws2qmrmyhKGtLY","type":"tool_result","content":"     1→import type { LanguageModel, ToolSet } from \"ai\";\n     2→import { generateText, streamText, stepCountIs } from \"ai\";\n     3→import type { ModelMessage } from \"@ai-sdk/provider-utils\";\n     4→import { composeMiddleware } from \"./middleware.js\";\n     5→import type { ComposedMiddleware } from \"./middleware.js\";\n     6→import { evaluateStopConditions } from \"./stop-conditions.js\";\n     7→import { ContextManager } from \"./context-manager.js\";\n     8→import type {\n     9→  AgentThread,\n    10→  AgentResult,\n    11→  PendingResult,\n    12→  TokenUsage,\n    13→  StopCondition,\n    14→  DeepFactorAgentSettings,\n    15→  ToolCallEvent,\n    16→  ToolResultEvent,\n    17→  MessageEvent as AgentMessageEvent,\n    18→  ErrorEvent,\n    19→  CompletionEvent,\n    20→  HumanInputRequestedEvent,\n    21→  HumanInputReceivedEvent,\n    22→  AgentMiddleware,\n    23→  MiddlewareContext,\n    24→} from \"./types.js\";\n    25→\n    26→let threadCounter = 0;\n    27→\n    28→function createThreadId(): string {\n    29→  return `thread_${Date.now()}_${++threadCounter}`;\n    30→}\n    31→\n    32→export function addUsage(a: TokenUsage, b: TokenUsage): TokenUsage {\n    33→  return {\n    34→    inputTokens: a.inputTokens + b.inputTokens,\n    35→    outputTokens: a.outputTokens + b.outputTokens,\n    36→    totalTokens: a.totalTokens + b.totalTokens,\n    37→    cacheReadTokens:\n    38→      (a.cacheReadTokens ?? 0) + (b.cacheReadTokens ?? 0) || undefined,\n    39→    cacheWriteTokens:\n    40→      (a.cacheWriteTokens ?? 0) + (b.cacheWriteTokens ?? 0) || undefined,\n    41→  };\n    42→}\n    43→\n    44→function extractUsage(sdkUsage: {\n    45→  inputTokens?: number | undefined;\n    46→  outputTokens?: number | undefined;\n    47→  totalTokens?: number | undefined;\n    48→  inputTokenDetails?: {\n    49→    cacheReadTokens?: number | undefined;\n    50→    cacheWriteTokens?: number | undefined;\n    51→  };\n    52→}): TokenUsage {\n    53→  return {\n    54→    inputTokens: sdkUsage.inputTokens ?? 0,\n    55→    outputTokens: sdkUsage.outputTokens ?? 0,\n    56→    totalTokens: sdkUsage.totalTokens ?? 0,\n    57→    cacheReadTokens:\n    58→      sdkUsage.inputTokenDetails?.cacheReadTokens ?? undefined,\n    59→    cacheWriteTokens:\n    60→      sdkUsage.inputTokenDetails?.cacheWriteTokens ?? undefined,\n    61→  };\n    62→}\n    63→\n    64→function compactError(error: unknown, maxLen = 500): string {\n    65→  const msg =\n    66→    error instanceof Error\n    67→      ? `${error.name}: ${error.message}`\n    68→      : String(error);\n    69→  return msg.length > maxLen ? msg.substring(0, maxLen) + \"...\" : msg;\n    70→}\n    71→\n    72→function createThread(): AgentThread {\n    73→  const now = Date.now();\n    74→  return {\n    75→    id: createThreadId(),\n    76→    events: [],\n    77→    metadata: {},\n    78→    createdAt: now,\n    79→    updatedAt: now,\n    80→  };\n    81→}\n    82→\n    83→export class DeepFactorAgent<TTools extends ToolSet = ToolSet> {\n    84→  private model: LanguageModel;\n    85→  private tools: TTools;\n    86→  private instructions: string;\n    87→  private stopConditions: StopCondition[];\n    88→  private verifyCompletion: DeepFactorAgentSettings[\"verifyCompletion\"];\n    89→  private composedMiddleware: ComposedMiddleware;\n    90→  private interruptOn: string[];\n    91→  private contextManager: ContextManager;\n    92→  private onIterationStart?: (iteration: number) => void;\n    93→  private onIterationEnd?: (iteration: number, result: unknown) => void;\n    94→  private modelId: string;\n    95→\n    96→  constructor(settings: DeepFactorAgentSettings<TTools>) {\n    97→    if (typeof settings.model === \"string\") {\n    98→      throw new Error(\n    99→        \"String model IDs are not supported. Please pass a LanguageModel instance.\",\n   100→      );\n   101→    }\n   102→    this.model = settings.model;\n   103→    this.modelId =\n   104→      typeof settings.model === \"object\" &&\n   105→      \"modelId\" in settings.model\n   106→        ? settings.model.modelId\n   107→        : \"unknown\";\n   108→    this.tools = (settings.tools ?? {}) as TTools;\n   109→    this.instructions = settings.instructions ?? \"\";\n   110→    this.verifyCompletion = settings.verifyCompletion;\n   111→    this.interruptOn = settings.interruptOn ?? [];\n   112→    this.onIterationStart = settings.onIterationStart;\n   113→    this.onIterationEnd = settings.onIterationEnd;\n   114→\n   115→    // Normalize stopWhen\n   116→    if (!settings.stopWhen) {\n   117→      this.stopConditions = [];\n   118→    } else if (Array.isArray(settings.stopWhen)) {\n   119→      this.stopConditions = settings.stopWhen;\n   120→    } else {\n   121→      this.stopConditions = [settings.stopWhen];\n   122→    }\n   123→\n   124→    // Compose middleware\n   125→    const middlewareList: AgentMiddleware[] = settings.middleware ?? [];\n   126→    this.composedMiddleware = composeMiddleware(middlewareList);\n   127→\n   128→    // Context management\n   129→    this.contextManager = new ContextManager(settings.contextManagement);\n   130→  }\n   131→\n   132→  private buildMessages(thread: AgentThread): {\n   133→    system: string | undefined;\n   134→    messages: ModelMessage[];\n   135→  } {\n   136→    const messages: ModelMessage[] = [];\n   137→\n   138→    // Build context injection from summaries\n   139→    const contextInjection =\n   140→      this.contextManager.buildContextInjection(thread);\n   141→    let system: string | undefined;\n   142→    if (this.instructions || contextInjection) {\n   143→      system = [contextInjection, this.instructions]\n   144→        .filter(Boolean)\n   145→        .join(\"\\n\\n\");\n   146→    }\n   147→\n   148→    // Convert thread events to messages\n   149→    for (const event of thread.events) {\n   150→      switch (event.type) {\n   151→        case \"message\": {\n   152→          if (event.role === \"user\") {\n   153→            messages.push({ role: \"user\", content: event.content });\n   154→          } else if (event.role === \"assistant\") {\n   155→            messages.push({ role: \"assistant\", content: event.content });\n   156→          } else if (event.role === \"system\") {\n   157→            // System messages injected as user messages with context marker\n   158→            messages.push({\n   159→              role: \"user\",\n   160→              content: `[System]: ${event.content}`,\n   161→            });\n   162→          }\n   163→          break;\n   164→        }\n   165→        case \"tool_call\": {\n   166→          // Tool calls are part of assistant messages - we'll let the SDK handle multi-step\n   167→          // They are included through the response.messages history\n   168→          break;\n   169→        }\n   170→        case \"tool_result\": {\n   171→          // Tool results are part of tool messages - handled by SDK\n   172→          break;\n   173→        }\n   174→        case \"human_input_received\": {\n   175→          messages.push({\n   176→            role: \"user\",\n   177→            content: `[Human Response]: ${event.response}`,\n   178→          });\n   179→          break;\n   180→        }\n   181→        case \"summary\": {\n   182→          // Summaries are injected via context injection in the system prompt\n   183→          break;\n   184→        }\n   185→        default:\n   186→          break;\n   187→      }\n   188→    }\n   189→\n   190→    return { system, messages };\n   191→  }\n   192→\n   193→  private appendResultEvents(\n   194→    thread: AgentThread,\n   195→    result: {\n   196→      text: string;\n   197→      steps: Array<{\n   198→        toolCalls: Array<{\n   199→          toolCallId: string;\n   200→          toolName: string;\n   201→          input?: unknown;\n   202→          args?: unknown;\n   203→        }>;\n   204→        toolResults: Array<{\n   205→          toolCallId: string;\n   206→          toolName?: string;\n   207→          output?: unknown;\n   208→          result?: unknown;\n   209→        }>;\n   210→        text: string;\n   211→      }>;\n   212→    },\n   213→    iteration: number,\n   214→  ): void {\n   215→    const now = Date.now();\n   216→\n   217→    for (const step of result.steps) {\n   218→      // Record tool calls\n   219→      for (const tc of step.toolCalls) {\n   220→        const toolCallEvent: ToolCallEvent = {\n   221→          type: \"tool_call\",\n   222→          toolName: tc.toolName,\n   223→          toolCallId: tc.toolCallId,\n   224→          args: (tc.input ?? tc.args ?? {}) as Record<string, unknown>,\n   225→          timestamp: now,\n   226→          iteration,\n   227→        };\n   228→        thread.events.push(toolCallEvent);\n   229→      }\n   230→\n   231→      // Record tool results\n   232→      for (const tr of step.toolResults) {\n   233→        const toolResultEvent: ToolResultEvent = {\n   234→          type: \"tool_result\",\n   235→          toolCallId: tr.toolCallId,\n   236→          result: tr.output ?? tr.result,\n   237→          timestamp: now,\n   238→          iteration,\n   239→        };\n   240→        thread.events.push(toolResultEvent);\n   241→      }\n   242→    }\n   243→\n   244→    // Record assistant message\n   245→    if (result.text) {\n   246→      const messageEvent: AgentMessageEvent = {\n   247→        type: \"message\",\n   248→        role: \"assistant\",\n   249→        content: result.text,\n   250→        timestamp: now,\n   251→        iteration,\n   252→      };\n   253→      thread.events.push(messageEvent);\n   254→    }\n   255→\n   256→    thread.updatedAt = now;\n   257→  }\n   258→\n   259→  private isPendingHumanInput(thread: AgentThread): boolean {\n   260→    // Check if the last relevant event is a human input request without a response\n   261→    const requestEvents = thread.events.filter(\n   262→      (e) => e.type === \"human_input_requested\",\n   263→    );\n   264→    const responseEvents = thread.events.filter(\n   265→      (e) => e.type === \"human_input_received\",\n   266→    );\n   267→    return requestEvents.length > responseEvents.length;\n   268→  }\n   269→\n   270→  private getLastHumanInputRequest(\n   271→    thread: AgentThread,\n   272→  ): HumanInputRequestedEvent | undefined {\n   273→    for (let i = thread.events.length - 1; i >= 0; i--) {\n   274→      if (thread.events[i].type === \"human_input_requested\") {\n   275→        return thread.events[i] as HumanInputRequestedEvent;\n   276→      }\n   277→    }\n   278→    return undefined;\n   279→  }\n   280→\n   281→  private checkInterruptOn(\n   282→    thread: AgentThread,\n   283→    iteration: number,\n   284→  ): string | null {\n   285→    // Check if any tool call in the current iteration matches interruptOn list\n   286→    if (this.interruptOn.length === 0) return null;\n   287→\n   288→    for (let i = thread.events.length - 1; i >= 0; i--) {\n   289→      const event = thread.events[i];\n   290→      if (event.iteration !== iteration) break;\n   291→      if (\n   292→        event.type === \"tool_call\" &&\n   293→        this.interruptOn.includes(event.toolName)\n   294→      ) {\n   295→        return event.toolName;\n   296→      }\n   297→    }\n   298→    return null;\n   299→  }\n   300→\n   301→  async loop(prompt: string): Promise<AgentResult | PendingResult> {\n   302→    const thread = createThread();\n   303→    return this.runLoop(thread, prompt, 1);\n   304→  }\n   305→\n   306→  private async runLoop(\n   307→    thread: AgentThread,\n   308→    prompt: string,\n   309→    startIteration: number,\n   310→  ): Promise<AgentResult | PendingResult> {\n   311→    // Push initial user message (only if this is the first call, not a resume)\n   312→    if (startIteration === 1) {\n   313→      thread.events.push({\n   314→        type: \"message\",\n   315→        role: \"user\",\n   316→        content: prompt,\n   317→        timestamp: Date.now(),\n   318→        iteration: 0,\n   319→      });\n   320→    }\n   321→\n   322→    let totalUsage: TokenUsage = {\n   323→      inputTokens: 0,\n   324→      outputTokens: 0,\n   325→      totalTokens: 0,\n   326→    };\n   327→    let iteration = startIteration;\n   328→    let consecutiveErrors = 0;\n   329→    let lastResponse = \"\";\n   330→\n   331→    // Merge middleware tools with user tools\n   332→    const allTools = {\n   333→      ...this.tools,\n   334→      ...this.composedMiddleware.tools,\n   335→    } as ToolSet;\n   336→\n   337→    while (true) {\n   338→      // Callback\n   339→      this.onIterationStart?.(iteration);\n   340→\n   341→      // Middleware: beforeIteration\n   342→      const middlewareCtx: MiddlewareContext = {\n   343→        thread,\n   344→        iteration,\n   345→        settings: {\n   346→          model: this.model,\n   347→          tools: this.tools,\n   348→          instructions: this.instructions,\n   349→        } as DeepFactorAgentSettings,\n   350→      };\n   351→      await this.composedMiddleware.beforeIteration(middlewareCtx);\n   352→\n   353→      // Context management: check if summarization needed\n   354→      if (this.contextManager.needsSummarization(thread)) {\n   355→        await this.contextManager.summarize(thread, this.model);\n   356→      }\n   357→\n   358→      // Build messages from thread\n   359→      const { system, messages } = this.buildMessages(thread);\n   360→\n   361→      try {\n   362→        const result = await generateText({\n   363→          model: this.model,\n   364→          system,\n   365→          messages,\n   366→          tools: allTools,\n   367→          stopWhen: stepCountIs(20),\n   368→        });\n   369→\n   370→        // Append events\n   371→        this.appendResultEvents(thread, result as any, iteration);\n   372→\n   373→        // Extract and accumulate usage\n   374→        const iterUsage = extractUsage(result.totalUsage);\n   375→        totalUsage = addUsage(totalUsage, iterUsage);\n   376→\n   377→        lastResponse = result.text;\n   378→\n   379→        // Handle todoMiddleware: store todos in thread metadata\n   380→        for (const step of result.steps) {\n   381→          for (const tr of step.toolResults as any[]) {\n   382→            if (tr.toolName === \"write_todos\" && tr.output?.todos) {\n   383→              thread.metadata.todos = tr.output.todos;\n   384→            }\n   385→            if (tr.toolName === \"read_todos\") {\n   386→              // Inject current todos into the result\n   387→              (tr as any).output = {\n   388→                todos: thread.metadata.todos ?? [],\n   389→              };\n   390→            }\n   391→          }\n   392→        }\n   393→\n   394→        // Check for requestHumanInput tool call\n   395→        let humanInputRequested = false;\n   396→        for (const step of result.steps) {\n   397→          for (const tc of step.toolCalls as any[]) {\n   398→            if (tc.toolName === \"requestHumanInput\") {\n   399→              const args = tc.input ?? tc.args ?? {};\n   400→              const hirEvent: HumanInputRequestedEvent = {\n   401→                type: \"human_input_requested\",\n   402→                question: args.question ?? \"\",\n   403→                context: args.context,\n   404→                urgency: args.urgency,\n   405→                format: args.format,\n   406→                choices: args.choices,\n   407→                timestamp: Date.now(),\n   408→                iteration,\n   409→              };\n   410→              thread.events.push(hirEvent);\n   411→              humanInputRequested = true;\n   412→            }\n   413→          }\n   414→        }\n   415→\n   416→        // Reset consecutive errors on success\n   417→        consecutiveErrors = 0;\n   418→\n   419→        // Middleware: afterIteration\n   420→        await this.composedMiddleware.afterIteration(\n   421→          middlewareCtx,\n   422→          result,\n   423→        );\n   424→\n   425→        // Callback\n   426→        this.onIterationEnd?.(iteration, result);\n   427→\n   428→        // Evaluate stop conditions\n   429→        const stopResult = evaluateStopConditions(this.stopConditions, {\n   430→          iteration,\n   431→          usage: totalUsage,\n   432→          model: this.modelId,\n   433→          thread,\n   434→        });\n   435→\n   436→        if (stopResult) {\n   437→          return {\n   438→            response: lastResponse,\n   439→            thread,\n   440→            usage: totalUsage,\n   441→            iterations: iteration,\n   442→            stopReason: \"stop_condition\",\n   443→            stopDetail: stopResult.reason,\n   444→          };\n   445→        }\n   446→\n   447→        // Check interruptOn\n   448→        const interruptedTool = this.checkInterruptOn(thread, iteration);\n   449→        if (interruptedTool) {\n   450→          thread.events.push({\n   451→            type: \"human_input_requested\",\n   452→            question: `Tool \"${interruptedTool}\" requires approval before execution.`,\n   453→            timestamp: Date.now(),\n   454→            iteration,\n   455→          });\n   456→\n   457→          const pendingResult: PendingResult = {\n   458→            response: lastResponse,\n   459→            thread,\n   460→            usage: totalUsage,\n   461→            iterations: iteration,\n   462→            stopReason: \"human_input_needed\",\n   463→            stopDetail: `Interrupted: tool \"${interruptedTool}\" requires approval`,\n   464→            resume: async (humanResponse: string) => {\n   465→              thread.events.push({\n   466→                type: \"human_input_received\",\n   467→                response: humanResponse,\n   468→                timestamp: Date.now(),\n   469→                iteration,\n   470→              });\n   471→              return this.runLoop(thread, prompt, iteration + 1);\n   472→            },\n   473→          };\n   474→          return pendingResult;\n   475→        }\n   476→\n   477→        // Check human input request\n   478→        if (humanInputRequested) {\n   479→          const pendingResult: PendingResult = {\n   480→            response: lastResponse,\n   481→            thread,\n   482→            usage: totalUsage,\n   483→            iterations: iteration,\n   484→            stopReason: \"human_input_needed\",\n   485→            stopDetail: \"Human input requested\",\n   486→            resume: async (humanResponse: string) => {\n   487→              thread.events.push({\n   488→                type: \"human_input_received\",\n   489→                response: humanResponse,\n   490→                timestamp: Date.now(),\n   491→                iteration,\n   492→              });\n   493→              return this.runLoop(thread, prompt, iteration + 1);\n   494→            },\n   495→          };\n   496→          return pendingResult;\n   497→        }\n   498→\n   499→        // Verification\n   500→        if (this.verifyCompletion) {\n   501→          const verifyResult = await this.verifyCompletion({\n   502→            result: lastResponse,\n   503→            iteration,\n   504→            thread,\n   505→            originalPrompt: prompt,\n   506→          });\n   507→\n   508→          if (verifyResult.complete) {\n   509→            const completionEvent: CompletionEvent = {\n   510→              type: \"completion\",\n   511→              result: lastResponse,\n   512→              verified: true,\n   513→              timestamp: Date.now(),\n   514→              iteration,\n   515→            };\n   516→            thread.events.push(completionEvent);\n   517→\n   518→            return {\n   519→              response: lastResponse,\n   520→              thread,\n   521→              usage: totalUsage,\n   522→              iterations: iteration,\n   523→              stopReason: \"completed\",\n   524→            };\n   525→          }\n   526→\n   527→          // Verification failed - inject feedback and continue\n   528→          if (verifyResult.reason) {\n   529→            thread.events.push({\n   530→              type: \"message\",\n   531→              role: \"user\",\n   532→              content: `Verification failed: ${verifyResult.reason}. Please try again.`,\n   533→              timestamp: Date.now(),\n   534→              iteration,\n   535→            });\n   536→          }\n   537→        } else {\n   538→          // No verification function - single iteration mode\n   539→          const completionEvent: CompletionEvent = {\n   540→            type: \"completion\",\n   541→            result: lastResponse,\n   542→            verified: false,\n   543→            timestamp: Date.now(),\n   544→            iteration,\n   545→          };\n   546→          thread.events.push(completionEvent);\n   547→\n   548→          return {\n   549→            response: lastResponse,\n   550→            thread,\n   551→            usage: totalUsage,\n   552→            iterations: iteration,\n   553→            stopReason: \"completed\",\n   554→          };\n   555→        }\n   556→      } catch (error) {\n   557→        consecutiveErrors++;\n   558→        const isRecoverable = consecutiveErrors < 3;\n   559→\n   560→        const errorEvent: ErrorEvent = {\n   561→          type: \"error\",\n   562→          error: compactError(error),\n   563→          recoverable: isRecoverable,\n   564→          timestamp: Date.now(),\n   565→          iteration,\n   566→        };\n   567→        thread.events.push(errorEvent);\n   568→\n   569→        // Middleware: afterIteration (even on error)\n   570→        await this.composedMiddleware.afterIteration(\n   571→          middlewareCtx,\n   572→          error,\n   573→        );\n   574→\n   575→        // Callback\n   576→        this.onIterationEnd?.(iteration, error);\n   577→\n   578→        if (!isRecoverable) {\n   579→          return {\n   580→            response: lastResponse,\n   581→            thread,\n   582→            usage: totalUsage,\n   583→            iterations: iteration,\n   584→            stopReason: \"max_errors\",\n   585→            stopDetail: `${consecutiveErrors} consecutive errors`,\n   586→          };\n   587→        }\n   588→\n   589→        // Continue to retry\n   590→      }\n   591→\n   592→      iteration++;\n   593→    }\n   594→  }\n   595→\n   596→  // eslint-disable-next-line @typescript-eslint/explicit-module-boundary-types\n   597→  stream(prompt: string): ReturnType<typeof streamText> {\n   598→    const thread = createThread();\n   599→\n   600→    // Push initial user message\n   601→    thread.events.push({\n   602→      type: \"message\",\n   603→      role: \"user\",\n   604→      content: prompt,\n   605→      timestamp: Date.now(),\n   606→      iteration: 0,\n   607→    });\n   608→\n   609→    const allTools = {\n   610→      ...this.tools,\n   611→      ...this.composedMiddleware.tools,\n   612→    } as ToolSet;\n   613→\n   614→    const { system, messages } = this.buildMessages(thread);\n   615→\n   616→    return streamText({\n   617→      model: this.model,\n   618→      system,\n   619→      messages,\n   620→      tools: allTools,\n   621→      stopWhen: stepCountIs(20),\n   622→    });\n   623→  }\n   624→}\n   625→"}]},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"9ac9f0ec-9db2-4240-b747-73b33e98d347"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01QdSD6rBHJvfpGW7iEDtidw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TxHAVjANTbDDsMQUBdkSd3","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/stop-conditions.ts"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":1736,"cache_read_input_tokens":10745,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1736},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"6ef2852b-d207-41eb-b290-00b78406a288"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TxHAVjANTbDDsMQUBdkSd3","type":"tool_result","content":"     1→import type {\n     2→  TokenUsage,\n     3→  StopCondition,\n     4→  StopConditionContext,\n     5→  StopConditionResult,\n     6→} from \"./types.js\";\n     7→\n     8→// --- Model Pricing (cost per token) ---\n     9→\n    10→export const MODEL_PRICING: Record<\n    11→  string,\n    12→  {\n    13→    input: number;\n    14→    output: number;\n    15→    cacheRead?: number;\n    16→    cacheWrite?: number;\n    17→  }\n    18→> = {\n    19→  // Anthropic\n    20→  \"claude-sonnet-4-5\": {\n    21→    input: 0.000003,\n    22→    output: 0.000015,\n    23→    cacheRead: 0.0000003,\n    24→    cacheWrite: 0.00000375,\n    25→  },\n    26→  \"claude-opus-4-5\": {\n    27→    input: 0.000015,\n    28→    output: 0.000075,\n    29→    cacheRead: 0.0000015,\n    30→    cacheWrite: 0.00001875,\n    31→  },\n    32→  \"claude-haiku-4-5\": {\n    33→    input: 0.0000008,\n    34→    output: 0.000004,\n    35→    cacheRead: 0.00000008,\n    36→    cacheWrite: 0.000001,\n    37→  },\n    38→  // OpenAI\n    39→  \"gpt-4o\": {\n    40→    input: 0.0000025,\n    41→    output: 0.00001,\n    42→  },\n    43→  \"gpt-4o-mini\": {\n    44→    input: 0.00000015,\n    45→    output: 0.0000006,\n    46→  },\n    47→  // Google\n    48→  \"gemini-2.5-pro\": {\n    49→    input: 0.00000125,\n    50→    output: 0.00001,\n    51→  },\n    52→  \"gemini-2.5-flash\": {\n    53→    input: 0.000000075,\n    54→    output: 0.0000003,\n    55→  },\n    56→};\n    57→\n    58→// --- Cost Calculation ---\n    59→\n    60→export function calculateCost(usage: TokenUsage, model: string): number {\n    61→  const pricing = MODEL_PRICING[model];\n    62→  if (!pricing) return 0;\n    63→\n    64→  let cost =\n    65→    usage.inputTokens * pricing.input + usage.outputTokens * pricing.output;\n    66→\n    67→  if (usage.cacheReadTokens !== undefined && pricing.cacheRead !== undefined) {\n    68→    cost += usage.cacheReadTokens * pricing.cacheRead;\n    69→  }\n    70→  if (\n    71→    usage.cacheWriteTokens !== undefined &&\n    72→    pricing.cacheWrite !== undefined\n    73→  ) {\n    74→    cost += usage.cacheWriteTokens * pricing.cacheWrite;\n    75→  }\n    76→\n    77→  return cost;\n    78→}\n    79→\n    80→// --- Stop Condition Factories ---\n    81→\n    82→export function maxIterations(n: number): StopCondition {\n    83→  return (ctx: StopConditionContext): StopConditionResult => {\n    84→    if (ctx.iteration >= n) {\n    85→      return { stop: true, reason: `Max iterations (${n}) reached` };\n    86→    }\n    87→    return { stop: false };\n    88→  };\n    89→}\n    90→\n    91→export function maxTokens(n: number): StopCondition {\n    92→  return (ctx: StopConditionContext): StopConditionResult => {\n    93→    if (ctx.usage.totalTokens >= n) {\n    94→      return {\n    95→        stop: true,\n    96→        reason: `Max tokens (${n}) reached: ${ctx.usage.totalTokens} total tokens used`,\n    97→      };\n    98→    }\n    99→    return { stop: false };\n   100→  };\n   101→}\n   102→\n   103→export function maxInputTokens(n: number): StopCondition {\n   104→  return (ctx: StopConditionContext): StopConditionResult => {\n   105→    if (ctx.usage.inputTokens >= n) {\n   106→      return {\n   107→        stop: true,\n   108→        reason: `Max input tokens (${n}) reached: ${ctx.usage.inputTokens} input tokens used`,\n   109→      };\n   110→    }\n   111→    return { stop: false };\n   112→  };\n   113→}\n   114→\n   115→export function maxOutputTokens(n: number): StopCondition {\n   116→  return (ctx: StopConditionContext): StopConditionResult => {\n   117→    if (ctx.usage.outputTokens >= n) {\n   118→      return {\n   119→        stop: true,\n   120→        reason: `Max output tokens (${n}) reached: ${ctx.usage.outputTokens} output tokens used`,\n   121→      };\n   122→    }\n   123→    return { stop: false };\n   124→  };\n   125→}\n   126→\n   127→export function maxCost(dollars: number, model?: string): StopCondition {\n   128→  return (ctx: StopConditionContext): StopConditionResult => {\n   129→    const modelToUse = model ?? ctx.model;\n   130→    const cost = calculateCost(ctx.usage, modelToUse);\n   131→    if (cost >= dollars) {\n   132→      return {\n   133→        stop: true,\n   134→        reason: `Max cost ($${dollars.toFixed(2)}) reached: $${cost.toFixed(4)} spent`,\n   135→      };\n   136→    }\n   137→    return { stop: false };\n   138→  };\n   139→}\n   140→\n   141→// --- Evaluator ---\n   142→\n   143→export function evaluateStopConditions(\n   144→  conditions: StopCondition[],\n   145→  ctx: StopConditionContext,\n   146→): StopConditionResult | null {\n   147→  for (const condition of conditions) {\n   148→    const result = condition(ctx);\n   149→    if (result.stop) {\n   150→      return result;\n   151→    }\n   152→  }\n   153→  return null;\n   154→}\n   155→"}]},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"05936d78-58fa-438f-837d-3327312b138b"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01QdSD6rBHJvfpGW7iEDtidw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011Ed8GZcPypB2sCYJwbSjNG","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/middleware.ts"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":1736,"cache_read_input_tokens":10745,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1736},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"26e12313-6444-4ca3-89bd-22b8efdaf60f"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011Ed8GZcPypB2sCYJwbSjNG","type":"tool_result","content":"     1→import type { ToolSet } from \"ai\";\n     2→import { z } from \"zod\";\n     3→import type {\n     4→  AgentMiddleware,\n     5→  MiddlewareContext,\n     6→  ErrorEvent,\n     7→} from \"./types.js\";\n     8→\n     9→export interface ComposedMiddleware {\n    10→  tools: ToolSet;\n    11→  beforeIteration: (ctx: MiddlewareContext) => Promise<void>;\n    12→  afterIteration: (ctx: MiddlewareContext, result: unknown) => Promise<void>;\n    13→}\n    14→\n    15→export function composeMiddleware(\n    16→  middlewares: AgentMiddleware[],\n    17→): ComposedMiddleware {\n    18→  const tools: ToolSet = {};\n    19→\n    20→  for (const mw of middlewares) {\n    21→    if (mw.tools) {\n    22→      for (const [name, tool] of Object.entries(mw.tools)) {\n    23→        if (name in tools) {\n    24→          console.warn(\n    25→            `Middleware tool conflict: \"${name}\" from \"${mw.name}\" overrides a previous definition`,\n    26→          );\n    27→        }\n    28→        (tools as Record<string, unknown>)[name] = tool;\n    29→      }\n    30→    }\n    31→  }\n    32→\n    33→  const beforeIteration = async (ctx: MiddlewareContext): Promise<void> => {\n    34→    for (const mw of middlewares) {\n    35→      if (mw.beforeIteration) {\n    36→        await mw.beforeIteration(ctx);\n    37→      }\n    38→    }\n    39→  };\n    40→\n    41→  const afterIteration = async (\n    42→    ctx: MiddlewareContext,\n    43→    result: unknown,\n    44→  ): Promise<void> => {\n    45→    for (const mw of middlewares) {\n    46→      if (mw.afterIteration) {\n    47→        await mw.afterIteration(ctx, result);\n    48→      }\n    49→    }\n    50→  };\n    51→\n    52→  return { tools, beforeIteration, afterIteration };\n    53→}\n    54→\n    55→export function todoMiddleware(): AgentMiddleware {\n    56→  const todoSchema = z.object({\n    57→    todos: z.array(\n    58→      z.object({\n    59→        id: z.string(),\n    60→        text: z.string(),\n    61→        status: z.enum([\"pending\", \"in_progress\", \"done\"]),\n    62→      }),\n    63→    ),\n    64→  });\n    65→\n    66→  return {\n    67→    name: \"todo\",\n    68→    tools: {\n    69→      write_todos: {\n    70→        description: \"Create or update the todo list for planning and tracking progress\",\n    71→        parameters: todoSchema,\n    72→        execute: async (\n    73→          args: z.infer<typeof todoSchema>,\n    74→          { messages }: { messages?: unknown[] } = {},\n    75→        ) => {\n    76→          // Todos will be stored in thread.metadata.todos by the agent loop\n    77→          return { success: true, todos: args.todos };\n    78→        },\n    79→      },\n    80→      read_todos: {\n    81→        description: \"Read the current todo list\",\n    82→        parameters: z.object({}),\n    83→        execute: async () => {\n    84→          // The agent loop handles reading from thread.metadata.todos\n    85→          return { todos: [] };\n    86→        },\n    87→      },\n    88→    } as unknown as ToolSet,\n    89→  };\n    90→}\n    91→\n    92→export function errorRecoveryMiddleware(): AgentMiddleware {\n    93→  return {\n    94→    name: \"errorRecovery\",\n    95→    afterIteration: async (\n    96→      ctx: MiddlewareContext,\n    97→      _result: unknown,\n    98→    ): Promise<void> => {\n    99→      const { thread } = ctx;\n   100→      if (thread.events.length === 0) return;\n   101→\n   102→      const lastEvent = thread.events[thread.events.length - 1];\n   103→      if (lastEvent.type === \"error\") {\n   104→        const errorEvent = lastEvent as ErrorEvent;\n   105→        let errorMsg = errorEvent.error;\n   106→        if (errorMsg.length > 500) {\n   107→          errorMsg = errorMsg.substring(0, 500) + \"... [truncated]\";\n   108→        }\n   109→\n   110→        thread.events.push({\n   111→          type: \"message\",\n   112→          role: \"system\",\n   113→          content: `Error occurred: ${errorMsg}\\nConsider an alternative approach if the same error occurs again.`,\n   114→          timestamp: Date.now(),\n   115→          iteration: ctx.iteration,\n   116→        });\n   117→      }\n   118→    },\n   119→  };\n   120→}\n   121→"}]},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"0a2d89af-623c-49f4-95e1-005368e10592"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01QdSD6rBHJvfpGW7iEDtidw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RxsW6ZvvfsQ7Pxj6umV21s","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/human-in-the-loop.ts"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":1736,"cache_read_input_tokens":10745,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1736},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"741c52cc-2ec3-4c8b-aa97-14a9e6673d4a"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RxsW6ZvvfsQ7Pxj6umV21s","type":"tool_result","content":"     1→import { z } from \"zod\";\n     2→import type { ToolSet } from \"ai\";\n     3→\n     4→export const requestHumanInputSchema = z.object({\n     5→  question: z.string().describe(\"The question to ask the human\"),\n     6→  context: z.string().optional().describe(\"Background context for the question\"),\n     7→  urgency: z\n     8→    .enum([\"low\", \"medium\", \"high\"])\n     9→    .optional()\n    10→    .default(\"medium\")\n    11→    .describe(\"How urgent is this request\"),\n    12→  format: z\n    13→    .enum([\"free_text\", \"yes_no\", \"multiple_choice\"])\n    14→    .optional()\n    15→    .default(\"free_text\")\n    16→    .describe(\"Expected response format\"),\n    17→  choices: z\n    18→    .array(z.string())\n    19→    .optional()\n    20→    .describe(\"Options for multiple_choice format\"),\n    21→});\n    22→\n    23→export const requestHumanInput = {\n    24→  description:\n    25→    \"Request input or approval from a human. Use when you need clarification, confirmation, or a decision.\",\n    26→  parameters: requestHumanInputSchema,\n    27→  execute: async (args: z.infer<typeof requestHumanInputSchema>) => {\n    28→    // The actual pause mechanism is handled by the agent loop.\n    29→    // This tool's execute function returns the args so the loop can detect it.\n    30→    return {\n    31→      requested: true,\n    32→      question: args.question,\n    33→      context: args.context,\n    34→      urgency: args.urgency,\n    35→      format: args.format,\n    36→      choices: args.choices,\n    37→    };\n    38→  },\n    39→} as unknown as ToolSet[string];\n    40→"}]},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"409d3ab2-3ab2-4277-8f39-df7f7fa3d217"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01QdSD6rBHJvfpGW7iEDtidw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0167M9FEQUG7oG4mQWbJiXeM","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/types.ts"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":1736,"cache_read_input_tokens":10745,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1736},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"5b4c70e8-f24b-4a09-8e83-05d7ec2f8d5b"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0167M9FEQUG7oG4mQWbJiXeM","type":"tool_result","content":"     1→import type { LanguageModel, ToolSet } from \"ai\";\n     2→\n     3→// --- Event Types ---\n     4→\n     5→export type AgentEventType =\n     6→  | \"tool_call\"\n     7→  | \"tool_result\"\n     8→  | \"error\"\n     9→  | \"human_input_requested\"\n    10→  | \"human_input_received\"\n    11→  | \"message\"\n    12→  | \"completion\"\n    13→  | \"summary\";\n    14→\n    15→export interface BaseEvent {\n    16→  type: AgentEventType;\n    17→  timestamp: number;\n    18→  iteration: number;\n    19→}\n    20→\n    21→export interface ToolCallEvent extends BaseEvent {\n    22→  type: \"tool_call\";\n    23→  toolName: string;\n    24→  toolCallId: string;\n    25→  args: Record<string, unknown>;\n    26→}\n    27→\n    28→export interface ToolResultEvent extends BaseEvent {\n    29→  type: \"tool_result\";\n    30→  toolCallId: string;\n    31→  result: unknown;\n    32→}\n    33→\n    34→export interface ErrorEvent extends BaseEvent {\n    35→  type: \"error\";\n    36→  error: string;\n    37→  toolCallId?: string;\n    38→  recoverable: boolean;\n    39→}\n    40→\n    41→export interface HumanInputRequestedEvent extends BaseEvent {\n    42→  type: \"human_input_requested\";\n    43→  question: string;\n    44→  context?: string;\n    45→  urgency?: \"low\" | \"medium\" | \"high\";\n    46→  format?: \"free_text\" | \"yes_no\" | \"multiple_choice\";\n    47→  choices?: string[];\n    48→}\n    49→\n    50→export interface HumanInputReceivedEvent extends BaseEvent {\n    51→  type: \"human_input_received\";\n    52→  response: string;\n    53→}\n    54→\n    55→export interface MessageEvent extends BaseEvent {\n    56→  type: \"message\";\n    57→  role: \"user\" | \"assistant\" | \"system\";\n    58→  content: string;\n    59→}\n    60→\n    61→export interface CompletionEvent extends BaseEvent {\n    62→  type: \"completion\";\n    63→  result: string;\n    64→  verified: boolean;\n    65→}\n    66→\n    67→export interface SummaryEvent extends BaseEvent {\n    68→  type: \"summary\";\n    69→  summarizedIterations: number[];\n    70→  summary: string;\n    71→}\n    72→\n    73→export type AgentEvent =\n    74→  | ToolCallEvent\n    75→  | ToolResultEvent\n    76→  | ErrorEvent\n    77→  | HumanInputRequestedEvent\n    78→  | HumanInputReceivedEvent\n    79→  | MessageEvent\n    80→  | CompletionEvent\n    81→  | SummaryEvent;\n    82→\n    83→// --- Thread ---\n    84→\n    85→export interface AgentThread {\n    86→  id: string;\n    87→  events: AgentEvent[];\n    88→  metadata: Record<string, unknown>;\n    89→  createdAt: number;\n    90→  updatedAt: number;\n    91→}\n    92→\n    93→// --- Token Usage ---\n    94→\n    95→export interface TokenUsage {\n    96→  inputTokens: number;\n    97→  outputTokens: number;\n    98→  totalTokens: number;\n    99→  cacheReadTokens?: number;\n   100→  cacheWriteTokens?: number;\n   101→}\n   102→\n   103→// --- Stop Conditions ---\n   104→\n   105→export interface StopConditionContext {\n   106→  iteration: number;\n   107→  usage: TokenUsage;\n   108→  model: string;\n   109→  thread: AgentThread;\n   110→}\n   111→\n   112→export interface StopConditionResult {\n   113→  stop: boolean;\n   114→  reason?: string;\n   115→}\n   116→\n   117→export type StopCondition = (ctx: StopConditionContext) => StopConditionResult;\n   118→\n   119→// --- Verification ---\n   120→\n   121→export interface VerifyContext {\n   122→  result: unknown;\n   123→  iteration: number;\n   124→  thread: AgentThread;\n   125→  originalPrompt: string;\n   126→}\n   127→\n   128→export interface VerifyResult {\n   129→  complete: boolean;\n   130→  reason?: string;\n   131→}\n   132→\n   133→export type VerifyCompletion = (ctx: VerifyContext) => Promise<VerifyResult>;\n   134→\n   135→// --- Context Management ---\n   136→\n   137→export interface ContextManagementConfig {\n   138→  maxContextTokens?: number;\n   139→  keepRecentIterations?: number;\n   140→}\n   141→\n   142→// --- Middleware ---\n   143→\n   144→export interface MiddlewareContext {\n   145→  thread: AgentThread;\n   146→  iteration: number;\n   147→  settings: DeepFactorAgentSettings;\n   148→}\n   149→\n   150→export interface AgentMiddleware {\n   151→  name: string;\n   152→  tools?: ToolSet;\n   153→  beforeIteration?: (ctx: MiddlewareContext) => Promise<void>;\n   154→  afterIteration?: (\n   155→    ctx: MiddlewareContext,\n   156→    result: unknown,\n   157→  ) => Promise<void>;\n   158→}\n   159→\n   160→// --- Agent Settings ---\n   161→\n   162→export interface DeepFactorAgentSettings<\n   163→  TTools extends ToolSet = ToolSet,\n   164→> {\n   165→  model: LanguageModel | string;\n   166→  tools?: TTools;\n   167→  instructions?: string;\n   168→  stopWhen?: StopCondition | StopCondition[];\n   169→  verifyCompletion?: VerifyCompletion;\n   170→  middleware?: AgentMiddleware[];\n   171→  interruptOn?: string[];\n   172→  contextManagement?: ContextManagementConfig;\n   173→  onIterationStart?: (iteration: number) => void;\n   174→  onIterationEnd?: (iteration: number, result: unknown) => void;\n   175→}\n   176→\n   177→// --- Results ---\n   178→\n   179→export interface AgentResult {\n   180→  response: string;\n   181→  thread: AgentThread;\n   182→  usage: TokenUsage;\n   183→  iterations: number;\n   184→  stopReason:\n   185→    | \"completed\"\n   186→    | \"stop_condition\"\n   187→    | \"max_errors\"\n   188→    | \"human_input_needed\";\n   189→  stopDetail?: string;\n   190→}\n   191→\n   192→export interface PendingResult extends AgentResult {\n   193→  stopReason: \"human_input_needed\";\n   194→  resume: (humanResponse: string) => Promise<AgentResult>;\n   195→}\n   196→"}]},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"cfec2f98-6c22-4605-9ccb-5b7e0fe1fe3a"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01C8EdSuvkCQ6NbxLzgRvQnS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NpvXQCqbiDXtAAuu3FA9UR","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/context-manager.ts"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":19002,"cache_read_input_tokens":12481,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":19002},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"115b6ed1-6508-4756-b168-f2b2dc298662"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NpvXQCqbiDXtAAuu3FA9UR","type":"tool_result","content":"     1→import type { LanguageModel } from \"ai\";\n     2→import { generateText } from \"ai\";\n     3→import type {\n     4→  AgentThread,\n     5→  ContextManagementConfig,\n     6→  SummaryEvent,\n     7→} from \"./types.js\";\n     8→\n     9→export function estimateTokens(text: string): number {\n    10→  if (text.length === 0) return 0;\n    11→  return Math.ceil(text.length / 3.5);\n    12→}\n    13→\n    14→export class ContextManager {\n    15→  private maxContextTokens: number;\n    16→  private keepRecentIterations: number;\n    17→\n    18→  constructor(config: ContextManagementConfig = {}) {\n    19→    this.maxContextTokens = config.maxContextTokens ?? 150000;\n    20→    this.keepRecentIterations = config.keepRecentIterations ?? 3;\n    21→  }\n    22→\n    23→  estimateThreadTokens(thread: AgentThread): number {\n    24→    let total = 0;\n    25→    for (const event of thread.events) {\n    26→      const serialized = JSON.stringify(event);\n    27→      total += estimateTokens(serialized);\n    28→    }\n    29→    return total;\n    30→  }\n    31→\n    32→  needsSummarization(thread: AgentThread): boolean {\n    33→    return this.estimateThreadTokens(thread) > this.maxContextTokens;\n    34→  }\n    35→\n    36→  async summarize(\n    37→    thread: AgentThread,\n    38→    model: LanguageModel,\n    39→  ): Promise<AgentThread> {\n    40→    // Group events by iteration\n    41→    const iterationMap = new Map<number, typeof thread.events>();\n    42→    for (const event of thread.events) {\n    43→      const iter = event.iteration;\n    44→      if (!iterationMap.has(iter)) {\n    45→        iterationMap.set(iter, []);\n    46→      }\n    47→      iterationMap.get(iter)!.push(event);\n    48→    }\n    49→\n    50→    const iterations = Array.from(iterationMap.keys()).sort((a, b) => a - b);\n    51→    if (iterations.length === 0) return thread;\n    52→\n    53→    const maxIteration = iterations[iterations.length - 1];\n    54→    const cutoff = maxIteration - this.keepRecentIterations;\n    55→\n    56→    // Identify old iterations to summarize (skip already-summarized events)\n    57→    const oldIterations = iterations.filter((i) => i <= cutoff);\n    58→    if (oldIterations.length === 0) return thread;\n    59→\n    60→    const summaryEvents: SummaryEvent[] = [];\n    61→\n    62→    for (const iter of oldIterations) {\n    63→      const events = iterationMap.get(iter)!;\n    64→      // Skip if already a single summary event\n    65→      if (events.length === 1 && events[0].type === \"summary\") continue;\n    66→\n    67→      const eventsText = events\n    68→        .map((e) => JSON.stringify(e))\n    69→        .join(\"\\n\");\n    70→\n    71→      try {\n    72→        const result = await generateText({\n    73→          model,\n    74→          messages: [\n    75→            {\n    76→              role: \"user\",\n    77→              content: `Summarize the following agent iteration events in 2-3 sentences. Focus on what tools were called, what was accomplished, and any errors:\\n\\n${eventsText}`,\n    78→            },\n    79→          ],\n    80→        });\n    81→\n    82→        summaryEvents.push({\n    83→          type: \"summary\",\n    84→          summarizedIterations: [iter],\n    85→          summary: result.text,\n    86→          timestamp: Date.now(),\n    87→          iteration: iter,\n    88→        });\n    89→      } catch {\n    90→        // If summarization fails, keep a simple summary\n    91→        summaryEvents.push({\n    92→          type: \"summary\",\n    93→          summarizedIterations: [iter],\n    94→          summary: `Iteration ${iter}: ${events.length} events (summarization failed)`,\n    95→          timestamp: Date.now(),\n    96→          iteration: iter,\n    97→        });\n    98→      }\n    99→    }\n   100→\n   101→    // Remove old iteration events, keep recent ones and summaries\n   102→    const newEvents = thread.events.filter(\n   103→      (e) => e.iteration > cutoff || e.type === \"summary\",\n   104→    );\n   105→\n   106→    // Add new summaries\n   107→    thread.events = [...summaryEvents, ...newEvents];\n   108→    thread.updatedAt = Date.now();\n   109→\n   110→    return thread;\n   111→  }\n   112→\n   113→  buildContextInjection(thread: AgentThread): string {\n   114→    const summaries = thread.events.filter(\n   115→      (e): e is SummaryEvent => e.type === \"summary\",\n   116→    );\n   117→\n   118→    if (summaries.length === 0) return \"\";\n   119→\n   120→    let injection = \"## Previous Iteration Summaries\\n\\n\";\n   121→    for (const s of summaries) {\n   122→      const iters = s.summarizedIterations.join(\", \");\n   123→      injection += `### Iteration(s) ${iters}\\n${s.summary}\\n\\n`;\n   124→    }\n   125→\n   126→    return injection;\n   127→  }\n   128→}\n   129→"}]},"parent_tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"c2546186-a7ec-4a17-adb4-c1c5d6876e50"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","type":"tool_result","content":[{"type":"text","text":"I now have all the information needed for a thorough cross-reference. Here is my complete audit report.\n\n---\n\n## README vs. Source Code Audit Report\n\n### 1. Imports from `deep-factor-agent` (checking against `src/index.ts`)\n\n**README Quick Start (line 39):**\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\n```\n- `createDeepFactorAgent` -- exported from `src/index.ts` line 56. **CORRECT**\n- `maxIterations` -- exported from `src/index.ts` line 32. **CORRECT**\n\n**README Stop Conditions (lines 103-110):**\n```typescript\nimport {\n  createDeepFactorAgent, maxIterations, maxTokens,\n  maxInputTokens, maxOutputTokens, maxCost,\n} from \"deep-factor-agent\";\n```\n- All five stop condition functions are exported from `src/index.ts` lines 32-36. **CORRECT**\n\n**README Human-in-the-loop (lines 131-134):**\n```typescript\nimport {\n  createDeepFactorAgent, requestHumanInput, maxIterations,\n} from \"deep-factor-agent\";\n```\n- `requestHumanInput` -- exported from `src/index.ts` line 59. **CORRECT**\n\n**README Middleware (lines 158-163):**\n```typescript\nimport {\n  createDeepFactorAgent, todoMiddleware, errorRecoveryMiddleware, maxIterations,\n} from \"deep-factor-agent\";\n```\n- `todoMiddleware` -- exported from `src/index.ts` line 45. **CORRECT**\n- `errorRecoveryMiddleware` -- exported from `src/index.ts` line 46. **CORRECT**\n\n**README Custom Middleware (line 178):**\n```typescript\nimport type { AgentMiddleware } from \"deep-factor-agent\";\n```\n- `AgentMiddleware` -- exported as a type from `src/index.ts` line 24. **CORRECT**\n\n**All import names resolve.** No phantom exports.\n\n---\n\n### 2. `createDeepFactorAgent` Settings Object Properties\n\nThe README uses these settings properties across examples:\n- `model` -- exists in `DeepFactorAgentSettings` (line 165 of types.ts). **CORRECT**\n- `instructions` -- exists (line 167). **CORRECT**\n- `tools` -- exists (line 166). **CORRECT**\n- `stopWhen` -- exists (line 168). **CORRECT**\n- `verifyCompletion` -- exists (line 169). **CORRECT**\n- `middleware` -- exists (line 170). **CORRECT**\n- `interruptOn` -- exists (line 171). **CORRECT**\n- `contextManagement` -- exists (line 172). **CORRECT**\n- `contextManagement.maxContextTokens` -- exists in `ContextManagementConfig` (line 138). **CORRECT**\n- `contextManagement.keepRecentIterations` -- exists (line 139). **CORRECT**\n\n**All settings properties match the interface.** No issues.\n\n---\n\n### 3. `verifyCompletion` Callback Signature\n\n**README (lines 91-94):**\n```typescript\nverifyCompletion: async ({ result }) => ({\n  complete: result.includes(\"°F\"),\n  reason: \"Response must contain a temperature\",\n}),\n```\n\n**Source `VerifyCompletion` type (types.ts line 133):**\n```typescript\nexport type VerifyCompletion = (ctx: VerifyContext) => Promise<VerifyResult>;\n```\n\n**`VerifyContext` (types.ts lines 121-126):**\n```typescript\nexport interface VerifyContext {\n  result: unknown;  // <--- type is `unknown`, not `string`\n  iteration: number;\n  thread: AgentThread;\n  originalPrompt: string;\n}\n```\n\n**ISSUE FOUND:** The README calls `result.includes(\"°F\")`, but `result` is typed as `unknown` in `VerifyContext`. Calling `.includes()` on `unknown` would be a TypeScript compile error. The user would need to cast or narrow `result` first, e.g., `(result as string).includes(\"°F\")` or add a type guard.\n\nHowever, looking at how the agent actually calls `verifyCompletion` (agent.ts line 501):\n```typescript\nconst verifyResult = await this.verifyCompletion({\n  result: lastResponse,  // lastResponse is `string`\n  ...\n});\n```\n\nSo at runtime `result` is always a string, but the type declaration says `unknown`. This is a mismatch between the runtime behavior and the type. The README example would fail type-checking. **Either the type in `VerifyContext.result` should be `string`, or the README example needs a type assertion.**\n\n**Severity: Medium.** The code would work at runtime but would not compile with strict TypeScript.\n\n---\n\n### 4. `AgentResult` Shape\n\n**README (lines 50-52):**\n```typescript\nconsole.log(result.response);   // \"The capital of France is Paris.\"\nconsole.log(result.iterations); // number of loop iterations used\nconsole.log(result.usage);      // { inputTokens, outputTokens, totalTokens }\n```\n\n**Source `AgentResult` (types.ts lines 179-190):**\n```typescript\nexport interface AgentResult {\n  response: string;\n  thread: AgentThread;\n  usage: TokenUsage;\n  iterations: number;\n  stopReason: \"completed\" | \"stop_condition\" | \"max_errors\" | \"human_input_needed\";\n  stopDetail?: string;\n}\n```\n\n- `result.response` -- exists as `string`. **CORRECT**\n- `result.iterations` -- exists as `number`. **CORRECT**\n- `result.usage` -- exists as `TokenUsage`. The comment `{ inputTokens, outputTokens, totalTokens }` matches `TokenUsage` (lines 95-101 of types.ts). **CORRECT** (though it omits the optional `cacheReadTokens` and `cacheWriteTokens`, that is fine for documentation)\n\n---\n\n### 5. `stream()` Method Return Type\n\n**README (lines 208-212):**\n```typescript\nconst stream = await agent.stream(\"Tell me a story.\");\n\nfor await (const chunk of stream.textStream) {\n  process.stdout.write(chunk);\n}\n```\n\n**Source `stream()` method (agent.ts lines 597-623):**\n```typescript\nstream(prompt: string): ReturnType<typeof streamText> {\n  ...\n  return streamText({ ... });\n}\n```\n\nThe `streamText` function from the Vercel AI SDK returns a `StreamTextResult`. This is NOT a Promise -- it is a synchronous call that returns an object with `textStream` and other properties. The README uses `await agent.stream(...)`, but `stream()` does NOT return a Promise. It returns `ReturnType<typeof streamText>` directly.\n\n**ISSUE FOUND:** The README uses `await agent.stream(...)` but the `stream()` method is synchronous (returns the `streamText(...)` result directly, which is not a Promise). The `await` is unnecessary and misleading, though it would not cause a runtime error (awaiting a non-Promise value just resolves to that value). The code would work, but it is technically incorrect and could confuse readers about the API.\n\nLooking more carefully at the Vercel AI SDK: `streamText()` returns a `StreamTextResult` which has a `textStream` property that is an `AsyncIterable<string>`. The `await` in the README is harmless but misleading.\n\n**Severity: Low.** Works at runtime due to JS/TS `await` being a no-op on non-Promises, but the API documentation is imprecise.\n\n---\n\n### 6. `requestHumanInput` Usage\n\n**README (lines 138-140):**\n```typescript\ntools: { requestHumanInput },\ninterruptOn: [\"requestHumanInput\"],\n```\n\n**Source (human-in-the-loop.ts lines 23-39):**\n```typescript\nexport const requestHumanInput = {\n  description: \"...\",\n  parameters: requestHumanInputSchema,\n  execute: async (args) => { ... },\n} as unknown as ToolSet[string];\n```\n\nThis is a tool object (not a function), and the README correctly uses it as a value in the `tools` object with shorthand property syntax. The `interruptOn` correctly references the key name `\"requestHumanInput\"`. **CORRECT**\n\n---\n\n### 7. `resume()` Method on `PendingResult`\n\n**README (lines 146-151):**\n```typescript\nif (result.stopReason === \"human_input_needed\") {\n  const finalResult = await result.resume(\"Blue\");\n  console.log(finalResult.response);\n}\n```\n\n**Source `PendingResult` (types.ts lines 192-195):**\n```typescript\nexport interface PendingResult extends AgentResult {\n  stopReason: \"human_input_needed\";\n  resume: (humanResponse: string) => Promise<AgentResult>;\n}\n```\n\n- `resume` exists on `PendingResult`. **CORRECT**\n- It takes a `string` argument (`humanResponse: string`). **CORRECT**\n- It returns `Promise<AgentResult>`. **CORRECT**\n\nHowever, `loop()` returns `Promise<AgentResult | PendingResult>` (agent.ts line 301). The README does a runtime check `result.stopReason === \"human_input_needed\"` to narrow, but TypeScript would not automatically narrow `AgentResult | PendingResult` to `PendingResult` via discriminant unless it can see that only `PendingResult` has `stopReason: \"human_input_needed\"`.\n\nLooking at the types: `AgentResult.stopReason` includes `\"human_input_needed\"` in its union (line 188), and `PendingResult.stopReason` narrows it to just `\"human_input_needed\"`. Because `AgentResult` also allows `stopReason: \"human_input_needed\"`, checking `result.stopReason === \"human_input_needed\"` does NOT narrow the type to `PendingResult` -- it remains `AgentResult | PendingResult`, and `AgentResult` does not have `resume`.\n\n**ISSUE FOUND:** The discriminant check `result.stopReason === \"human_input_needed\"` does not narrow `AgentResult | PendingResult` to `PendingResult` in TypeScript, because both types allow `stopReason` to be `\"human_input_needed\"`. The user would get a compile error on `result.resume(\"Blue\")` because `resume` does not exist on `AgentResult`.\n\nTo fix this, either:\n- Remove `\"human_input_needed\"` from `AgentResult.stopReason` (so it becomes a proper discriminant), OR\n- Add a type guard like `if ('resume' in result)`, OR\n- The README should show a cast: `(result as PendingResult).resume(\"Blue\")`\n\n**Severity: High.** This is a compile error in the README example as written.\n\n---\n\n### 8. `AgentMiddleware` Type Shape\n\n**README (lines 181-189):**\n```typescript\nconst loggingMiddleware: AgentMiddleware = {\n  name: \"logging\",\n  beforeIteration: async (ctx) => {\n    console.log(`Starting iteration ${ctx.iteration}`);\n  },\n  afterIteration: async (ctx) => {\n    console.log(`Finished iteration ${ctx.iteration}`);\n  },\n};\n```\n\n**Source `AgentMiddleware` (types.ts lines 150-158):**\n```typescript\nexport interface AgentMiddleware {\n  name: string;\n  tools?: ToolSet;\n  beforeIteration?: (ctx: MiddlewareContext) => Promise<void>;\n  afterIteration?: (ctx: MiddlewareContext, result: unknown) => Promise<void>;\n}\n```\n\n**ISSUE FOUND:** The `afterIteration` hook has a second parameter `result: unknown` in the actual type definition, but the README example only destructures `ctx` with no second parameter:\n```typescript\nafterIteration: async (ctx) => { ... }\n```\n\nThis is technically valid TypeScript (you can ignore trailing parameters), so it would compile and run. However, the README is showing an incomplete signature and not documenting the `result` parameter. This is a **documentation gap** rather than an error.\n\n**Severity: Very Low.** Compiles fine, but the reader does not learn about the `result` parameter.\n\n---\n\n### 9. Defaults Table\n\n**README (lines 236-247):**\n\n| Setting | Default |\n|---|---|\n| `tools` | `{}` |\n| `instructions` | `\"\"` |\n| `stopWhen` | `[maxIterations(10)]` |\n| `verifyCompletion` | `undefined` |\n| `middleware` | `[todoMiddleware(), errorRecoveryMiddleware()]` |\n| `interruptOn` | `[]` |\n| `contextManagement.maxContextTokens` | `150000` |\n| `contextManagement.keepRecentIterations` | `3` |\n\n**Source `createDeepFactorAgent` (create-agent.ts lines 10-26):**\n```typescript\ntools: settings.tools ?? ({} as TTools),\ninstructions: settings.instructions ?? \"\",\nstopWhen: settings.stopWhen ?? [maxIterations(10)],\nmiddleware: settings.middleware ?? [todoMiddleware(), errorRecoveryMiddleware()],\ninterruptOn: settings.interruptOn ?? [],\ncontextManagement: { maxContextTokens: 150000, keepRecentIterations: 3, ...settings.contextManagement },\n```\n\nAll defaults match. **CORRECT**\n\n---\n\n### 10. API Reference Table Accuracy\n\n- `addUsage(a, b)` -- exported from `src/index.ts` line 53. **CORRECT**\n- `DeepFactorAgent` -- exported from `src/index.ts` line 53. **CORRECT**\n- `ContextManager` -- exported from `src/index.ts` line 50. **CORRECT**\n- `estimateTokens` -- exported from `src/index.ts` line 50. **CORRECT**\n- `composeMiddleware` -- exported from `src/index.ts` line 44. **CORRECT**\n- `evaluateStopConditions` -- exported from `src/index.ts` line 39. **CORRECT**\n- `calculateCost` -- exported from `src/index.ts` line 37. **CORRECT**\n- `MODEL_PRICING` -- exported from `src/index.ts` line 38. **CORRECT**\n\nAll API reference table entries match actual exports. **CORRECT**\n\n---\n\n## Summary of Issues Found\n\n### High Severity\n\n1. **`PendingResult` discriminant narrowing does not work (README lines 146-151).** The `stopReason === \"human_input_needed\"` check does not narrow `AgentResult | PendingResult` to `PendingResult` because `AgentResult.stopReason` also includes `\"human_input_needed\"` in its union. Calling `result.resume(\"Blue\")` would be a TypeScript compile error. Fix either the types (remove `\"human_input_needed\"` from `AgentResult.stopReason`) or the README (add a type guard or cast).\n\n### Medium Severity\n\n2. **`VerifyContext.result` is typed as `unknown` but the README calls `.includes()` on it (README line 92).** The actual runtime value is always a `string` (agent.ts line 501 passes `lastResponse: string`), but the type says `unknown`. Either change the type to `string` or update the README example to include a type assertion.\n\n### Low Severity\n\n3. **`stream()` is not async, but the README uses `await` (README line 208).** The `stream()` method returns `ReturnType<typeof streamText>` synchronously. The `await` is a no-op and harmless but misleading.\n\n4. **`afterIteration` middleware hook has a second `result` parameter not shown in the README example (README line 187).** Valid TypeScript but the documentation omits the parameter, which could confuse users who need access to the iteration result."},{"type":"text","text":"agentId: a3e8b27659affd8fc (for resuming to continue this agent's work if needed)\n<usage>total_tokens: 37209\ntool_uses: 9\nduration_ms: 80843</usage>"}]}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"cb75b43d-474b-4ca1-aba3-9eb7174a2fee","tool_use_result":{"status":"completed","prompt":"You are verifying that the README code examples for the `deep-factor-agent` library use the correct public API. \n\nRead /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md and cross-reference every import, function call, and type name against the actual source files:\n\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/index.ts (barrel exports)\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/create-agent.ts (factory)\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/agent.ts (DeepFactorAgent class)\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/stop-conditions.ts\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/middleware.ts\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/human-in-the-loop.ts\n- /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/src/types.ts\n\nCheck for:\n1. All imports reference names that are actually exported from src/index.ts\n2. Function signatures match (parameter names, types, return types)\n3. Settings object properties match DeepFactorAgentSettings interface\n4. Type names are correct\n5. The `stream()` method returns the correct type/shape (check what streamText returns in the agent.ts)\n6. The `requestHumanInput` is used correctly (it's a tool object, not a function call)\n7. The `resume()` method exists on PendingResult\n8. `AgentMiddleware` type has the correct shape (name, beforeIteration, afterIteration)\n\nReport any mismatches or errors you find. Be thorough.","agentId":"a3e8b27659affd8fc","content":[{"type":"text","text":"I now have all the information needed for a thorough cross-reference. Here is my complete audit report.\n\n---\n\n## README vs. Source Code Audit Report\n\n### 1. Imports from `deep-factor-agent` (checking against `src/index.ts`)\n\n**README Quick Start (line 39):**\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\n```\n- `createDeepFactorAgent` -- exported from `src/index.ts` line 56. **CORRECT**\n- `maxIterations` -- exported from `src/index.ts` line 32. **CORRECT**\n\n**README Stop Conditions (lines 103-110):**\n```typescript\nimport {\n  createDeepFactorAgent, maxIterations, maxTokens,\n  maxInputTokens, maxOutputTokens, maxCost,\n} from \"deep-factor-agent\";\n```\n- All five stop condition functions are exported from `src/index.ts` lines 32-36. **CORRECT**\n\n**README Human-in-the-loop (lines 131-134):**\n```typescript\nimport {\n  createDeepFactorAgent, requestHumanInput, maxIterations,\n} from \"deep-factor-agent\";\n```\n- `requestHumanInput` -- exported from `src/index.ts` line 59. **CORRECT**\n\n**README Middleware (lines 158-163):**\n```typescript\nimport {\n  createDeepFactorAgent, todoMiddleware, errorRecoveryMiddleware, maxIterations,\n} from \"deep-factor-agent\";\n```\n- `todoMiddleware` -- exported from `src/index.ts` line 45. **CORRECT**\n- `errorRecoveryMiddleware` -- exported from `src/index.ts` line 46. **CORRECT**\n\n**README Custom Middleware (line 178):**\n```typescript\nimport type { AgentMiddleware } from \"deep-factor-agent\";\n```\n- `AgentMiddleware` -- exported as a type from `src/index.ts` line 24. **CORRECT**\n\n**All import names resolve.** No phantom exports.\n\n---\n\n### 2. `createDeepFactorAgent` Settings Object Properties\n\nThe README uses these settings properties across examples:\n- `model` -- exists in `DeepFactorAgentSettings` (line 165 of types.ts). **CORRECT**\n- `instructions` -- exists (line 167). **CORRECT**\n- `tools` -- exists (line 166). **CORRECT**\n- `stopWhen` -- exists (line 168). **CORRECT**\n- `verifyCompletion` -- exists (line 169). **CORRECT**\n- `middleware` -- exists (line 170). **CORRECT**\n- `interruptOn` -- exists (line 171). **CORRECT**\n- `contextManagement` -- exists (line 172). **CORRECT**\n- `contextManagement.maxContextTokens` -- exists in `ContextManagementConfig` (line 138). **CORRECT**\n- `contextManagement.keepRecentIterations` -- exists (line 139). **CORRECT**\n\n**All settings properties match the interface.** No issues.\n\n---\n\n### 3. `verifyCompletion` Callback Signature\n\n**README (lines 91-94):**\n```typescript\nverifyCompletion: async ({ result }) => ({\n  complete: result.includes(\"°F\"),\n  reason: \"Response must contain a temperature\",\n}),\n```\n\n**Source `VerifyCompletion` type (types.ts line 133):**\n```typescript\nexport type VerifyCompletion = (ctx: VerifyContext) => Promise<VerifyResult>;\n```\n\n**`VerifyContext` (types.ts lines 121-126):**\n```typescript\nexport interface VerifyContext {\n  result: unknown;  // <--- type is `unknown`, not `string`\n  iteration: number;\n  thread: AgentThread;\n  originalPrompt: string;\n}\n```\n\n**ISSUE FOUND:** The README calls `result.includes(\"°F\")`, but `result` is typed as `unknown` in `VerifyContext`. Calling `.includes()` on `unknown` would be a TypeScript compile error. The user would need to cast or narrow `result` first, e.g., `(result as string).includes(\"°F\")` or add a type guard.\n\nHowever, looking at how the agent actually calls `verifyCompletion` (agent.ts line 501):\n```typescript\nconst verifyResult = await this.verifyCompletion({\n  result: lastResponse,  // lastResponse is `string`\n  ...\n});\n```\n\nSo at runtime `result` is always a string, but the type declaration says `unknown`. This is a mismatch between the runtime behavior and the type. The README example would fail type-checking. **Either the type in `VerifyContext.result` should be `string`, or the README example needs a type assertion.**\n\n**Severity: Medium.** The code would work at runtime but would not compile with strict TypeScript.\n\n---\n\n### 4. `AgentResult` Shape\n\n**README (lines 50-52):**\n```typescript\nconsole.log(result.response);   // \"The capital of France is Paris.\"\nconsole.log(result.iterations); // number of loop iterations used\nconsole.log(result.usage);      // { inputTokens, outputTokens, totalTokens }\n```\n\n**Source `AgentResult` (types.ts lines 179-190):**\n```typescript\nexport interface AgentResult {\n  response: string;\n  thread: AgentThread;\n  usage: TokenUsage;\n  iterations: number;\n  stopReason: \"completed\" | \"stop_condition\" | \"max_errors\" | \"human_input_needed\";\n  stopDetail?: string;\n}\n```\n\n- `result.response` -- exists as `string`. **CORRECT**\n- `result.iterations` -- exists as `number`. **CORRECT**\n- `result.usage` -- exists as `TokenUsage`. The comment `{ inputTokens, outputTokens, totalTokens }` matches `TokenUsage` (lines 95-101 of types.ts). **CORRECT** (though it omits the optional `cacheReadTokens` and `cacheWriteTokens`, that is fine for documentation)\n\n---\n\n### 5. `stream()` Method Return Type\n\n**README (lines 208-212):**\n```typescript\nconst stream = await agent.stream(\"Tell me a story.\");\n\nfor await (const chunk of stream.textStream) {\n  process.stdout.write(chunk);\n}\n```\n\n**Source `stream()` method (agent.ts lines 597-623):**\n```typescript\nstream(prompt: string): ReturnType<typeof streamText> {\n  ...\n  return streamText({ ... });\n}\n```\n\nThe `streamText` function from the Vercel AI SDK returns a `StreamTextResult`. This is NOT a Promise -- it is a synchronous call that returns an object with `textStream` and other properties. The README uses `await agent.stream(...)`, but `stream()` does NOT return a Promise. It returns `ReturnType<typeof streamText>` directly.\n\n**ISSUE FOUND:** The README uses `await agent.stream(...)` but the `stream()` method is synchronous (returns the `streamText(...)` result directly, which is not a Promise). The `await` is unnecessary and misleading, though it would not cause a runtime error (awaiting a non-Promise value just resolves to that value). The code would work, but it is technically incorrect and could confuse readers about the API.\n\nLooking more carefully at the Vercel AI SDK: `streamText()` returns a `StreamTextResult` which has a `textStream` property that is an `AsyncIterable<string>`. The `await` in the README is harmless but misleading.\n\n**Severity: Low.** Works at runtime due to JS/TS `await` being a no-op on non-Promises, but the API documentation is imprecise.\n\n---\n\n### 6. `requestHumanInput` Usage\n\n**README (lines 138-140):**\n```typescript\ntools: { requestHumanInput },\ninterruptOn: [\"requestHumanInput\"],\n```\n\n**Source (human-in-the-loop.ts lines 23-39):**\n```typescript\nexport const requestHumanInput = {\n  description: \"...\",\n  parameters: requestHumanInputSchema,\n  execute: async (args) => { ... },\n} as unknown as ToolSet[string];\n```\n\nThis is a tool object (not a function), and the README correctly uses it as a value in the `tools` object with shorthand property syntax. The `interruptOn` correctly references the key name `\"requestHumanInput\"`. **CORRECT**\n\n---\n\n### 7. `resume()` Method on `PendingResult`\n\n**README (lines 146-151):**\n```typescript\nif (result.stopReason === \"human_input_needed\") {\n  const finalResult = await result.resume(\"Blue\");\n  console.log(finalResult.response);\n}\n```\n\n**Source `PendingResult` (types.ts lines 192-195):**\n```typescript\nexport interface PendingResult extends AgentResult {\n  stopReason: \"human_input_needed\";\n  resume: (humanResponse: string) => Promise<AgentResult>;\n}\n```\n\n- `resume` exists on `PendingResult`. **CORRECT**\n- It takes a `string` argument (`humanResponse: string`). **CORRECT**\n- It returns `Promise<AgentResult>`. **CORRECT**\n\nHowever, `loop()` returns `Promise<AgentResult | PendingResult>` (agent.ts line 301). The README does a runtime check `result.stopReason === \"human_input_needed\"` to narrow, but TypeScript would not automatically narrow `AgentResult | PendingResult` to `PendingResult` via discriminant unless it can see that only `PendingResult` has `stopReason: \"human_input_needed\"`.\n\nLooking at the types: `AgentResult.stopReason` includes `\"human_input_needed\"` in its union (line 188), and `PendingResult.stopReason` narrows it to just `\"human_input_needed\"`. Because `AgentResult` also allows `stopReason: \"human_input_needed\"`, checking `result.stopReason === \"human_input_needed\"` does NOT narrow the type to `PendingResult` -- it remains `AgentResult | PendingResult`, and `AgentResult` does not have `resume`.\n\n**ISSUE FOUND:** The discriminant check `result.stopReason === \"human_input_needed\"` does not narrow `AgentResult | PendingResult` to `PendingResult` in TypeScript, because both types allow `stopReason` to be `\"human_input_needed\"`. The user would get a compile error on `result.resume(\"Blue\")` because `resume` does not exist on `AgentResult`.\n\nTo fix this, either:\n- Remove `\"human_input_needed\"` from `AgentResult.stopReason` (so it becomes a proper discriminant), OR\n- Add a type guard like `if ('resume' in result)`, OR\n- The README should show a cast: `(result as PendingResult).resume(\"Blue\")`\n\n**Severity: High.** This is a compile error in the README example as written.\n\n---\n\n### 8. `AgentMiddleware` Type Shape\n\n**README (lines 181-189):**\n```typescript\nconst loggingMiddleware: AgentMiddleware = {\n  name: \"logging\",\n  beforeIteration: async (ctx) => {\n    console.log(`Starting iteration ${ctx.iteration}`);\n  },\n  afterIteration: async (ctx) => {\n    console.log(`Finished iteration ${ctx.iteration}`);\n  },\n};\n```\n\n**Source `AgentMiddleware` (types.ts lines 150-158):**\n```typescript\nexport interface AgentMiddleware {\n  name: string;\n  tools?: ToolSet;\n  beforeIteration?: (ctx: MiddlewareContext) => Promise<void>;\n  afterIteration?: (ctx: MiddlewareContext, result: unknown) => Promise<void>;\n}\n```\n\n**ISSUE FOUND:** The `afterIteration` hook has a second parameter `result: unknown` in the actual type definition, but the README example only destructures `ctx` with no second parameter:\n```typescript\nafterIteration: async (ctx) => { ... }\n```\n\nThis is technically valid TypeScript (you can ignore trailing parameters), so it would compile and run. However, the README is showing an incomplete signature and not documenting the `result` parameter. This is a **documentation gap** rather than an error.\n\n**Severity: Very Low.** Compiles fine, but the reader does not learn about the `result` parameter.\n\n---\n\n### 9. Defaults Table\n\n**README (lines 236-247):**\n\n| Setting | Default |\n|---|---|\n| `tools` | `{}` |\n| `instructions` | `\"\"` |\n| `stopWhen` | `[maxIterations(10)]` |\n| `verifyCompletion` | `undefined` |\n| `middleware` | `[todoMiddleware(), errorRecoveryMiddleware()]` |\n| `interruptOn` | `[]` |\n| `contextManagement.maxContextTokens` | `150000` |\n| `contextManagement.keepRecentIterations` | `3` |\n\n**Source `createDeepFactorAgent` (create-agent.ts lines 10-26):**\n```typescript\ntools: settings.tools ?? ({} as TTools),\ninstructions: settings.instructions ?? \"\",\nstopWhen: settings.stopWhen ?? [maxIterations(10)],\nmiddleware: settings.middleware ?? [todoMiddleware(), errorRecoveryMiddleware()],\ninterruptOn: settings.interruptOn ?? [],\ncontextManagement: { maxContextTokens: 150000, keepRecentIterations: 3, ...settings.contextManagement },\n```\n\nAll defaults match. **CORRECT**\n\n---\n\n### 10. API Reference Table Accuracy\n\n- `addUsage(a, b)` -- exported from `src/index.ts` line 53. **CORRECT**\n- `DeepFactorAgent` -- exported from `src/index.ts` line 53. **CORRECT**\n- `ContextManager` -- exported from `src/index.ts` line 50. **CORRECT**\n- `estimateTokens` -- exported from `src/index.ts` line 50. **CORRECT**\n- `composeMiddleware` -- exported from `src/index.ts` line 44. **CORRECT**\n- `evaluateStopConditions` -- exported from `src/index.ts` line 39. **CORRECT**\n- `calculateCost` -- exported from `src/index.ts` line 37. **CORRECT**\n- `MODEL_PRICING` -- exported from `src/index.ts` line 38. **CORRECT**\n\nAll API reference table entries match actual exports. **CORRECT**\n\n---\n\n## Summary of Issues Found\n\n### High Severity\n\n1. **`PendingResult` discriminant narrowing does not work (README lines 146-151).** The `stopReason === \"human_input_needed\"` check does not narrow `AgentResult | PendingResult` to `PendingResult` because `AgentResult.stopReason` also includes `\"human_input_needed\"` in its union. Calling `result.resume(\"Blue\")` would be a TypeScript compile error. Fix either the types (remove `\"human_input_needed\"` from `AgentResult.stopReason`) or the README (add a type guard or cast).\n\n### Medium Severity\n\n2. **`VerifyContext.result` is typed as `unknown` but the README calls `.includes()` on it (README line 92).** The actual runtime value is always a `string` (agent.ts line 501 passes `lastResponse: string`), but the type says `unknown`. Either change the type to `string` or update the README example to include a type assertion.\n\n### Low Severity\n\n3. **`stream()` is not async, but the README uses `await` (README line 208).** The `stream()` method returns `ReturnType<typeof streamText>` synchronously. The `await` is a no-op and harmless but misleading.\n\n4. **`afterIteration` middleware hook has a second `result` parameter not shown in the README example (README line 187).** Valid TypeScript but the documentation omits the parameter, which could confuse users who need access to the iteration result."}],"totalDurationMs":80843,"totalTokens":37209,"totalToolUseCount":9,"usage":{"input_tokens":1,"cache_creation_input_tokens":1752,"cache_read_input_tokens":31483,"output_tokens":3973,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":1752,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_019K5SAgyGdZapTrT8mMDQZr","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The audit found several issues. Let me address them:\n\n1. **High: PendingResult discriminant narrowing** - The `stopReason === \"human_input_needed\"` check doesn't narrow the type because `AgentResult.stopReason` also includes `\"human_input_needed\"`. I should fix the README to use `'resume' in result` as a type guard instead.\n\n2. **Medium: VerifyContext.result is `unknown`** - The README calls `.includes()` on it. I should either fix the type or update the README example. Since the task is README only, I'll update the README to cast it.\n\n\n3. **Low: `stream()` uses `await`** - Harmless but misleading, so I'll remove it.\n\n4. **Very Low: `afterIteration` second parameter** - This is fine, omitting trailing params is valid TS.\n\nActually, I'm reconsidering the scope here. The implementation plan says no code changes, but the audit revealed real type issues—`VerifyContext.result` being `unknown` when it should be `string`, and the `PendingResult` discriminant narrowing problem. I need to update the README examples to work correctly with the actual types rather than pretending they're different.\n\nFor the type issues themselves, I should document them in IMPLEMENTATION_PLAN.md as instructed. Let me update the README by fixing the HITL example to use the `'resume' in result` check, casting the result in the verifyCompletion example, and removing that unnecessary `await`.\n\nWait, I'm realizing the discriminant narrowing might actually work here. Since `AgentResult.stopReason` is a union of four values and `PendingResult.stopReason` is just `\"human_input_needed\"`, checking `result.stopReason === \"human_input_needed\"` should narrow the type correctly.\n\nActually no, that won't work because `AgentResult` also includes that value, so TypeScript can't distinguish between them. The `'resume' in result` check is the right approach since it's a property that only exists on `PendingResult`. I'll use that for the HITL example, add a type assertion for the verifyCompletion case, and remove the `await` from the stream call.","signature":"EtwTCkYICxgCKkDtIauRfzDFwS7Je+gSvNG1AobftyKNpIkpvySybrf8sKYuXbv460NHGdIk8ML8tIVWfSejpRNwXxvnu2ZUGVdTEgyHF3gNbXwxKlkx3JkaDCM+P28cBGGMVNPaHiIwaFWdbCvT9+Oj6f29yVdP9z3rFu0vktaMro9Wqt1tOvEFraKPGyRyOa5w26U9EnpuKsMSH5tLB8hDnfxdoc0gbRLnNNsPohun9dGxI1uEXRBlbK6QMwYhZSfzYwzvRtm2TDJazuJBa9BBJSzHIRICg1u0zHaVH4po7ynJFudOqQLNy7BFyiiYCvbOq7t2gGuG8eFz1m84T5dU6UQeYXHYgLT3kaKjo7ZWwXCWY7e8Lr6W9jBNYAOk2gCMRdHUwb/oo+pNJ12ZHtZbIW0mgv5ycVtIcoSERP/A/q15ExjBDK+Cq5az6c+acXwIoswIHuwLeML/TADPsd5FJpIJXV3xI2p7MNv01Lnsac5Q19dvbD26nhkufMB2k8PXTsXZnwaFZ88OQZIyI3E6KdFyTd4rHnV3WMoj/i5DaFr1q+OPyiGY1WZOj7C/uNnSfz9MJhRNFOmeU+Uh01G7CSPyOn8VtZklLhbTTqivryNm2MR/lhDRz3gjRTxxUvS+Mmj0gdCSGnTGjBChcmEtAOKUR+xDP6dqhldyMPO3O71gZpzm+QBCNXBFj9flRiOLV6DTCyw/+qhIJV52/PO06ILrlbNuPUk0vU+yb6a1FuFxSOTGu0OPy28l0/3scD3IfN3l0NKJqD781xdq6cumW7WbZ8LnRygOrDqkCso/rjl++RGH5Lm+EYlV8uFzvsKbT4bef+YoqBuMiyR0GxPxz/onp9cYJqjsn7szVnF1BLjPBp3RTtjqq5zvwRwm+p+6C8l24n1ao1Alc5xoperehMaUO5IvOPevFZYy+cfjM8GslQDU6pCiV+ZPu2Jd2Ba6/u1on5hCBpW/pSJv8i1jal4wX/yVSpl2EJ0b+TLqZ4fcW4s7PQdBk71cqkYVc/zcM22+Fc0re/Kyk9ZQHogmOzamXKI7wtg57YyJmEE9V+n0JBA6v5ilOrLkovs30z4AAzCUBZzQx2WhIhwp3t68eldeMTEGTBJrPEuDXKQXzB/HI2eE0KLaJEsXNivwwdONzAcj92jJmaQnw09QdvYCkwwD5RlU5BUG0kcARy2ferBd5PQs1ME15NvTvevtwQ7LqGLvxAH4rrM9OuzAAkRgyKiVjbXznIt2hkTzirGwpoEMzFKTI4gEmilAabbp6p5xVTodz7dfwAliJwiemni9A/CCwdfp8MnWW9+LcPsgvYiyOKEDZ8dJ8InqXFEUOhC+2/GywkrAO+pxP2fZJ44jaxhO5elkQD2JnBrkO4y+tzgSXN9+LgWYMIZo5LQYAY5cAZITAyNODlppTqUkVHaUFUPokw/C4fiQxYDOSYwHVnBpUw5xM8npWVHTLPtPVnhedZH7Pykm8j9p4GlU4ZK5em3LuwUQL60MT0UOxEcS57QlrVWqIJnJNAseJ/PZtzFwEVD1RppKR2Z0I4u23uLJWfHkmwYDQ5DDHTm8Io0/KH1X+eFST+5+81iTuTXK/ZwpSyn86SKEBouaccOAJkzl/MM7T5nh+E/ZzNYzJOVlel4tZd9AXeMi/F/GlETE0f8dMsSmhCTPWDTX3UrVKHX4OI/DHky1r0JrGinYEXoTxMV/4OPSShJfrmxkibkJktGh7fzWYj1/c7gUBcWdZ+PZ8PP0aWl+5/j0ehnuVaJLoRh16p6TcnMPUJXZPNY3o4jfBzUmgFQUJ9Gh/L92tSB5JcQWjweGtCQstc64VDPtjYUCrKWpsJc1KWPlrfkaksc31AZvX1yReWw6A/WqMIaEJukHDCC/rqIMVsZBb5oThkWVeoVLIGJ6nFZO1OMhOX6oWPCirvwKK3I8h+kpVxzRnV9rEmKCRUB6rxkE/3Xda0J3HKWP1Izc/+dE2QrZctI3wqXepqZs5fnfiRIxOG30n2Cd2CTIVBRiEKMeKCLE4F0dF3SsaqcXOd8mjcB9q5wjdMM5PQYOnVNOR+qjUsgwP2yZSbV+FZxseFVAy88+Fjiu9tsKIAx58XAUJu3hZem2K3MlvIg4y9i6wRWxRZKmYRYmlc8pOa28B4d/EgtO1nK1ADUwUQVwEC+KoUWmNLgFDB4xwPXp53dtJbYRqZa8WwAPdgnHdG6tIvceZeI5dw5wi54KOGyWjpfHcxWObWodaY8vKdWAZ/vOEUKFxh0Gly4e9f44fJNM9EbfSo7y5l2+YO5FO79pGr9bF7jasiBn4nSrZdh7P5H2AyKdYhHQ8JT3U4ZqNlPeAjKYGn4B/C3RbeTq81gzqNTTCY8g/OUpnavBANAfil35koJlfbFhrdWWBc8tT+eL63KLezrwSot6hS1J6s3v+yLt1IPO9Apf11aJ2w2+LNIBLXe87Mzyonz8qtVonimbj5r8XFrwqDI1WPQhmnucpdVxY3IgWi4haW3PXrwK3ZqShvgIFPaHuAum+eInXh+wpi3s10KmFcgSRP3JgctCrppN+F3ZTXSlsuefG9MTDvzl1kgoU0wqwvAaGLg96sGoGnVUcjrV5oYukK8Ts4LcWN9p1qHPjz7Z4kq5EniAXVKqbOXEmhcWiYGUuu5Xc5b8py/VdCwGEqPau1iishTZgf5oMicC32CKCGlrXxLtzZHxxfidTBHq0BSE+M5lLAjZS7LKf8Rt9YXLrZEK74+uHfI0/25JdzKTjk2stm/UfBua5Ti+3oSrj/lc5VAx6J8XZGGrfvyvygJHV3XSDFcRrLdR1voenhi6hUjFYtimFdHcAOQC9UHT6V8Y3cAFUA/hzxvyJ5w23JH+JTCd9b97l6acluD3tugP+SrROXfWVhqC60Kj6bKvE/xlMi07sGnwYXDDZ9Utlfm7sGmudVKAIysc/1s7ivcfqOmzy9Wq1t9n8yaRLCTDbpvQcrwAZe3h6Keddzv1hbW76neA9jRnL9ai9I6BcYBhrrCB0kHvp29GM0bPM0yLpZS9Jw8/hklXOb1F3ZxAgyS8Akm3B2MPKcszfCA0kCH0wCzPv5W0Z5L20Uqz0GZwcuyEE8ddplLGfXsgsXoLKCcecUBKuyPA32EPkP8ZzsN99ylEwd+JqMiFgFGDwapxYK5w9VjfGKPo8LoKnGjN+IdrLOVeJzmDtj/qWTLpnhEi70gc9/j0h62jYWiCtplovwdpzpoPr19qKQ2SS1NCB7g4S2eS+ruSaci8w7WDkMkdmdWG+mnUVmPGA1Hm6jRcUCVYOqNEObbteGatZdpgPDOTlZbrGw4cvJVXFa/HeUy37bJlIQeIAmnM+PJp9iKqyMkmTYuCykoL9qIzhhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":4606,"cache_read_input_tokens":38895,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":4606},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"dbc96e99-82a8-473a-8547-37bbe1ae8e4b"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_019K5SAgyGdZapTrT8mMDQZr","type":"message","role":"assistant","content":[{"type":"text","text":"The audit found a few issues. Let me fix them in the README."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":4606,"cache_read_input_tokens":38895,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":4606},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"b51f6f3c-f3a3-4940-86a3-74c4c1664cf5"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_019K5SAgyGdZapTrT8mMDQZr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01K5drP2WKGKEUXMMhZTbkhc","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md","offset":85,"limit":20},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":4606,"cache_read_input_tokens":38895,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":4606},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"c8df86ae-4891-4296-a2ea-f52fdccca942"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01K5drP2WKGKEUXMMhZTbkhc","type":"tool_result","content":"    85→      description: \"Get weather for a city\",\n    86→      parameters: z.object({ city: z.string() }),\n    87→      execute: async ({ city }) => `72°F and sunny in ${city}`,\n    88→    },\n    89→  },\n    90→  stopWhen: [maxIterations(10)],\n    91→  verifyCompletion: async ({ result }) => ({\n    92→    complete: result.includes(\"°F\"),\n    93→    reason: \"Response must contain a temperature\",\n    94→  }),\n    95→});\n    96→\n    97→const result = await agent.loop(\"What's the weather in Austin?\");\n    98→```\n    99→\n   100→### Stop conditions\n   101→\n   102→```typescript\n   103→import {\n   104→  createDeepFactorAgent,"}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"cdaf7f3e-6300-4f85-941a-2f51c7ffc04a","tool_use_result":{"type":"text","file":{"filePath":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md","content":"      description: \"Get weather for a city\",\n      parameters: z.object({ city: z.string() }),\n      execute: async ({ city }) => `72°F and sunny in ${city}`,\n    },\n  },\n  stopWhen: [maxIterations(10)],\n  verifyCompletion: async ({ result }) => ({\n    complete: result.includes(\"°F\"),\n    reason: \"Response must contain a temperature\",\n  }),\n});\n\nconst result = await agent.loop(\"What's the weather in Austin?\");\n```\n\n### Stop conditions\n\n```typescript\nimport {\n  createDeepFactorAgent,","numLines":20,"startLine":85,"totalLines":351}}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01CKdKtfHrY1Vpk1vUKQU7EA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018Q7j7zP3iWopKY8FtxJq4B","name":"Edit","input":{"replace_all":false,"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md","old_string":"  verifyCompletion: async ({ result }) => ({\n    complete: result.includes(\"°F\"),\n    reason: \"Response must contain a temperature\",\n  }),","new_string":"  verifyCompletion: async ({ result }) => ({\n    complete: typeof result === \"string\" && result.includes(\"°F\"),\n    reason: \"Response must contain a temperature\",\n  }),"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":984,"cache_read_input_tokens":43501,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":984},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"792355f7-3067-499f-878c-0dc6962ddd7f"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018Q7j7zP3iWopKY8FtxJq4B","type":"tool_result","content":"The file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"a2d5dd2f-c501-44e0-b578-23c13d0cb7c4","tool_use_result":{"filePath":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md","oldString":"  verifyCompletion: async ({ result }) => ({\n    complete: result.includes(\"°F\"),\n    reason: \"Response must contain a temperature\",\n  }),","newString":"  verifyCompletion: async ({ result }) => ({\n    complete: typeof result === \"string\" && result.includes(\"°F\"),\n    reason: \"Response must contain a temperature\",\n  }),","originalFile":"# deep-factor-agent\n\nA TypeScript library for building loop-based AI agents with middleware, verification, stop conditions, human-in-the-loop, and context management — aligned with the [12-factor agent](https://github.com/humanlayer/12-factor-agents) methodology.\n\n## Overview\n\n`deep-factor-agent` wraps the [Vercel AI SDK v6](https://sdk.vercel.ai/) in an opinionated agent loop that gives you fine-grained control over iteration limits, cost guardrails, completion verification, context window management, and human escalation — all through a declarative configuration surface.\n\n**Why a loop-based agent?** Single-shot LLM calls are rarely enough for non-trivial tasks. An agentic loop lets the model call tools, observe results, reflect, and iterate until the task is truly done — while stop conditions and middleware keep execution safe and observable.\n\n### Key capabilities\n\n- **Agentic loop** — iterative tool-calling with automatic message history\n- **Stop conditions** — cap iterations, tokens, or dollar cost\n- **Completion verification** — optionally verify the agent actually finished the task\n- **Middleware** — inject tools and lifecycle hooks (built-in: todo tracking, error recovery)\n- **Human-in-the-loop** — pause execution, collect human input, and resume\n- **Context management** — automatic summarization when the context window fills up\n- **Streaming** — stream the first LLM turn for real-time UIs\n\n## Installation\n\n```bash\npnpm add deep-factor-agent ai zod\n```\n\n`ai` (Vercel AI SDK v6+) is a runtime dependency. `zod` (v4+) is a **peer dependency** — you must install it yourself.\n\nYou also need a model provider, e.g.:\n\n```bash\npnpm add @ai-sdk/anthropic\n# or @ai-sdk/openai, @ai-sdk/google, etc.\n```\n\n## Quick Start\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  instructions: \"You are a helpful assistant.\",\n  stopWhen: [maxIterations(5)],\n});\n\nconst result = await agent.loop(\"What is the capital of France?\");\n\nconsole.log(result.response);   // \"The capital of France is Paris.\"\nconsole.log(result.iterations); // number of loop iterations used\nconsole.log(result.usage);      // { inputTokens, outputTokens, totalTokens }\n```\n\n## Usage Examples\n\n### Minimal agent (model only)\n\n```typescript\nimport { createDeepFactorAgent } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n});\n\nconst result = await agent.loop(\"Hello!\");\nconsole.log(result.response);\n```\n\nAll other settings use sensible defaults — see the [Defaults table](#defaults) below.\n\n### Agent with tools and verification\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\nimport { z } from \"zod\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  instructions: \"Use the weather tool to answer weather questions.\",\n  tools: {\n    getWeather: {\n      description: \"Get weather for a city\",\n      parameters: z.object({ city: z.string() }),\n      execute: async ({ city }) => `72°F and sunny in ${city}`,\n    },\n  },\n  stopWhen: [maxIterations(10)],\n  verifyCompletion: async ({ result }) => ({\n    complete: result.includes(\"°F\"),\n    reason: \"Response must contain a temperature\",\n  }),\n});\n\nconst result = await agent.loop(\"What's the weather in Austin?\");\n```\n\n### Stop conditions\n\n```typescript\nimport {\n  createDeepFactorAgent,\n  maxIterations,\n  maxTokens,\n  maxInputTokens,\n  maxOutputTokens,\n  maxCost,\n} from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  stopWhen: [\n    maxIterations(20),          // stop after 20 loop iterations\n    maxTokens(100_000),         // stop at 100k total tokens\n    maxInputTokens(80_000),     // stop at 80k input tokens\n    maxOutputTokens(20_000),    // stop at 20k output tokens\n    maxCost(0.50),              // stop at $0.50 spend\n  ],\n});\n```\n\nMultiple conditions can be combined — the first one that triggers ends the loop.\n\n### Human-in-the-loop\n\n```typescript\nimport {\n  createDeepFactorAgent,\n  requestHumanInput,\n  maxIterations,\n} from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  tools: { requestHumanInput },\n  interruptOn: [\"requestHumanInput\"],\n  stopWhen: [maxIterations(10)],\n});\n\nconst result = await agent.loop(\"Ask the user what color they prefer.\");\n\nif (result.stopReason === \"human_input_needed\") {\n  console.log(\"Agent is waiting for input\");\n\n  // Provide the human's answer and resume the loop\n  const finalResult = await result.resume(\"Blue\");\n  console.log(finalResult.response);\n}\n```\n\n### Middleware\n\n```typescript\nimport {\n  createDeepFactorAgent,\n  todoMiddleware,\n  errorRecoveryMiddleware,\n  maxIterations,\n} from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\n// Built-in middleware (these are the defaults)\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  middleware: [todoMiddleware(), errorRecoveryMiddleware()],\n  stopWhen: [maxIterations(10)],\n});\n```\n\n**Custom middleware:**\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport type { AgentMiddleware } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst loggingMiddleware: AgentMiddleware = {\n  name: \"logging\",\n  beforeIteration: async (ctx) => {\n    console.log(`Starting iteration ${ctx.iteration}`);\n  },\n  afterIteration: async (ctx) => {\n    console.log(`Finished iteration ${ctx.iteration}`);\n  },\n};\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  middleware: [loggingMiddleware],\n  stopWhen: [maxIterations(5)],\n});\n```\n\n### Streaming\n\n```typescript\nimport { createDeepFactorAgent } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n});\n\nconst stream = await agent.stream(\"Tell me a story.\");\n\nfor await (const chunk of stream.textStream) {\n  process.stdout.write(chunk);\n}\n```\n\n### Context management\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  stopWhen: [maxIterations(50)],\n  contextManagement: {\n    maxContextTokens: 100_000,  // summarize when context exceeds this\n    keepRecentIterations: 5,    // always keep the last 5 iterations intact\n  },\n});\n```\n\nWhen the context window fills up, older iterations are automatically summarized by the model so the agent can keep working without losing important history.\n\n## Defaults\n\nWhen using `createDeepFactorAgent`, unspecified settings receive these defaults:\n\n| Setting | Default |\n|---|---|\n| `tools` | `{}` (no tools) |\n| `instructions` | `\"\"` (empty) |\n| `stopWhen` | `[maxIterations(10)]` |\n| `verifyCompletion` | `undefined` (no verification) |\n| `middleware` | `[todoMiddleware(), errorRecoveryMiddleware()]` |\n| `interruptOn` | `[]` (no interruptions) |\n| `contextManagement.maxContextTokens` | `150000` |\n| `contextManagement.keepRecentIterations` | `3` |\n\n## API Reference\n\n### Factory\n\n| Export | Description |\n|---|---|\n| `createDeepFactorAgent(settings)` | Creates a `DeepFactorAgent` with sensible defaults. The primary entry point. |\n\n### Agent Class\n\n| Export | Description |\n|---|---|\n| `DeepFactorAgent` | Core agent class. Use `createDeepFactorAgent` unless you need full control. |\n| `.loop(prompt)` | Run the agentic loop. Returns `AgentResult` or `PendingResult`. |\n| `.stream(prompt)` | Stream the first LLM turn (non-looping). Returns the AI SDK stream result. |\n| `addUsage(a, b)` | Merge two `TokenUsage` objects by summing their fields. |\n\n### Stop Conditions\n\n| Export | Description |\n|---|---|\n| `maxIterations(n)` | Stop after `n` loop iterations. |\n| `maxTokens(n)` | Stop when total tokens reach `n`. |\n| `maxInputTokens(n)` | Stop when input tokens reach `n`. |\n| `maxOutputTokens(n)` | Stop when output tokens reach `n`. |\n| `maxCost(dollars, model?)` | Stop when estimated cost reaches `dollars`. |\n| `calculateCost(usage, model)` | Calculate cost for a given `TokenUsage` and model name. |\n| `MODEL_PRICING` | Built-in pricing table for common models (Anthropic, OpenAI, Google). |\n| `evaluateStopConditions(conditions, ctx)` | Evaluate an array of stop conditions against a context. |\n\n### Middleware\n\n| Export | Description |\n|---|---|\n| `composeMiddleware(middlewares)` | Compose an array of `AgentMiddleware` into a single middleware with merged tools and chained hooks. |\n| `todoMiddleware()` | Built-in middleware that gives the agent `write_todos` and `read_todos` tools. |\n| `errorRecoveryMiddleware()` | Built-in middleware that injects recovery guidance after errors. |\n\n### Context Management\n\n| Export | Description |\n|---|---|\n| `ContextManager` | Manages context window size by summarizing old iterations when the token limit is exceeded. |\n| `estimateTokens(text)` | Approximate token count for a string (~1 token per 3.5 characters). |\n\n### Human-in-the-Loop\n\n| Export | Description |\n|---|---|\n| `requestHumanInput` | A tool that pauses the agent loop to collect human input. Use with `interruptOn: [\"requestHumanInput\"]`. |\n\n### Types\n\nAll types are exported for use in your code:\n\n| Type | Description |\n|---|---|\n| `DeepFactorAgentSettings<TTools>` | Configuration for `createDeepFactorAgent`. |\n| `AgentResult` | Return type of `loop()` — contains `response`, `thread`, `usage`, `iterations`, `stopReason`. |\n| `PendingResult` | Extends `AgentResult` when `stopReason` is `\"human_input_needed\"` — adds `resume(input)`. |\n| `AgentThread` | The conversation thread with `id`, `events`, `metadata`. |\n| `TokenUsage` | Token counts: `inputTokens`, `outputTokens`, `totalTokens`, optional cache fields. |\n| `StopCondition` | A function `(ctx: StopConditionContext) => StopConditionResult`. |\n| `StopConditionContext` | Context passed to stop conditions: `iteration`, `usage`, `model`, `thread`. |\n| `StopConditionResult` | Result from a stop condition: `{ stop: boolean, reason?: string }`. |\n| `VerifyCompletion` | Async function to verify the agent completed its task. |\n| `VerifyContext` | Context passed to `verifyCompletion`: `result`, `iteration`, `thread`, `originalPrompt`. |\n| `VerifyResult` | Result from verification: `{ complete: boolean, reason?: string }`. |\n| `AgentMiddleware` | Middleware definition with `name`, optional `tools`, and lifecycle hooks. |\n| `MiddlewareContext` | Context passed to middleware hooks: `thread`, `iteration`, `settings`. |\n| `ContextManagementConfig` | Config for context management: `maxContextTokens`, `keepRecentIterations`. |\n| `AgentEvent` | Discriminated union of all event types in the thread. |\n\n## Architecture: 12-Factor Agent Alignment\n\nThis library is designed around the [12-factor agent](https://github.com/humanlayer/12-factor-agents) principles:\n\n1. **Natural language to tool calls** — the agent loop translates prompts into tool invocations\n2. **Own your prompts** — `instructions` are plain strings you control, not hidden behind abstractions\n3. **Own your context window** — `ContextManager` gives you explicit control over context size and summarization\n4. **Tools are just functions** — standard Vercel AI SDK tool definitions, no proprietary wrapper\n5. **Unified LLM interface** — any model provider supported by the AI SDK works out of the box\n6. **Use structured outputs** — Zod schemas for tool parameters and validation\n7. **Own your control flow** — the loop, stop conditions, and middleware are all configurable\n8. **Compact errors into context** — `errorRecoveryMiddleware` feeds truncated errors back into the conversation\n9. **Own your threads** — `AgentThread` gives you full access to conversation history and metadata\n10. **Small, focused agents** — the library encourages composing single-purpose agents\n11. **Trigger from anywhere** — `loop()` and `stream()` can be called from any runtime (server, CLI, edge)\n12. **Make agents observable** — thread events, token tracking, and lifecycle callbacks provide full visibility\n\n## Development\n\n```bash\npnpm install        # install dependencies\npnpm build          # compile TypeScript\npnpm test           # run tests (vitest)\npnpm type-check     # type-check without emitting\npnpm dev            # watch mode\n```\n\n## License\n\nMIT\n","structuredPatch":[{"oldStart":89,"oldLines":7,"newStart":89,"newLines":7,"lines":["   },","   stopWhen: [maxIterations(10)],","   verifyCompletion: async ({ result }) => ({","-    complete: result.includes(\"°F\"),","+    complete: typeof result === \"string\" && result.includes(\"°F\"),","     reason: \"Response must contain a temperature\",","   }),"," });"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01WbWNNRTJnasgnVSTzMN1u9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JNEy1oZe4C4K97TKqd41wi","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md","offset":140,"limit":20},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":256,"cache_read_input_tokens":44485,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":256},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"33a27ab6-9558-4aab-9298-1855bd5720f1"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JNEy1oZe4C4K97TKqd41wi","type":"tool_result","content":"   140→  interruptOn: [\"requestHumanInput\"],\n   141→  stopWhen: [maxIterations(10)],\n   142→});\n   143→\n   144→const result = await agent.loop(\"Ask the user what color they prefer.\");\n   145→\n   146→if (result.stopReason === \"human_input_needed\") {\n   147→  console.log(\"Agent is waiting for input\");\n   148→\n   149→  // Provide the human's answer and resume the loop\n   150→  const finalResult = await result.resume(\"Blue\");\n   151→  console.log(finalResult.response);\n   152→}\n   153→```\n   154→\n   155→### Middleware\n   156→\n   157→```typescript\n   158→import {\n   159→  createDeepFactorAgent,"}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"91c1e3af-8ce3-46b2-9cf6-ae86b856de3d","tool_use_result":{"type":"text","file":{"filePath":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md","content":"  interruptOn: [\"requestHumanInput\"],\n  stopWhen: [maxIterations(10)],\n});\n\nconst result = await agent.loop(\"Ask the user what color they prefer.\");\n\nif (result.stopReason === \"human_input_needed\") {\n  console.log(\"Agent is waiting for input\");\n\n  // Provide the human's answer and resume the loop\n  const finalResult = await result.resume(\"Blue\");\n  console.log(finalResult.response);\n}\n```\n\n### Middleware\n\n```typescript\nimport {\n  createDeepFactorAgent,","numLines":20,"startLine":140,"totalLines":351}}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01EWoGnm9rDJPM1XonCqVBtQ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BtcVDPrekmL7KQN55nndfJ","name":"Edit","input":{"replace_all":false,"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md","old_string":"if (result.stopReason === \"human_input_needed\") {\n  console.log(\"Agent is waiting for input\");\n\n  // Provide the human's answer and resume the loop\n  const finalResult = await result.resume(\"Blue\");\n  console.log(finalResult.response);\n}","new_string":"if (\"resume\" in result) {\n  console.log(\"Agent is waiting for input\");\n\n  // Provide the human's answer and resume the loop\n  const finalResult = await result.resume(\"Blue\");\n  console.log(finalResult.response);\n}"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":321,"cache_read_input_tokens":44741,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":321},"output_tokens":24,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"ae0462de-a906-4b39-afe1-12295e5684d0"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BtcVDPrekmL7KQN55nndfJ","type":"tool_result","content":"The file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"04bca6e7-cfbb-4551-92fd-6426cc461f4d","tool_use_result":{"filePath":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md","oldString":"if (result.stopReason === \"human_input_needed\") {\n  console.log(\"Agent is waiting for input\");\n\n  // Provide the human's answer and resume the loop\n  const finalResult = await result.resume(\"Blue\");\n  console.log(finalResult.response);\n}","newString":"if (\"resume\" in result) {\n  console.log(\"Agent is waiting for input\");\n\n  // Provide the human's answer and resume the loop\n  const finalResult = await result.resume(\"Blue\");\n  console.log(finalResult.response);\n}","originalFile":"# deep-factor-agent\n\nA TypeScript library for building loop-based AI agents with middleware, verification, stop conditions, human-in-the-loop, and context management — aligned with the [12-factor agent](https://github.com/humanlayer/12-factor-agents) methodology.\n\n## Overview\n\n`deep-factor-agent` wraps the [Vercel AI SDK v6](https://sdk.vercel.ai/) in an opinionated agent loop that gives you fine-grained control over iteration limits, cost guardrails, completion verification, context window management, and human escalation — all through a declarative configuration surface.\n\n**Why a loop-based agent?** Single-shot LLM calls are rarely enough for non-trivial tasks. An agentic loop lets the model call tools, observe results, reflect, and iterate until the task is truly done — while stop conditions and middleware keep execution safe and observable.\n\n### Key capabilities\n\n- **Agentic loop** — iterative tool-calling with automatic message history\n- **Stop conditions** — cap iterations, tokens, or dollar cost\n- **Completion verification** — optionally verify the agent actually finished the task\n- **Middleware** — inject tools and lifecycle hooks (built-in: todo tracking, error recovery)\n- **Human-in-the-loop** — pause execution, collect human input, and resume\n- **Context management** — automatic summarization when the context window fills up\n- **Streaming** — stream the first LLM turn for real-time UIs\n\n## Installation\n\n```bash\npnpm add deep-factor-agent ai zod\n```\n\n`ai` (Vercel AI SDK v6+) is a runtime dependency. `zod` (v4+) is a **peer dependency** — you must install it yourself.\n\nYou also need a model provider, e.g.:\n\n```bash\npnpm add @ai-sdk/anthropic\n# or @ai-sdk/openai, @ai-sdk/google, etc.\n```\n\n## Quick Start\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  instructions: \"You are a helpful assistant.\",\n  stopWhen: [maxIterations(5)],\n});\n\nconst result = await agent.loop(\"What is the capital of France?\");\n\nconsole.log(result.response);   // \"The capital of France is Paris.\"\nconsole.log(result.iterations); // number of loop iterations used\nconsole.log(result.usage);      // { inputTokens, outputTokens, totalTokens }\n```\n\n## Usage Examples\n\n### Minimal agent (model only)\n\n```typescript\nimport { createDeepFactorAgent } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n});\n\nconst result = await agent.loop(\"Hello!\");\nconsole.log(result.response);\n```\n\nAll other settings use sensible defaults — see the [Defaults table](#defaults) below.\n\n### Agent with tools and verification\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\nimport { z } from \"zod\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  instructions: \"Use the weather tool to answer weather questions.\",\n  tools: {\n    getWeather: {\n      description: \"Get weather for a city\",\n      parameters: z.object({ city: z.string() }),\n      execute: async ({ city }) => `72°F and sunny in ${city}`,\n    },\n  },\n  stopWhen: [maxIterations(10)],\n  verifyCompletion: async ({ result }) => ({\n    complete: typeof result === \"string\" && result.includes(\"°F\"),\n    reason: \"Response must contain a temperature\",\n  }),\n});\n\nconst result = await agent.loop(\"What's the weather in Austin?\");\n```\n\n### Stop conditions\n\n```typescript\nimport {\n  createDeepFactorAgent,\n  maxIterations,\n  maxTokens,\n  maxInputTokens,\n  maxOutputTokens,\n  maxCost,\n} from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  stopWhen: [\n    maxIterations(20),          // stop after 20 loop iterations\n    maxTokens(100_000),         // stop at 100k total tokens\n    maxInputTokens(80_000),     // stop at 80k input tokens\n    maxOutputTokens(20_000),    // stop at 20k output tokens\n    maxCost(0.50),              // stop at $0.50 spend\n  ],\n});\n```\n\nMultiple conditions can be combined — the first one that triggers ends the loop.\n\n### Human-in-the-loop\n\n```typescript\nimport {\n  createDeepFactorAgent,\n  requestHumanInput,\n  maxIterations,\n} from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  tools: { requestHumanInput },\n  interruptOn: [\"requestHumanInput\"],\n  stopWhen: [maxIterations(10)],\n});\n\nconst result = await agent.loop(\"Ask the user what color they prefer.\");\n\nif (result.stopReason === \"human_input_needed\") {\n  console.log(\"Agent is waiting for input\");\n\n  // Provide the human's answer and resume the loop\n  const finalResult = await result.resume(\"Blue\");\n  console.log(finalResult.response);\n}\n```\n\n### Middleware\n\n```typescript\nimport {\n  createDeepFactorAgent,\n  todoMiddleware,\n  errorRecoveryMiddleware,\n  maxIterations,\n} from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\n// Built-in middleware (these are the defaults)\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  middleware: [todoMiddleware(), errorRecoveryMiddleware()],\n  stopWhen: [maxIterations(10)],\n});\n```\n\n**Custom middleware:**\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport type { AgentMiddleware } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst loggingMiddleware: AgentMiddleware = {\n  name: \"logging\",\n  beforeIteration: async (ctx) => {\n    console.log(`Starting iteration ${ctx.iteration}`);\n  },\n  afterIteration: async (ctx) => {\n    console.log(`Finished iteration ${ctx.iteration}`);\n  },\n};\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  middleware: [loggingMiddleware],\n  stopWhen: [maxIterations(5)],\n});\n```\n\n### Streaming\n\n```typescript\nimport { createDeepFactorAgent } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n});\n\nconst stream = await agent.stream(\"Tell me a story.\");\n\nfor await (const chunk of stream.textStream) {\n  process.stdout.write(chunk);\n}\n```\n\n### Context management\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  stopWhen: [maxIterations(50)],\n  contextManagement: {\n    maxContextTokens: 100_000,  // summarize when context exceeds this\n    keepRecentIterations: 5,    // always keep the last 5 iterations intact\n  },\n});\n```\n\nWhen the context window fills up, older iterations are automatically summarized by the model so the agent can keep working without losing important history.\n\n## Defaults\n\nWhen using `createDeepFactorAgent`, unspecified settings receive these defaults:\n\n| Setting | Default |\n|---|---|\n| `tools` | `{}` (no tools) |\n| `instructions` | `\"\"` (empty) |\n| `stopWhen` | `[maxIterations(10)]` |\n| `verifyCompletion` | `undefined` (no verification) |\n| `middleware` | `[todoMiddleware(), errorRecoveryMiddleware()]` |\n| `interruptOn` | `[]` (no interruptions) |\n| `contextManagement.maxContextTokens` | `150000` |\n| `contextManagement.keepRecentIterations` | `3` |\n\n## API Reference\n\n### Factory\n\n| Export | Description |\n|---|---|\n| `createDeepFactorAgent(settings)` | Creates a `DeepFactorAgent` with sensible defaults. The primary entry point. |\n\n### Agent Class\n\n| Export | Description |\n|---|---|\n| `DeepFactorAgent` | Core agent class. Use `createDeepFactorAgent` unless you need full control. |\n| `.loop(prompt)` | Run the agentic loop. Returns `AgentResult` or `PendingResult`. |\n| `.stream(prompt)` | Stream the first LLM turn (non-looping). Returns the AI SDK stream result. |\n| `addUsage(a, b)` | Merge two `TokenUsage` objects by summing their fields. |\n\n### Stop Conditions\n\n| Export | Description |\n|---|---|\n| `maxIterations(n)` | Stop after `n` loop iterations. |\n| `maxTokens(n)` | Stop when total tokens reach `n`. |\n| `maxInputTokens(n)` | Stop when input tokens reach `n`. |\n| `maxOutputTokens(n)` | Stop when output tokens reach `n`. |\n| `maxCost(dollars, model?)` | Stop when estimated cost reaches `dollars`. |\n| `calculateCost(usage, model)` | Calculate cost for a given `TokenUsage` and model name. |\n| `MODEL_PRICING` | Built-in pricing table for common models (Anthropic, OpenAI, Google). |\n| `evaluateStopConditions(conditions, ctx)` | Evaluate an array of stop conditions against a context. |\n\n### Middleware\n\n| Export | Description |\n|---|---|\n| `composeMiddleware(middlewares)` | Compose an array of `AgentMiddleware` into a single middleware with merged tools and chained hooks. |\n| `todoMiddleware()` | Built-in middleware that gives the agent `write_todos` and `read_todos` tools. |\n| `errorRecoveryMiddleware()` | Built-in middleware that injects recovery guidance after errors. |\n\n### Context Management\n\n| Export | Description |\n|---|---|\n| `ContextManager` | Manages context window size by summarizing old iterations when the token limit is exceeded. |\n| `estimateTokens(text)` | Approximate token count for a string (~1 token per 3.5 characters). |\n\n### Human-in-the-Loop\n\n| Export | Description |\n|---|---|\n| `requestHumanInput` | A tool that pauses the agent loop to collect human input. Use with `interruptOn: [\"requestHumanInput\"]`. |\n\n### Types\n\nAll types are exported for use in your code:\n\n| Type | Description |\n|---|---|\n| `DeepFactorAgentSettings<TTools>` | Configuration for `createDeepFactorAgent`. |\n| `AgentResult` | Return type of `loop()` — contains `response`, `thread`, `usage`, `iterations`, `stopReason`. |\n| `PendingResult` | Extends `AgentResult` when `stopReason` is `\"human_input_needed\"` — adds `resume(input)`. |\n| `AgentThread` | The conversation thread with `id`, `events`, `metadata`. |\n| `TokenUsage` | Token counts: `inputTokens`, `outputTokens`, `totalTokens`, optional cache fields. |\n| `StopCondition` | A function `(ctx: StopConditionContext) => StopConditionResult`. |\n| `StopConditionContext` | Context passed to stop conditions: `iteration`, `usage`, `model`, `thread`. |\n| `StopConditionResult` | Result from a stop condition: `{ stop: boolean, reason?: string }`. |\n| `VerifyCompletion` | Async function to verify the agent completed its task. |\n| `VerifyContext` | Context passed to `verifyCompletion`: `result`, `iteration`, `thread`, `originalPrompt`. |\n| `VerifyResult` | Result from verification: `{ complete: boolean, reason?: string }`. |\n| `AgentMiddleware` | Middleware definition with `name`, optional `tools`, and lifecycle hooks. |\n| `MiddlewareContext` | Context passed to middleware hooks: `thread`, `iteration`, `settings`. |\n| `ContextManagementConfig` | Config for context management: `maxContextTokens`, `keepRecentIterations`. |\n| `AgentEvent` | Discriminated union of all event types in the thread. |\n\n## Architecture: 12-Factor Agent Alignment\n\nThis library is designed around the [12-factor agent](https://github.com/humanlayer/12-factor-agents) principles:\n\n1. **Natural language to tool calls** — the agent loop translates prompts into tool invocations\n2. **Own your prompts** — `instructions` are plain strings you control, not hidden behind abstractions\n3. **Own your context window** — `ContextManager` gives you explicit control over context size and summarization\n4. **Tools are just functions** — standard Vercel AI SDK tool definitions, no proprietary wrapper\n5. **Unified LLM interface** — any model provider supported by the AI SDK works out of the box\n6. **Use structured outputs** — Zod schemas for tool parameters and validation\n7. **Own your control flow** — the loop, stop conditions, and middleware are all configurable\n8. **Compact errors into context** — `errorRecoveryMiddleware` feeds truncated errors back into the conversation\n9. **Own your threads** — `AgentThread` gives you full access to conversation history and metadata\n10. **Small, focused agents** — the library encourages composing single-purpose agents\n11. **Trigger from anywhere** — `loop()` and `stream()` can be called from any runtime (server, CLI, edge)\n12. **Make agents observable** — thread events, token tracking, and lifecycle callbacks provide full visibility\n\n## Development\n\n```bash\npnpm install        # install dependencies\npnpm build          # compile TypeScript\npnpm test           # run tests (vitest)\npnpm type-check     # type-check without emitting\npnpm dev            # watch mode\n```\n\n## License\n\nMIT\n","structuredPatch":[{"oldStart":143,"oldLines":7,"newStart":143,"newLines":7,"lines":[" "," const result = await agent.loop(\"Ask the user what color they prefer.\");"," ","-if (result.stopReason === \"human_input_needed\") {","+if (\"resume\" in result) {","   console.log(\"Agent is waiting for input\");"," ","   // Provide the human's answer and resume the loop"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_019jYmVGf3qmfUiaYdZwMhDz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EoaJNu4nq7zmLMnys55C3Y","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md","offset":206,"limit":15},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":297,"cache_read_input_tokens":45062,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":297},"output_tokens":24,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"f55be5c7-6fd6-4315-a8e1-90a8c7b9ccf4"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EoaJNu4nq7zmLMnys55C3Y","type":"tool_result","content":"   206→});\n   207→\n   208→const stream = await agent.stream(\"Tell me a story.\");\n   209→\n   210→for await (const chunk of stream.textStream) {\n   211→  process.stdout.write(chunk);\n   212→}\n   213→```\n   214→\n   215→### Context management\n   216→\n   217→```typescript\n   218→import { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\n   219→import { anthropic } from \"@ai-sdk/anthropic\";\n   220→"}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"1ec7953a-8323-4a22-8a61-e603d8fc75e1","tool_use_result":{"type":"text","file":{"filePath":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md","content":"});\n\nconst stream = await agent.stream(\"Tell me a story.\");\n\nfor await (const chunk of stream.textStream) {\n  process.stdout.write(chunk);\n}\n```\n\n### Context management\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n","numLines":15,"startLine":206,"totalLines":351}}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01QRpsWvk6kPWDigYx7Qa5SC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01E5wrPZH5tKXGBModC3KvPE","name":"Edit","input":{"replace_all":false,"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md","old_string":"const stream = await agent.stream(\"Tell me a story.\");","new_string":"const stream = agent.stream(\"Tell me a story.\");"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":258,"cache_read_input_tokens":45359,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":258},"output_tokens":24,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"736c3e45-c5e9-405e-9aa1-e878dad5c12e"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01E5wrPZH5tKXGBModC3KvPE","type":"tool_result","content":"The file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"89e0599e-af8c-4b60-af11-c9ed4a039bd5","tool_use_result":{"filePath":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/README.md","oldString":"const stream = await agent.stream(\"Tell me a story.\");","newString":"const stream = agent.stream(\"Tell me a story.\");","originalFile":"# deep-factor-agent\n\nA TypeScript library for building loop-based AI agents with middleware, verification, stop conditions, human-in-the-loop, and context management — aligned with the [12-factor agent](https://github.com/humanlayer/12-factor-agents) methodology.\n\n## Overview\n\n`deep-factor-agent` wraps the [Vercel AI SDK v6](https://sdk.vercel.ai/) in an opinionated agent loop that gives you fine-grained control over iteration limits, cost guardrails, completion verification, context window management, and human escalation — all through a declarative configuration surface.\n\n**Why a loop-based agent?** Single-shot LLM calls are rarely enough for non-trivial tasks. An agentic loop lets the model call tools, observe results, reflect, and iterate until the task is truly done — while stop conditions and middleware keep execution safe and observable.\n\n### Key capabilities\n\n- **Agentic loop** — iterative tool-calling with automatic message history\n- **Stop conditions** — cap iterations, tokens, or dollar cost\n- **Completion verification** — optionally verify the agent actually finished the task\n- **Middleware** — inject tools and lifecycle hooks (built-in: todo tracking, error recovery)\n- **Human-in-the-loop** — pause execution, collect human input, and resume\n- **Context management** — automatic summarization when the context window fills up\n- **Streaming** — stream the first LLM turn for real-time UIs\n\n## Installation\n\n```bash\npnpm add deep-factor-agent ai zod\n```\n\n`ai` (Vercel AI SDK v6+) is a runtime dependency. `zod` (v4+) is a **peer dependency** — you must install it yourself.\n\nYou also need a model provider, e.g.:\n\n```bash\npnpm add @ai-sdk/anthropic\n# or @ai-sdk/openai, @ai-sdk/google, etc.\n```\n\n## Quick Start\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  instructions: \"You are a helpful assistant.\",\n  stopWhen: [maxIterations(5)],\n});\n\nconst result = await agent.loop(\"What is the capital of France?\");\n\nconsole.log(result.response);   // \"The capital of France is Paris.\"\nconsole.log(result.iterations); // number of loop iterations used\nconsole.log(result.usage);      // { inputTokens, outputTokens, totalTokens }\n```\n\n## Usage Examples\n\n### Minimal agent (model only)\n\n```typescript\nimport { createDeepFactorAgent } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n});\n\nconst result = await agent.loop(\"Hello!\");\nconsole.log(result.response);\n```\n\nAll other settings use sensible defaults — see the [Defaults table](#defaults) below.\n\n### Agent with tools and verification\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\nimport { z } from \"zod\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  instructions: \"Use the weather tool to answer weather questions.\",\n  tools: {\n    getWeather: {\n      description: \"Get weather for a city\",\n      parameters: z.object({ city: z.string() }),\n      execute: async ({ city }) => `72°F and sunny in ${city}`,\n    },\n  },\n  stopWhen: [maxIterations(10)],\n  verifyCompletion: async ({ result }) => ({\n    complete: typeof result === \"string\" && result.includes(\"°F\"),\n    reason: \"Response must contain a temperature\",\n  }),\n});\n\nconst result = await agent.loop(\"What's the weather in Austin?\");\n```\n\n### Stop conditions\n\n```typescript\nimport {\n  createDeepFactorAgent,\n  maxIterations,\n  maxTokens,\n  maxInputTokens,\n  maxOutputTokens,\n  maxCost,\n} from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  stopWhen: [\n    maxIterations(20),          // stop after 20 loop iterations\n    maxTokens(100_000),         // stop at 100k total tokens\n    maxInputTokens(80_000),     // stop at 80k input tokens\n    maxOutputTokens(20_000),    // stop at 20k output tokens\n    maxCost(0.50),              // stop at $0.50 spend\n  ],\n});\n```\n\nMultiple conditions can be combined — the first one that triggers ends the loop.\n\n### Human-in-the-loop\n\n```typescript\nimport {\n  createDeepFactorAgent,\n  requestHumanInput,\n  maxIterations,\n} from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  tools: { requestHumanInput },\n  interruptOn: [\"requestHumanInput\"],\n  stopWhen: [maxIterations(10)],\n});\n\nconst result = await agent.loop(\"Ask the user what color they prefer.\");\n\nif (\"resume\" in result) {\n  console.log(\"Agent is waiting for input\");\n\n  // Provide the human's answer and resume the loop\n  const finalResult = await result.resume(\"Blue\");\n  console.log(finalResult.response);\n}\n```\n\n### Middleware\n\n```typescript\nimport {\n  createDeepFactorAgent,\n  todoMiddleware,\n  errorRecoveryMiddleware,\n  maxIterations,\n} from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\n// Built-in middleware (these are the defaults)\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  middleware: [todoMiddleware(), errorRecoveryMiddleware()],\n  stopWhen: [maxIterations(10)],\n});\n```\n\n**Custom middleware:**\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport type { AgentMiddleware } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst loggingMiddleware: AgentMiddleware = {\n  name: \"logging\",\n  beforeIteration: async (ctx) => {\n    console.log(`Starting iteration ${ctx.iteration}`);\n  },\n  afterIteration: async (ctx) => {\n    console.log(`Finished iteration ${ctx.iteration}`);\n  },\n};\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  middleware: [loggingMiddleware],\n  stopWhen: [maxIterations(5)],\n});\n```\n\n### Streaming\n\n```typescript\nimport { createDeepFactorAgent } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n});\n\nconst stream = await agent.stream(\"Tell me a story.\");\n\nfor await (const chunk of stream.textStream) {\n  process.stdout.write(chunk);\n}\n```\n\n### Context management\n\n```typescript\nimport { createDeepFactorAgent, maxIterations } from \"deep-factor-agent\";\nimport { anthropic } from \"@ai-sdk/anthropic\";\n\nconst agent = createDeepFactorAgent({\n  model: anthropic(\"claude-sonnet-4-5-20250514\"),\n  stopWhen: [maxIterations(50)],\n  contextManagement: {\n    maxContextTokens: 100_000,  // summarize when context exceeds this\n    keepRecentIterations: 5,    // always keep the last 5 iterations intact\n  },\n});\n```\n\nWhen the context window fills up, older iterations are automatically summarized by the model so the agent can keep working without losing important history.\n\n## Defaults\n\nWhen using `createDeepFactorAgent`, unspecified settings receive these defaults:\n\n| Setting | Default |\n|---|---|\n| `tools` | `{}` (no tools) |\n| `instructions` | `\"\"` (empty) |\n| `stopWhen` | `[maxIterations(10)]` |\n| `verifyCompletion` | `undefined` (no verification) |\n| `middleware` | `[todoMiddleware(), errorRecoveryMiddleware()]` |\n| `interruptOn` | `[]` (no interruptions) |\n| `contextManagement.maxContextTokens` | `150000` |\n| `contextManagement.keepRecentIterations` | `3` |\n\n## API Reference\n\n### Factory\n\n| Export | Description |\n|---|---|\n| `createDeepFactorAgent(settings)` | Creates a `DeepFactorAgent` with sensible defaults. The primary entry point. |\n\n### Agent Class\n\n| Export | Description |\n|---|---|\n| `DeepFactorAgent` | Core agent class. Use `createDeepFactorAgent` unless you need full control. |\n| `.loop(prompt)` | Run the agentic loop. Returns `AgentResult` or `PendingResult`. |\n| `.stream(prompt)` | Stream the first LLM turn (non-looping). Returns the AI SDK stream result. |\n| `addUsage(a, b)` | Merge two `TokenUsage` objects by summing their fields. |\n\n### Stop Conditions\n\n| Export | Description |\n|---|---|\n| `maxIterations(n)` | Stop after `n` loop iterations. |\n| `maxTokens(n)` | Stop when total tokens reach `n`. |\n| `maxInputTokens(n)` | Stop when input tokens reach `n`. |\n| `maxOutputTokens(n)` | Stop when output tokens reach `n`. |\n| `maxCost(dollars, model?)` | Stop when estimated cost reaches `dollars`. |\n| `calculateCost(usage, model)` | Calculate cost for a given `TokenUsage` and model name. |\n| `MODEL_PRICING` | Built-in pricing table for common models (Anthropic, OpenAI, Google). |\n| `evaluateStopConditions(conditions, ctx)` | Evaluate an array of stop conditions against a context. |\n\n### Middleware\n\n| Export | Description |\n|---|---|\n| `composeMiddleware(middlewares)` | Compose an array of `AgentMiddleware` into a single middleware with merged tools and chained hooks. |\n| `todoMiddleware()` | Built-in middleware that gives the agent `write_todos` and `read_todos` tools. |\n| `errorRecoveryMiddleware()` | Built-in middleware that injects recovery guidance after errors. |\n\n### Context Management\n\n| Export | Description |\n|---|---|\n| `ContextManager` | Manages context window size by summarizing old iterations when the token limit is exceeded. |\n| `estimateTokens(text)` | Approximate token count for a string (~1 token per 3.5 characters). |\n\n### Human-in-the-Loop\n\n| Export | Description |\n|---|---|\n| `requestHumanInput` | A tool that pauses the agent loop to collect human input. Use with `interruptOn: [\"requestHumanInput\"]`. |\n\n### Types\n\nAll types are exported for use in your code:\n\n| Type | Description |\n|---|---|\n| `DeepFactorAgentSettings<TTools>` | Configuration for `createDeepFactorAgent`. |\n| `AgentResult` | Return type of `loop()` — contains `response`, `thread`, `usage`, `iterations`, `stopReason`. |\n| `PendingResult` | Extends `AgentResult` when `stopReason` is `\"human_input_needed\"` — adds `resume(input)`. |\n| `AgentThread` | The conversation thread with `id`, `events`, `metadata`. |\n| `TokenUsage` | Token counts: `inputTokens`, `outputTokens`, `totalTokens`, optional cache fields. |\n| `StopCondition` | A function `(ctx: StopConditionContext) => StopConditionResult`. |\n| `StopConditionContext` | Context passed to stop conditions: `iteration`, `usage`, `model`, `thread`. |\n| `StopConditionResult` | Result from a stop condition: `{ stop: boolean, reason?: string }`. |\n| `VerifyCompletion` | Async function to verify the agent completed its task. |\n| `VerifyContext` | Context passed to `verifyCompletion`: `result`, `iteration`, `thread`, `originalPrompt`. |\n| `VerifyResult` | Result from verification: `{ complete: boolean, reason?: string }`. |\n| `AgentMiddleware` | Middleware definition with `name`, optional `tools`, and lifecycle hooks. |\n| `MiddlewareContext` | Context passed to middleware hooks: `thread`, `iteration`, `settings`. |\n| `ContextManagementConfig` | Config for context management: `maxContextTokens`, `keepRecentIterations`. |\n| `AgentEvent` | Discriminated union of all event types in the thread. |\n\n## Architecture: 12-Factor Agent Alignment\n\nThis library is designed around the [12-factor agent](https://github.com/humanlayer/12-factor-agents) principles:\n\n1. **Natural language to tool calls** — the agent loop translates prompts into tool invocations\n2. **Own your prompts** — `instructions` are plain strings you control, not hidden behind abstractions\n3. **Own your context window** — `ContextManager` gives you explicit control over context size and summarization\n4. **Tools are just functions** — standard Vercel AI SDK tool definitions, no proprietary wrapper\n5. **Unified LLM interface** — any model provider supported by the AI SDK works out of the box\n6. **Use structured outputs** — Zod schemas for tool parameters and validation\n7. **Own your control flow** — the loop, stop conditions, and middleware are all configurable\n8. **Compact errors into context** — `errorRecoveryMiddleware` feeds truncated errors back into the conversation\n9. **Own your threads** — `AgentThread` gives you full access to conversation history and metadata\n10. **Small, focused agents** — the library encourages composing single-purpose agents\n11. **Trigger from anywhere** — `loop()` and `stream()` can be called from any runtime (server, CLI, edge)\n12. **Make agents observable** — thread events, token tracking, and lifecycle callbacks provide full visibility\n\n## Development\n\n```bash\npnpm install        # install dependencies\npnpm build          # compile TypeScript\npnpm test           # run tests (vitest)\npnpm type-check     # type-check without emitting\npnpm dev            # watch mode\n```\n\n## License\n\nMIT\n","structuredPatch":[{"oldStart":205,"oldLines":7,"newStart":205,"newLines":7,"lines":["   model: anthropic(\"claude-sonnet-4-5-20250514\"),"," });"," ","-const stream = await agent.stream(\"Tell me a story.\");","+const stream = agent.stream(\"Tell me a story.\");"," "," for await (const chunk of stream.textStream) {","   process.stdout.write(chunk);"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_019ntTLDKs7S3jMTRhHXKa4n","type":"message","role":"assistant","content":[{"type":"text","text":"Good. All three issues are fixed. Now let me run the tests to make sure nothing is broken, then update the implementation plan."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":198,"cache_read_input_tokens":45617,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":198},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"2c3193b0-fce9-4fcf-93c8-7fe1f009e456"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_019ntTLDKs7S3jMTRhHXKa4n","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DCBiDRq47Zg9siwd2BFKHf","name":"Task","input":{"description":"Run tests to verify","prompt":"Run the command `cd /home/ryaneggz/sandbox/2026/feb/deep-factor-agent && pnpm test` and report the full output. Also run `pnpm type-check` and `pnpm build` after the tests.","subagent_type":"Bash","model":"sonnet"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":198,"cache_read_input_tokens":45617,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":198},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"bcc35bbd-20f6-42fd-b234-ab53b840aebb"}
{"type":"user","message":{"role":"user","content":[{"type":"text","text":"Run the command `cd /home/ryaneggz/sandbox/2026/feb/deep-factor-agent && pnpm test` and report the full output. Also run `pnpm type-check` and `pnpm build` after the tests."}]},"parent_tool_use_id":"toolu_01DCBiDRq47Zg9siwd2BFKHf","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"9d1289d9-25cd-4b30-8bea-6ed54a11c445"}
{"type":"assistant","message":{"model":"claude-sonnet-4-6","id":"msg_01RvWbBc4eTav4ufTtHTYZYV","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011bQeGS6vUqLt9NWh4m4Hn1","name":"Bash","input":{"command":"pnpm test 2>&1","description":"Run pnpm test in the project directory","timeout":120000},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":4473,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":4473},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01DCBiDRq47Zg9siwd2BFKHf","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"773d15af-cc0a-47f1-8d5c-a6bc98ce7a96"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011bQeGS6vUqLt9NWh4m4Hn1","type":"tool_result","content":"> deep-factor-agent@0.0.0 test /home/ryaneggz/sandbox/2026/feb/deep-factor-agent\n> vitest run\n\n\n\u001b[1m\u001b[46m RUN \u001b[49m\u001b[22m \u001b[36mv4.0.18 \u001b[39m\u001b[90m/home/ryaneggz/sandbox/2026/feb/deep-factor-agent\u001b[39m\n\n \u001b[32m✓\u001b[39m src/stop-conditions.test.ts \u001b[2m(\u001b[22m\u001b[2m23 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[32m 14\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m src/middleware.test.ts \u001b[2m(\u001b[22m\u001b[2m15 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[32m 13\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m src/agent.test.ts \u001b[2m(\u001b[22m\u001b[2m16 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[32m 11\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m src/integration.test.ts \u001b[2m(\u001b[22m\u001b[2m6 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[32m 7\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m src/human-in-the-loop.test.ts \u001b[2m(\u001b[22m\u001b[2m12 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[32m 7\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m src/create-agent.test.ts \u001b[2m(\u001b[22m\u001b[2m9 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[32m 16\u001b[2mms\u001b[22m\u001b[39m\n \u001b[32m✓\u001b[39m src/context-manager.test.ts \u001b[2m(\u001b[22m\u001b[2m12 tests\u001b[22m\u001b[2m)\u001b[22m\u001b[32m 5\u001b[2mms\u001b[22m\u001b[39m\n\n\u001b[2m Test Files \u001b[22m \u001b[1m\u001b[32m7 passed\u001b[39m\u001b[22m\u001b[90m (7)\u001b[39m\n\u001b[2m      Tests \u001b[22m \u001b[1m\u001b[32m93 passed\u001b[39m\u001b[22m\u001b[90m (93)\u001b[39m\n\u001b[2m   Start at \u001b[22m 00:20:25\n\u001b[2m   Duration \u001b[22m 334ms\u001b[2m (transform 935ms, setup 0ms, import 1.34s, tests 74ms, environment 1ms)\u001b[22m","is_error":false}]},"parent_tool_use_id":"toolu_01DCBiDRq47Zg9siwd2BFKHf","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"becbd4bb-73a0-4e52-9b8c-28f12660445b"}
{"type":"assistant","message":{"model":"claude-sonnet-4-6","id":"msg_019C4nZG7BnTrbcBRuZac7Fm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NyCuJ7SaL122zCpmC7t8Hu","name":"Bash","input":{"command":"pnpm type-check 2>&1","description":"Run pnpm type-check in the project directory","timeout":120000},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":730,"cache_read_input_tokens":4473,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":730},"output_tokens":21,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01DCBiDRq47Zg9siwd2BFKHf","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"f88b61ad-0ec6-458b-8295-19c3df6916db"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NyCuJ7SaL122zCpmC7t8Hu","type":"tool_result","content":"> deep-factor-agent@0.0.0 type-check /home/ryaneggz/sandbox/2026/feb/deep-factor-agent\n> tsc --noEmit","is_error":false}]},"parent_tool_use_id":"toolu_01DCBiDRq47Zg9siwd2BFKHf","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"01432157-a6b2-4ead-9a73-a90b59462ab7"}
{"type":"assistant","message":{"model":"claude-sonnet-4-6","id":"msg_01U6LY91gF2ahnxKfLun2VQx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NKGjMp3cKE7QiJ35Xbw2op","name":"Bash","input":{"command":"pnpm build 2>&1","description":"Run pnpm build in the project directory","timeout":120000},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":161,"cache_read_input_tokens":5203,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":161},"output_tokens":21,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":"toolu_01DCBiDRq47Zg9siwd2BFKHf","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"3946141f-c63a-4d40-83dd-2e3d7de24857"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NKGjMp3cKE7QiJ35Xbw2op","type":"tool_result","content":"> deep-factor-agent@0.0.0 build /home/ryaneggz/sandbox/2026/feb/deep-factor-agent\n> tsc","is_error":false}]},"parent_tool_use_id":"toolu_01DCBiDRq47Zg9siwd2BFKHf","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"efda7df8-15b2-407a-a092-c5f4c9a51043"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DCBiDRq47Zg9siwd2BFKHf","type":"tool_result","content":[{"type":"text","text":"All three commands completed successfully. Here is a summary of the results:\n\n**pnpm test**\n- 7 test files passed\n- 93 total tests passed\n- Duration: ~334ms\n- Test files:\n  - `src/stop-conditions.test.ts` - 23 tests\n  - `src/middleware.test.ts` - 15 tests\n  - `src/agent.test.ts` - 16 tests\n  - `src/integration.test.ts` - 6 tests\n  - `src/human-in-the-loop.test.ts` - 12 tests\n  - `src/create-agent.test.ts` - 9 tests\n  - `src/context-manager.test.ts` - 12 tests\n\n**pnpm type-check**\n- Completed with no errors or warnings (clean exit)\n\n**pnpm build**\n- Completed with no errors or warnings (clean exit)\n\nThe project is in a fully healthy state with all tests passing, no TypeScript type errors, and a successful build."},{"type":"text","text":"agentId: a59ea651a37efb35f (for resuming to continue this agent's work if needed)\n<usage>total_tokens: 5766\ntool_uses: 3\nduration_ms: 12076</usage>"}]}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"769fb763-99cb-4cdf-9b40-e3271dfaa63a","tool_use_result":{"status":"completed","prompt":"Run the command `cd /home/ryaneggz/sandbox/2026/feb/deep-factor-agent && pnpm test` and report the full output. Also run `pnpm type-check` and `pnpm build` after the tests.","agentId":"a59ea651a37efb35f","content":[{"type":"text","text":"All three commands completed successfully. Here is a summary of the results:\n\n**pnpm test**\n- 7 test files passed\n- 93 total tests passed\n- Duration: ~334ms\n- Test files:\n  - `src/stop-conditions.test.ts` - 23 tests\n  - `src/middleware.test.ts` - 15 tests\n  - `src/agent.test.ts` - 16 tests\n  - `src/integration.test.ts` - 6 tests\n  - `src/human-in-the-loop.test.ts` - 12 tests\n  - `src/create-agent.test.ts` - 9 tests\n  - `src/context-manager.test.ts` - 12 tests\n\n**pnpm type-check**\n- Completed with no errors or warnings (clean exit)\n\n**pnpm build**\n- Completed with no errors or warnings (clean exit)\n\nThe project is in a fully healthy state with all tests passing, no TypeScript type errors, and a successful build."}],"totalDurationMs":12076,"totalTokens":5766,"totalToolUseCount":3,"usage":{"input_tokens":1,"cache_creation_input_tokens":151,"cache_read_input_tokens":5364,"output_tokens":250,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":151,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_012uGu2cCrUFMzjrrYU8GbJe","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"All tests pass, type-check is clean, build is clean. Now I need to:\n1. Mark verification as complete\n2. Update IMPLEMENTATION_PLAN.md\n3. Commit and push\n4. Create a git tag","signature":"EtMCCkYICxgCKkB1JoZHy+dgp5AyBqZGfO1sqFuUsHIlc8U0zZoZ80rw6MmxDD8XrxrGiv2cQ4YC6WE+c3eBGeIr7UpYNNCVt3eYEgwRtxGE7Y9eOpnpziUaDK91sQZAfPYVzzCbnCIwNamKYoagYk40j5lpH9RWcVFbPT0ZsuC9jTQbukRH3EoSDUJ8smBQ5KtY6B8pJlKXKroBlG+plif4xR+29kKvftnI8BSc8oEh2cA2kV4b3vEYHzqgLl4/tW8iwR+aF1HpL1F5PXje9yqXxm/oyft6HWBAhN3jTb2iW88sWzz/w7ZMBvsXWwBcmFQdiT9cCJv2FATd22l47LSIlzE5wJnjDVsVHlZdk+xVIGI1HxdOZnqvr9lHjGhWr5DXjg3WKE7ExA+rWU4MYzsZ7p+gap+MaQ8jvnoIDGqNgfiuy5FCZ5Zb+zKGumH5vfVabLCaGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":694,"cache_read_input_tokens":45815,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":694},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"2a2d474d-dc1e-4794-b9fd-99424b7a09f3"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_012uGu2cCrUFMzjrrYU8GbJe","type":"message","role":"assistant","content":[{"type":"text","text":"All 93 tests pass, type-check clean, build clean. Now let me update the implementation plan and commit."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":694,"cache_read_input_tokens":45815,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":694},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"0d516203-7ad5-44fc-8d3f-14a338c7d087"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_012uGu2cCrUFMzjrrYU8GbJe","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014Mbgimvyd1mxdZ8qhb7T39","name":"TodoWrite","input":{"todos":[{"content":"Study specs and source code","status":"completed","activeForm":"Studying specs and source code"},{"content":"Author README.md per spec 01-setup-readme.md","status":"completed","activeForm":"Authoring README.md"},{"content":"Verify README code examples compile against public API","status":"completed","activeForm":"Verifying README code examples"},{"content":"Update IMPLEMENTATION_PLAN.md and commit/push","status":"in_progress","activeForm":"Updating plan and committing"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":694,"cache_read_input_tokens":45815,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":694},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"f0f111da-7137-45f7-aad7-7df5b6336728"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014Mbgimvyd1mxdZ8qhb7T39","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"85025076-6b5e-4553-8609-ec2a59e5dbd1","tool_use_result":{"oldTodos":[{"content":"Study specs and source code","status":"completed","activeForm":"Studying specs and source code"},{"content":"Author README.md per spec 01-setup-readme.md","status":"completed","activeForm":"Authoring README.md"},{"content":"Verify README code examples compile against public API","status":"in_progress","activeForm":"Verifying README code examples"},{"content":"Update IMPLEMENTATION_PLAN.md and commit/push","status":"pending","activeForm":"Updating plan and committing"}],"newTodos":[{"content":"Study specs and source code","status":"completed","activeForm":"Studying specs and source code"},{"content":"Author README.md per spec 01-setup-readme.md","status":"completed","activeForm":"Authoring README.md"},{"content":"Verify README code examples compile against public API","status":"completed","activeForm":"Verifying README code examples"},{"content":"Update IMPLEMENTATION_PLAN.md and commit/push","status":"in_progress","activeForm":"Updating plan and committing"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01HGeTbsmwVZqHuTb6AGSKtn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Sobg4Krdvowq6GQgx9ca93","name":"Read","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/IMPLEMENTATION_PLAN.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":324,"cache_read_input_tokens":46509,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":324},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"e3ff63f4-8659-4499-98b2-6bba2d851d3a"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Sobg4Krdvowq6GQgx9ca93","type":"tool_result","content":"     1→# IMPLEMENTATION PLAN -- deep-factor-agent\n     2→\n     3→> A TypeScript library implementing a loop-based AI agent with middleware, verification, stop conditions, human-in-the-loop, and 12-factor compliance.\n     4→>\n     5→> **Stack**: TypeScript 5.x, Vercel AI SDK v6+, Zod v4+ (peer dep), Vitest, pnpm, ESM only\n     6→>\n     7→> **Current State**: Core library fully implemented and passing (93 tests, 7 files, 0 type errors, clean build). Tagged `v0.0.1`.\n     8→\n     9→---\n    10→\n    11→## COMPLETED WORK (Tiers 1-8)\n    12→\n    13→All 70 items from the original implementation plan are complete:\n    14→\n    15→- **Tier 1**: Project initialization (package.json, tsconfig, scripts, vitest config)\n    16→- **Tier 2**: Core types & interfaces (src/types.ts -- 9 event types, AgentThread, TokenUsage, settings, results)\n    17→- **Tier 3**: Stop conditions (maxIterations, maxTokens, maxInputTokens, maxOutputTokens, maxCost, MODEL_PRICING, calculateCost, evaluateStopConditions)\n    18→- **Tier 4A**: Agent loop (DeepFactorAgent class with loop(), stream(), buildMessages, appendResultEvents, addUsage, error recovery)\n    19→- **Tier 4B**: Middleware system (composeMiddleware, todoMiddleware, errorRecoveryMiddleware)\n    20→- **Tier 4C**: Context management (ContextManager with estimateTokens, needsSummarization, summarize, buildContextInjection)\n    21→- **Tier 5**: Factory function (createDeepFactorAgent with sensible defaults) & barrel exports (src/index.ts)\n    22→- **Tier 6**: Human-in-the-loop (requestHumanInput tool, PendingResult with resume(), interruptOn config)\n    23→- **Tier 7**: Cross-cutting integration tests (6 end-to-end scenarios)\n    24→- **Tier 8**: Final validation (all tests pass, type-check clean, build clean, 12-factor alignment verified)\n    25→\n    26→---\n    27→\n    28→## PRIORITY TIER 9 -- README Documentation (SPEC: specs/01-setup-readme.md)\n    29→\n    30→_Depends on: All tiers complete (library is production-ready). No code changes required._\n    31→\n    32→### User Story\n    33→\n    34→**US-09**: As a developer, I would like a README so that I can understand what the library does, how to install it, and how to use it without reading source code.\n    35→\n    36→### Acceptance Criteria\n    37→\n    38→- [ ] **AC-01**: README.md exists at project root\n    39→- [ ] **AC-02**: Contains project name, one-line description, and a brief overview of what the library does\n    40→- [ ] **AC-03**: Contains installation instructions (`pnpm add deep-factor-agent`)\n    41→- [ ] **AC-04**: Contains a \"Quick Start\" section with minimal usage example (createDeepFactorAgent + loop)\n    42→- [ ] **AC-05**: Contains usage examples covering the main features:\n    43→  - Minimal agent (model only)\n    44→  - Agent with tools and verification\n    45→  - Stop conditions (maxIterations, maxTokens, maxCost)\n    46→  - Human-in-the-loop (requestHumanInput, interruptOn, resume)\n    47→  - Middleware (custom middleware, built-in todoMiddleware/errorRecoveryMiddleware)\n    48→  - Streaming (stream())\n    49→  - Context management configuration\n    50→- [ ] **AC-06**: Contains an API reference section listing all public exports organized by category (Factory, Agent Class, Stop Conditions, Middleware, Context Management, Human-in-the-Loop, Types)\n    51→- [ ] **AC-07**: Contains a \"Development\" section with build/test/type-check commands\n    52→- [ ] **AC-08**: Mentions the 12-factor agent alignment and links to the concept\n    53→- [ ] **AC-09**: Mentions peer dependency on Zod v4+ and dependency on Vercel AI SDK v6+\n    54→\n    55→### Implementation Items\n    56→\n    57→- [ ] **9.1** Author `README.md` at project root\n    58→  - **Spec**: specs/01-setup-readme.md\n    59→  - **File**: `README.md`\n    60→  - **Details**:\n    61→    - Title: `deep-factor-agent`\n    62→    - Tagline: one-line description of the library's purpose\n    63→    - Sections: Overview, Installation, Quick Start, Usage Examples, API Reference, Architecture (12-Factor), Development, License\n    64→    - Code examples should use `import { createDeepFactorAgent, maxIterations, requestHumanInput } from \"deep-factor-agent\"` style\n    65→    - All examples must be valid TypeScript that would compile against the library's public API\n    66→    - Reference the factory function `createDeepFactorAgent()` as the primary entry point\n    67→    - Document the defaults table from SPEC-06 (tools, instructions, stopWhen, middleware, contextManagement, etc.)\n    68→    - Document `AgentResult` and `PendingResult` return types\n    69→    - Keep it concise -- developers should be able to scan and use within minutes\n    70→  - **Status**: PENDING\n    71→\n    72→- [ ] **9.2** Verify README code examples compile\n    73→  - **Spec**: specs/01-setup-readme.md\n    74→  - **File**: N/A (validation step)\n    75→  - **Details**:\n    76→    - Review all code snippets in README against the actual public API in `src/index.ts`\n    77→    - Ensure import paths, function signatures, and type names are accurate\n    78→    - Verify examples reflect current Vercel AI SDK v6 patterns (e.g., `stopWhen` + `stepCountIs`, not old `maxSteps`)\n    79→  - **Status**: PENDING\n    80→\n    81→---\n    82→\n    83→## NO KNOWN ISSUES\n    84→\n    85→- 0 TODOs, FIXMEs, or placeholders in source code\n    86→- 0 skipped or flaky tests\n    87→- 0 type errors\n    88→- Clean build producing all expected .js and .d.ts files in dist/\n    89→- All 93 tests passing (stop-conditions: 23, middleware: 15, agent: 16, create-agent: 9, human-in-the-loop: 12, context-manager: 12, integration: 6)\n    90→"}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"2315c0f4-6b1a-4415-9740-aadd45a02062","tool_use_result":{"type":"text","file":{"filePath":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/IMPLEMENTATION_PLAN.md","content":"# IMPLEMENTATION PLAN -- deep-factor-agent\n\n> A TypeScript library implementing a loop-based AI agent with middleware, verification, stop conditions, human-in-the-loop, and 12-factor compliance.\n>\n> **Stack**: TypeScript 5.x, Vercel AI SDK v6+, Zod v4+ (peer dep), Vitest, pnpm, ESM only\n>\n> **Current State**: Core library fully implemented and passing (93 tests, 7 files, 0 type errors, clean build). Tagged `v0.0.1`.\n\n---\n\n## COMPLETED WORK (Tiers 1-8)\n\nAll 70 items from the original implementation plan are complete:\n\n- **Tier 1**: Project initialization (package.json, tsconfig, scripts, vitest config)\n- **Tier 2**: Core types & interfaces (src/types.ts -- 9 event types, AgentThread, TokenUsage, settings, results)\n- **Tier 3**: Stop conditions (maxIterations, maxTokens, maxInputTokens, maxOutputTokens, maxCost, MODEL_PRICING, calculateCost, evaluateStopConditions)\n- **Tier 4A**: Agent loop (DeepFactorAgent class with loop(), stream(), buildMessages, appendResultEvents, addUsage, error recovery)\n- **Tier 4B**: Middleware system (composeMiddleware, todoMiddleware, errorRecoveryMiddleware)\n- **Tier 4C**: Context management (ContextManager with estimateTokens, needsSummarization, summarize, buildContextInjection)\n- **Tier 5**: Factory function (createDeepFactorAgent with sensible defaults) & barrel exports (src/index.ts)\n- **Tier 6**: Human-in-the-loop (requestHumanInput tool, PendingResult with resume(), interruptOn config)\n- **Tier 7**: Cross-cutting integration tests (6 end-to-end scenarios)\n- **Tier 8**: Final validation (all tests pass, type-check clean, build clean, 12-factor alignment verified)\n\n---\n\n## PRIORITY TIER 9 -- README Documentation (SPEC: specs/01-setup-readme.md)\n\n_Depends on: All tiers complete (library is production-ready). No code changes required._\n\n### User Story\n\n**US-09**: As a developer, I would like a README so that I can understand what the library does, how to install it, and how to use it without reading source code.\n\n### Acceptance Criteria\n\n- [ ] **AC-01**: README.md exists at project root\n- [ ] **AC-02**: Contains project name, one-line description, and a brief overview of what the library does\n- [ ] **AC-03**: Contains installation instructions (`pnpm add deep-factor-agent`)\n- [ ] **AC-04**: Contains a \"Quick Start\" section with minimal usage example (createDeepFactorAgent + loop)\n- [ ] **AC-05**: Contains usage examples covering the main features:\n  - Minimal agent (model only)\n  - Agent with tools and verification\n  - Stop conditions (maxIterations, maxTokens, maxCost)\n  - Human-in-the-loop (requestHumanInput, interruptOn, resume)\n  - Middleware (custom middleware, built-in todoMiddleware/errorRecoveryMiddleware)\n  - Streaming (stream())\n  - Context management configuration\n- [ ] **AC-06**: Contains an API reference section listing all public exports organized by category (Factory, Agent Class, Stop Conditions, Middleware, Context Management, Human-in-the-Loop, Types)\n- [ ] **AC-07**: Contains a \"Development\" section with build/test/type-check commands\n- [ ] **AC-08**: Mentions the 12-factor agent alignment and links to the concept\n- [ ] **AC-09**: Mentions peer dependency on Zod v4+ and dependency on Vercel AI SDK v6+\n\n### Implementation Items\n\n- [ ] **9.1** Author `README.md` at project root\n  - **Spec**: specs/01-setup-readme.md\n  - **File**: `README.md`\n  - **Details**:\n    - Title: `deep-factor-agent`\n    - Tagline: one-line description of the library's purpose\n    - Sections: Overview, Installation, Quick Start, Usage Examples, API Reference, Architecture (12-Factor), Development, License\n    - Code examples should use `import { createDeepFactorAgent, maxIterations, requestHumanInput } from \"deep-factor-agent\"` style\n    - All examples must be valid TypeScript that would compile against the library's public API\n    - Reference the factory function `createDeepFactorAgent()` as the primary entry point\n    - Document the defaults table from SPEC-06 (tools, instructions, stopWhen, middleware, contextManagement, etc.)\n    - Document `AgentResult` and `PendingResult` return types\n    - Keep it concise -- developers should be able to scan and use within minutes\n  - **Status**: PENDING\n\n- [ ] **9.2** Verify README code examples compile\n  - **Spec**: specs/01-setup-readme.md\n  - **File**: N/A (validation step)\n  - **Details**:\n    - Review all code snippets in README against the actual public API in `src/index.ts`\n    - Ensure import paths, function signatures, and type names are accurate\n    - Verify examples reflect current Vercel AI SDK v6 patterns (e.g., `stopWhen` + `stepCountIs`, not old `maxSteps`)\n  - **Status**: PENDING\n\n---\n\n## NO KNOWN ISSUES\n\n- 0 TODOs, FIXMEs, or placeholders in source code\n- 0 skipped or flaky tests\n- 0 type errors\n- Clean build producing all expected .js and .d.ts files in dist/\n- All 93 tests passing (stop-conditions: 23, middleware: 15, agent: 16, create-agent: 9, human-in-the-loop: 12, context-manager: 12, integration: 6)\n","numLines":90,"startLine":1,"totalLines":90}}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01HGeTbsmwVZqHuTb6AGSKtn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RaMzKvCqAZ52UZt21fNpSr","name":"Bash","input":{"command":"git tag --list","description":"List existing git tags"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":324,"cache_read_input_tokens":46509,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":324},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"4bd4ce16-96cf-444c-ab62-9e1461e89fc9"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RaMzKvCqAZ52UZt21fNpSr","type":"tool_result","content":"v0.0.1","is_error":false}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"a76c7a92-fb69-4625-b2f4-428c5a31598a","tool_use_result":{"stdout":"v0.0.1","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01EnsXzi5UucoxfFXQNihmKv","type":"message","role":"assistant","content":[{"type":"text","text":"Tag `v0.0.1` already exists. After this commit the new tag will be `v0.0.2`. Let me update the implementation plan."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1946,"cache_read_input_tokens":46833,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1946},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"1fe08be2-76c9-4862-a203-20c7b14255bd"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01EnsXzi5UucoxfFXQNihmKv","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RgT5W2RdZfDtdjAw4r5ex9","name":"Write","input":{"file_path":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/IMPLEMENTATION_PLAN.md","content":"# IMPLEMENTATION PLAN -- deep-factor-agent\n\n> A TypeScript library implementing a loop-based AI agent with middleware, verification, stop conditions, human-in-the-loop, and 12-factor compliance.\n>\n> **Stack**: TypeScript 5.x, Vercel AI SDK v6+, Zod v4+ (peer dep), Vitest, pnpm, ESM only\n>\n> **Current State**: Core library fully implemented and documented (93 tests, 7 files, 0 type errors, clean build). Tagged `v0.0.2`.\n\n---\n\n## COMPLETED WORK (Tiers 1-9)\n\nAll items from the implementation plan are complete:\n\n- **Tier 1**: Project initialization (package.json, tsconfig, scripts, vitest config)\n- **Tier 2**: Core types & interfaces (src/types.ts -- 9 event types, AgentThread, TokenUsage, settings, results)\n- **Tier 3**: Stop conditions (maxIterations, maxTokens, maxInputTokens, maxOutputTokens, maxCost, MODEL_PRICING, calculateCost, evaluateStopConditions)\n- **Tier 4A**: Agent loop (DeepFactorAgent class with loop(), stream(), buildMessages, appendResultEvents, addUsage, error recovery)\n- **Tier 4B**: Middleware system (composeMiddleware, todoMiddleware, errorRecoveryMiddleware)\n- **Tier 4C**: Context management (ContextManager with estimateTokens, needsSummarization, summarize, buildContextInjection)\n- **Tier 5**: Factory function (createDeepFactorAgent with sensible defaults) & barrel exports (src/index.ts)\n- **Tier 6**: Human-in-the-loop (requestHumanInput tool, PendingResult with resume(), interruptOn config)\n- **Tier 7**: Cross-cutting integration tests (6 end-to-end scenarios)\n- **Tier 8**: Final validation (all tests pass, type-check clean, build clean, 12-factor alignment verified)\n- **Tier 9**: README documentation (all 9 acceptance criteria met, code examples verified against public API)\n\n---\n\n## KNOWN TYPE NOTES (non-blocking, documented for future work)\n\n- `VerifyContext.result` is typed `unknown` but runtime value is always `string` (from `lastResponse` in agent.ts). README examples guard with `typeof` check. Consider narrowing the type to `string` in a future release.\n- `PendingResult` discriminant narrowing: `AgentResult.stopReason` union includes `\"human_input_needed\"`, so checking `stopReason === \"human_input_needed\"` alone does not narrow to `PendingResult`. README uses `\"resume\" in result` as a runtime type guard. Consider removing `\"human_input_needed\"` from `AgentResult.stopReason` to enable proper discriminated union narrowing.\n\n---\n\n## NO KNOWN ISSUES\n\n- 0 TODOs, FIXMEs, or placeholders in source code\n- 0 skipped or flaky tests\n- 0 type errors\n- Clean build producing all expected .js and .d.ts files in dist/\n- All 93 tests passing (stop-conditions: 23, middleware: 15, agent: 16, create-agent: 9, human-in-the-loop: 12, context-manager: 12, integration: 6)\n"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1946,"cache_read_input_tokens":46833,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1946},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"40cb09b2-0bab-402d-9f2e-b490d1a396b1"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RgT5W2RdZfDtdjAw4r5ex9","type":"tool_result","content":"The file /home/ryaneggz/sandbox/2026/feb/deep-factor-agent/IMPLEMENTATION_PLAN.md has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"be386141-d519-4c5d-bed0-25033eb6b631","tool_use_result":{"type":"update","filePath":"/home/ryaneggz/sandbox/2026/feb/deep-factor-agent/IMPLEMENTATION_PLAN.md","content":"# IMPLEMENTATION PLAN -- deep-factor-agent\n\n> A TypeScript library implementing a loop-based AI agent with middleware, verification, stop conditions, human-in-the-loop, and 12-factor compliance.\n>\n> **Stack**: TypeScript 5.x, Vercel AI SDK v6+, Zod v4+ (peer dep), Vitest, pnpm, ESM only\n>\n> **Current State**: Core library fully implemented and documented (93 tests, 7 files, 0 type errors, clean build). Tagged `v0.0.2`.\n\n---\n\n## COMPLETED WORK (Tiers 1-9)\n\nAll items from the implementation plan are complete:\n\n- **Tier 1**: Project initialization (package.json, tsconfig, scripts, vitest config)\n- **Tier 2**: Core types & interfaces (src/types.ts -- 9 event types, AgentThread, TokenUsage, settings, results)\n- **Tier 3**: Stop conditions (maxIterations, maxTokens, maxInputTokens, maxOutputTokens, maxCost, MODEL_PRICING, calculateCost, evaluateStopConditions)\n- **Tier 4A**: Agent loop (DeepFactorAgent class with loop(), stream(), buildMessages, appendResultEvents, addUsage, error recovery)\n- **Tier 4B**: Middleware system (composeMiddleware, todoMiddleware, errorRecoveryMiddleware)\n- **Tier 4C**: Context management (ContextManager with estimateTokens, needsSummarization, summarize, buildContextInjection)\n- **Tier 5**: Factory function (createDeepFactorAgent with sensible defaults) & barrel exports (src/index.ts)\n- **Tier 6**: Human-in-the-loop (requestHumanInput tool, PendingResult with resume(), interruptOn config)\n- **Tier 7**: Cross-cutting integration tests (6 end-to-end scenarios)\n- **Tier 8**: Final validation (all tests pass, type-check clean, build clean, 12-factor alignment verified)\n- **Tier 9**: README documentation (all 9 acceptance criteria met, code examples verified against public API)\n\n---\n\n## KNOWN TYPE NOTES (non-blocking, documented for future work)\n\n- `VerifyContext.result` is typed `unknown` but runtime value is always `string` (from `lastResponse` in agent.ts). README examples guard with `typeof` check. Consider narrowing the type to `string` in a future release.\n- `PendingResult` discriminant narrowing: `AgentResult.stopReason` union includes `\"human_input_needed\"`, so checking `stopReason === \"human_input_needed\"` alone does not narrow to `PendingResult`. README uses `\"resume\" in result` as a runtime type guard. Consider removing `\"human_input_needed\"` from `AgentResult.stopReason` to enable proper discriminated union narrowing.\n\n---\n\n## NO KNOWN ISSUES\n\n- 0 TODOs, FIXMEs, or placeholders in source code\n- 0 skipped or flaky tests\n- 0 type errors\n- Clean build producing all expected .js and .d.ts files in dist/\n- All 93 tests passing (stop-conditions: 23, middleware: 15, agent: 16, create-agent: 9, human-in-the-loop: 12, context-manager: 12, integration: 6)\n","structuredPatch":[{"oldStart":4,"oldLines":13,"newStart":4,"newLines":13,"lines":[" >"," > **Stack**: TypeScript 5.x, Vercel AI SDK v6+, Zod v4+ (peer dep), Vitest, pnpm, ESM only"," >","-> **Current State**: Core library fully implemented and passing (93 tests, 7 files, 0 type errors, clean build). Tagged `v0.0.1`.","+> **Current State**: Core library fully implemented and documented (93 tests, 7 files, 0 type errors, clean build). Tagged `v0.0.2`."," "," ---"," ","-## COMPLETED WORK (Tiers 1-8)","+## COMPLETED WORK (Tiers 1-9)"," ","-All 70 items from the original implementation plan are complete:","+All items from the implementation plan are complete:"," "," - **Tier 1**: Project initialization (package.json, tsconfig, scripts, vitest config)"," - **Tier 2**: Core types & interfaces (src/types.ts -- 9 event types, AgentThread, TokenUsage, settings, results)"]},{"oldStart":22,"oldLines":62,"newStart":22,"newLines":15,"lines":[" - **Tier 6**: Human-in-the-loop (requestHumanInput tool, PendingResult with resume(), interruptOn config)"," - **Tier 7**: Cross-cutting integration tests (6 end-to-end scenarios)"," - **Tier 8**: Final validation (all tests pass, type-check clean, build clean, 12-factor alignment verified)","+- **Tier 9**: README documentation (all 9 acceptance criteria met, code examples verified against public API)"," "," ---"," ","-## PRIORITY TIER 9 -- README Documentation (SPEC: specs/01-setup-readme.md)","+## KNOWN TYPE NOTES (non-blocking, documented for future work)"," ","-_Depends on: All tiers complete (library is production-ready). No code changes required._","+- `VerifyContext.result` is typed `unknown` but runtime value is always `string` (from `lastResponse` in agent.ts). README examples guard with `typeof` check. Consider narrowing the type to `string` in a future release.","+- `PendingResult` discriminant narrowing: `AgentResult.stopReason` union includes `\"human_input_needed\"`, so checking `stopReason === \"human_input_needed\"` alone does not narrow to `PendingResult`. README uses `\"resume\" in result` as a runtime type guard. Consider removing `\"human_input_needed\"` from `AgentResult.stopReason` to enable proper discriminated union narrowing."," ","-### User Story","-","-**US-09**: As a developer, I would like a README so that I can understand what the library does, how to install it, and how to use it without reading source code.","-","-### Acceptance Criteria","-","-- [ ] **AC-01**: README.md exists at project root","-- [ ] **AC-02**: Contains project name, one-line description, and a brief overview of what the library does","-- [ ] **AC-03**: Contains installation instructions (`pnpm add deep-factor-agent`)","-- [ ] **AC-04**: Contains a \"Quick Start\" section with minimal usage example (createDeepFactorAgent + loop)","-- [ ] **AC-05**: Contains usage examples covering the main features:","-  - Minimal agent (model only)","-  - Agent with tools and verification","-  - Stop conditions (maxIterations, maxTokens, maxCost)","-  - Human-in-the-loop (requestHumanInput, interruptOn, resume)","-  - Middleware (custom middleware, built-in todoMiddleware/errorRecoveryMiddleware)","-  - Streaming (stream())","-  - Context management configuration","-- [ ] **AC-06**: Contains an API reference section listing all public exports organized by category (Factory, Agent Class, Stop Conditions, Middleware, Context Management, Human-in-the-Loop, Types)","-- [ ] **AC-07**: Contains a \"Development\" section with build/test/type-check commands","-- [ ] **AC-08**: Mentions the 12-factor agent alignment and links to the concept","-- [ ] **AC-09**: Mentions peer dependency on Zod v4+ and dependency on Vercel AI SDK v6+","-","-### Implementation Items","-","-- [ ] **9.1** Author `README.md` at project root","-  - **Spec**: specs/01-setup-readme.md","-  - **File**: `README.md`","-  - **Details**:","-    - Title: `deep-factor-agent`","-    - Tagline: one-line description of the library's purpose","-    - Sections: Overview, Installation, Quick Start, Usage Examples, API Reference, Architecture (12-Factor), Development, License","-    - Code examples should use `import { createDeepFactorAgent, maxIterations, requestHumanInput } from \"deep-factor-agent\"` style","-    - All examples must be valid TypeScript that would compile against the library's public API","-    - Reference the factory function `createDeepFactorAgent()` as the primary entry point","-    - Document the defaults table from SPEC-06 (tools, instructions, stopWhen, middleware, contextManagement, etc.)","-    - Document `AgentResult` and `PendingResult` return types","-    - Keep it concise -- developers should be able to scan and use within minutes","-  - **Status**: PENDING","-","-- [ ] **9.2** Verify README code examples compile","-  - **Spec**: specs/01-setup-readme.md","-  - **File**: N/A (validation step)","-  - **Details**:","-    - Review all code snippets in README against the actual public API in `src/index.ts`","-    - Ensure import paths, function signatures, and type names are accurate","-    - Verify examples reflect current Vercel AI SDK v6 patterns (e.g., `stopWhen` + `stepCountIs`, not old `maxSteps`)","-  - **Status**: PENDING","-"," ---"," "," ## NO KNOWN ISSUES"]}],"originalFile":"# IMPLEMENTATION PLAN -- deep-factor-agent\n\n> A TypeScript library implementing a loop-based AI agent with middleware, verification, stop conditions, human-in-the-loop, and 12-factor compliance.\n>\n> **Stack**: TypeScript 5.x, Vercel AI SDK v6+, Zod v4+ (peer dep), Vitest, pnpm, ESM only\n>\n> **Current State**: Core library fully implemented and passing (93 tests, 7 files, 0 type errors, clean build). Tagged `v0.0.1`.\n\n---\n\n## COMPLETED WORK (Tiers 1-8)\n\nAll 70 items from the original implementation plan are complete:\n\n- **Tier 1**: Project initialization (package.json, tsconfig, scripts, vitest config)\n- **Tier 2**: Core types & interfaces (src/types.ts -- 9 event types, AgentThread, TokenUsage, settings, results)\n- **Tier 3**: Stop conditions (maxIterations, maxTokens, maxInputTokens, maxOutputTokens, maxCost, MODEL_PRICING, calculateCost, evaluateStopConditions)\n- **Tier 4A**: Agent loop (DeepFactorAgent class with loop(), stream(), buildMessages, appendResultEvents, addUsage, error recovery)\n- **Tier 4B**: Middleware system (composeMiddleware, todoMiddleware, errorRecoveryMiddleware)\n- **Tier 4C**: Context management (ContextManager with estimateTokens, needsSummarization, summarize, buildContextInjection)\n- **Tier 5**: Factory function (createDeepFactorAgent with sensible defaults) & barrel exports (src/index.ts)\n- **Tier 6**: Human-in-the-loop (requestHumanInput tool, PendingResult with resume(), interruptOn config)\n- **Tier 7**: Cross-cutting integration tests (6 end-to-end scenarios)\n- **Tier 8**: Final validation (all tests pass, type-check clean, build clean, 12-factor alignment verified)\n\n---\n\n## PRIORITY TIER 9 -- README Documentation (SPEC: specs/01-setup-readme.md)\n\n_Depends on: All tiers complete (library is production-ready). No code changes required._\n\n### User Story\n\n**US-09**: As a developer, I would like a README so that I can understand what the library does, how to install it, and how to use it without reading source code.\n\n### Acceptance Criteria\n\n- [ ] **AC-01**: README.md exists at project root\n- [ ] **AC-02**: Contains project name, one-line description, and a brief overview of what the library does\n- [ ] **AC-03**: Contains installation instructions (`pnpm add deep-factor-agent`)\n- [ ] **AC-04**: Contains a \"Quick Start\" section with minimal usage example (createDeepFactorAgent + loop)\n- [ ] **AC-05**: Contains usage examples covering the main features:\n  - Minimal agent (model only)\n  - Agent with tools and verification\n  - Stop conditions (maxIterations, maxTokens, maxCost)\n  - Human-in-the-loop (requestHumanInput, interruptOn, resume)\n  - Middleware (custom middleware, built-in todoMiddleware/errorRecoveryMiddleware)\n  - Streaming (stream())\n  - Context management configuration\n- [ ] **AC-06**: Contains an API reference section listing all public exports organized by category (Factory, Agent Class, Stop Conditions, Middleware, Context Management, Human-in-the-Loop, Types)\n- [ ] **AC-07**: Contains a \"Development\" section with build/test/type-check commands\n- [ ] **AC-08**: Mentions the 12-factor agent alignment and links to the concept\n- [ ] **AC-09**: Mentions peer dependency on Zod v4+ and dependency on Vercel AI SDK v6+\n\n### Implementation Items\n\n- [ ] **9.1** Author `README.md` at project root\n  - **Spec**: specs/01-setup-readme.md\n  - **File**: `README.md`\n  - **Details**:\n    - Title: `deep-factor-agent`\n    - Tagline: one-line description of the library's purpose\n    - Sections: Overview, Installation, Quick Start, Usage Examples, API Reference, Architecture (12-Factor), Development, License\n    - Code examples should use `import { createDeepFactorAgent, maxIterations, requestHumanInput } from \"deep-factor-agent\"` style\n    - All examples must be valid TypeScript that would compile against the library's public API\n    - Reference the factory function `createDeepFactorAgent()` as the primary entry point\n    - Document the defaults table from SPEC-06 (tools, instructions, stopWhen, middleware, contextManagement, etc.)\n    - Document `AgentResult` and `PendingResult` return types\n    - Keep it concise -- developers should be able to scan and use within minutes\n  - **Status**: PENDING\n\n- [ ] **9.2** Verify README code examples compile\n  - **Spec**: specs/01-setup-readme.md\n  - **File**: N/A (validation step)\n  - **Details**:\n    - Review all code snippets in README against the actual public API in `src/index.ts`\n    - Ensure import paths, function signatures, and type names are accurate\n    - Verify examples reflect current Vercel AI SDK v6 patterns (e.g., `stopWhen` + `stepCountIs`, not old `maxSteps`)\n  - **Status**: PENDING\n\n---\n\n## NO KNOWN ISSUES\n\n- 0 TODOs, FIXMEs, or placeholders in source code\n- 0 skipped or flaky tests\n- 0 type errors\n- Clean build producing all expected .js and .d.ts files in dist/\n- All 93 tests passing (stop-conditions: 23, middleware: 15, agent: 16, create-agent: 9, human-in-the-loop: 12, context-manager: 12, integration: 6)\n"}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_012ut3jP2ayQ7NCbUyZUKjMB","type":"message","role":"assistant","content":[{"type":"text","text":"Now commit, push, and tag."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":999,"cache_read_input_tokens":48779,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":999},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"b02c529b-11ce-4703-8dde-dc23b6288514"}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_012ut3jP2ayQ7NCbUyZUKjMB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GhnkTQTWX9D2fBwyhzLooZ","name":"Bash","input":{"command":"git status","description":"Show working tree status"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":999,"cache_read_input_tokens":48779,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":999},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"40106a7a-544d-4be1-b59d-49618f9e4965"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GhnkTQTWX9D2fBwyhzLooZ","type":"tool_result","content":"On branch master\nYour branch is up to date with 'origin/master'.\n\nChanges not staged for commit:\n  (use \"git add/rm <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .claude/prompts/TASK.md\n\tdeleted:    archive/0001/IMPLEMENTATION_PLAN.md\n\tdeleted:    archive/0001/specs/.gitkeep\n\tdeleted:    archive/0001/specs/01-project-setup.md\n\tdeleted:    archive/0001/specs/02-core-types.md\n\tdeleted:    archive/0001/specs/03-stop-conditions.md\n\tdeleted:    archive/0001/specs/04-agent-loop.md\n\tdeleted:    archive/0001/specs/05-middleware.md\n\tdeleted:    archive/0001/specs/06-factory-function.md\n\tdeleted:    archive/0001/specs/07-human-in-the-loop.md\n\tdeleted:    archive/0001/specs/08-context-management.md\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\tCLAUDE.md\n\tIMPLEMENTATION_PLAN.md\n\tREADME.md\n\tarchive/0001-setup/\n\tspecs/01-setup-readme.md\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","is_error":false}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"bc43d202-257e-4afa-8fbd-97be96f11b9f","tool_use_result":{"stdout":"On branch master\nYour branch is up to date with 'origin/master'.\n\nChanges not staged for commit:\n  (use \"git add/rm <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .claude/prompts/TASK.md\n\tdeleted:    archive/0001/IMPLEMENTATION_PLAN.md\n\tdeleted:    archive/0001/specs/.gitkeep\n\tdeleted:    archive/0001/specs/01-project-setup.md\n\tdeleted:    archive/0001/specs/02-core-types.md\n\tdeleted:    archive/0001/specs/03-stop-conditions.md\n\tdeleted:    archive/0001/specs/04-agent-loop.md\n\tdeleted:    archive/0001/specs/05-middleware.md\n\tdeleted:    archive/0001/specs/06-factory-function.md\n\tdeleted:    archive/0001/specs/07-human-in-the-loop.md\n\tdeleted:    archive/0001/specs/08-context-management.md\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\tCLAUDE.md\n\tIMPLEMENTATION_PLAN.md\n\tREADME.md\n\tarchive/0001-setup/\n\tspecs/01-setup-readme.md\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_012ut3jP2ayQ7NCbUyZUKjMB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01F7eiY2EjTn6abLBDQvdRY5","name":"Bash","input":{"command":"git diff --stat","description":"Show diff summary"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":999,"cache_read_input_tokens":48779,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":999},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"8c2fb9a7-5ff3-4303-9411-e85d06e60a11"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01F7eiY2EjTn6abLBDQvdRY5","type":"tool_result","content":" .claude/prompts/TASK.md                     |   9 +-\n archive/0001/IMPLEMENTATION_PLAN.md         | 913 ----------------------------\n archive/0001/specs/.gitkeep                 |   0\n archive/0001/specs/01-project-setup.md      | 295 ---------\n archive/0001/specs/02-core-types.md         | 259 --------\n archive/0001/specs/03-stop-conditions.md    |  85 ---\n archive/0001/specs/04-agent-loop.md         | 158 -----\n archive/0001/specs/05-middleware.md         |  90 ---\n archive/0001/specs/06-factory-function.md   | 157 -----\n archive/0001/specs/07-human-in-the-loop.md  |  87 ---\n archive/0001/specs/08-context-management.md |  85 ---\n 11 files changed, 1 insertion(+), 2137 deletions(-)","is_error":false}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"63edc3c5-ff5a-4988-b6af-e807e3c5e1b4","tool_use_result":{"stdout":" .claude/prompts/TASK.md                     |   9 +-\n archive/0001/IMPLEMENTATION_PLAN.md         | 913 ----------------------------\n archive/0001/specs/.gitkeep                 |   0\n archive/0001/specs/01-project-setup.md      | 295 ---------\n archive/0001/specs/02-core-types.md         | 259 --------\n archive/0001/specs/03-stop-conditions.md    |  85 ---\n archive/0001/specs/04-agent-loop.md         | 158 -----\n archive/0001/specs/05-middleware.md         |  90 ---\n archive/0001/specs/06-factory-function.md   | 157 -----\n archive/0001/specs/07-human-in-the-loop.md  |  87 ---\n archive/0001/specs/08-context-management.md |  85 ---\n 11 files changed, 1 insertion(+), 2137 deletions(-)","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_012ut3jP2ayQ7NCbUyZUKjMB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UntaYUe8kRQSpYg4GTmChQ","name":"Bash","input":{"command":"git log --oneline -5","description":"Show recent commits"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":999,"cache_read_input_tokens":48779,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":999},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"1496c6f6-b8b0-4e28-b6de-3d48d305162b"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UntaYUe8kRQSpYg4GTmChQ","type":"tool_result","content":"904a091 commmit init task\ncc5227b archive specs\n10fb43b Implement complete deep-factor-agent library (Tiers 1-8)\n0b98250 first commit","is_error":false}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"60f294dd-4036-4f42-b0f2-5b79105877b5","tool_use_result":{"stdout":"904a091 commmit init task\ncc5227b archive specs\n10fb43b Implement complete deep-factor-agent library (Tiers 1-8)\n0b98250 first commit","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_0132gxwEt3b4UK3YTjSaRPVp","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XtGb5qWgvzNWM9pLMaACrB","name":"Bash","input":{"command":"git add README.md IMPLEMENTATION_PLAN.md CLAUDE.md specs/01-setup-readme.md && git commit -m \"$(cat <<'EOF'\nAdd README documentation (Tier 9)\n\nAuthored comprehensive README with quick start, usage examples covering\nall features (tools, verification, stop conditions, HITL, middleware,\nstreaming, context management), API reference, defaults table, and\n12-factor agent alignment section. Code examples verified against public API.\n\nCo-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>\nEOF\n)\"","description":"Commit README and related files"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":940,"cache_read_input_tokens":49778,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":940},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"13594562-47f7-474c-b7a5-0d6366082337"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XtGb5qWgvzNWM9pLMaACrB","type":"tool_result","content":"[master 6bfc330] Add README documentation (Tier 9)\n 4 files changed, 406 insertions(+)\n create mode 100644 CLAUDE.md\n create mode 100644 IMPLEMENTATION_PLAN.md\n create mode 100644 README.md\n create mode 100644 specs/01-setup-readme.md","is_error":false}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"f660b4e8-beb5-4480-821c-0e668a6f5120","tool_use_result":{"stdout":"[master 6bfc330] Add README documentation (Tier 9)\n 4 files changed, 406 insertions(+)\n create mode 100644 CLAUDE.md\n create mode 100644 IMPLEMENTATION_PLAN.md\n create mode 100644 README.md\n create mode 100644 specs/01-setup-readme.md","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01UJHJDGUcd5CJb2X5vjvYpZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01M96NG93Ktnzn3BRua6puLs","name":"Bash","input":{"command":"git tag v0.0.2 && git push && git push --tags","description":"Push commit and new tag v0.0.2"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":305,"cache_read_input_tokens":50718,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":305},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"e0efb32f-7c0d-4b70-9ffb-7a5ef8237e24"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01M96NG93Ktnzn3BRua6puLs","type":"tool_result","content":"To github.com:ryaneggz/deep-factor-agent.git\n   904a091..6bfc330  master -> master\nTo github.com:ryaneggz/deep-factor-agent.git\n * [new tag]         v0.0.2 -> v0.0.2","is_error":false}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"71400573-ed09-4e1b-b7a5-0897e10ed949","tool_use_result":{"stdout":"To github.com:ryaneggz/deep-factor-agent.git\n   904a091..6bfc330  master -> master\nTo github.com:ryaneggz/deep-factor-agent.git\n * [new tag]         v0.0.2 -> v0.0.2","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_012XdBe2bQefX7NrnnmDs7YL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01B9L3QMZjJ6R37sEbPrZbWX","name":"TodoWrite","input":{"todos":[{"content":"Study specs and source code","status":"completed","activeForm":"Studying specs and source code"},{"content":"Author README.md per spec 01-setup-readme.md","status":"completed","activeForm":"Authoring README.md"},{"content":"Verify README code examples compile against public API","status":"completed","activeForm":"Verifying README code examples"},{"content":"Update IMPLEMENTATION_PLAN.md and commit/push","status":"completed","activeForm":"Updating plan and committing"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":360,"cache_read_input_tokens":51023,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":360},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"6b45366a-d6d1-48e9-8e12-73e7aaaa497c"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01B9L3QMZjJ6R37sEbPrZbWX","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"a30a0593-ee5b-4569-b036-d7e7246bc2d0","tool_use_result":{"oldTodos":[{"content":"Study specs and source code","status":"completed","activeForm":"Studying specs and source code"},{"content":"Author README.md per spec 01-setup-readme.md","status":"completed","activeForm":"Authoring README.md"},{"content":"Verify README code examples compile against public API","status":"completed","activeForm":"Verifying README code examples"},{"content":"Update IMPLEMENTATION_PLAN.md and commit/push","status":"in_progress","activeForm":"Updating plan and committing"}],"newTodos":[{"content":"Study specs and source code","status":"completed","activeForm":"Studying specs and source code"},{"content":"Author README.md per spec 01-setup-readme.md","status":"completed","activeForm":"Authoring README.md"},{"content":"Verify README code examples compile against public API","status":"completed","activeForm":"Verifying README code examples"},{"content":"Update IMPLEMENTATION_PLAN.md and commit/push","status":"completed","activeForm":"Updating plan and committing"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-6","id":"msg_01FGdupP55gpw6oy76RgjDnj","type":"message","role":"assistant","content":[{"type":"text","text":"All done. Here's a summary of what was completed:\n\n**Tier 9 — README Documentation** is complete and tagged `v0.0.2`.\n\n### What was authored in `README.md`:\n- **Overview** — what the library does and why loop-based agents matter\n- **Installation** — `pnpm add deep-factor-agent ai zod` with peer dependency note (Zod v4+, AI SDK v6+)\n- **Quick Start** — minimal `createDeepFactorAgent` + `loop()` example\n- **7 usage examples** — minimal agent, tools+verification, stop conditions, human-in-the-loop, built-in & custom middleware, streaming, context management\n- **Defaults table** — all `createDeepFactorAgent` defaults documented\n- **API Reference** — all public exports organized by category (Factory, Agent Class, Stop Conditions, Middleware, Context Management, HITL, Types)\n- **12-Factor Agent alignment** — maps all 12 factors to library features\n- **Development section** — build/test/type-check commands\n\n### Issues found during verification and fixed:\n1. **`VerifyContext.result` is `unknown`** — README example now uses `typeof` guard instead of calling `.includes()` directly\n2. **`PendingResult` discriminant narrowing** — README uses `\"resume\" in result` type guard instead of `stopReason` check (which doesn't narrow due to the union type)\n3. **`stream()` is synchronous** — removed misleading `await`\n\nBoth type notes are documented in `IMPLEMENTATION_PLAN.md` for future consideration."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":230,"cache_read_input_tokens":51383,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":230},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","uuid":"1b058cd2-2571-40dd-9ae3-a058a6e92f64"}
{"type":"system","subtype":"task_started","task_id":"a75c7fa32e34bd691","tool_use_id":"toolu_012VH1xZQy1bJCSAhDtuJPGD","description":"Study spec 01-setup-readme","task_type":"local_agent","uuid":"2f101187-1f0d-4d24-a4e1-80732c44815c","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9"}
{"type":"system","subtype":"task_started","task_id":"af09b971e97c5530e","tool_use_id":"toolu_01N9xy9WFsMJnF7NSC2UqbTz","description":"Study src/index.ts exports","task_type":"local_agent","uuid":"48aa9f3a-f118-4e15-b827-682b008e882f","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9"}
{"type":"system","subtype":"task_started","task_id":"a216f69e7da19fc36","tool_use_id":"toolu_019HQB83uJ6b2VSsyKNye9j9","description":"Study src/types.ts","task_type":"local_agent","uuid":"429137bb-1054-42bc-9313-3e2b14f5295b","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9"}
{"type":"system","subtype":"task_started","task_id":"ad3715d6e63d8b850","tool_use_id":"toolu_01NNaDfKGwAaSCJUfopDMNs5","description":"Study src/agent.ts","task_type":"local_agent","uuid":"30943b82-456e-44a0-ac44-a56bcd7be6d7","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9"}
{"type":"system","subtype":"task_started","task_id":"ad9d9e8fad2c2fea4","tool_use_id":"toolu_01QHAcRCQipPe8VqpF7Kenec","description":"Study src/create-agent.ts","task_type":"local_agent","uuid":"27da0cb7-3d3e-456b-987a-1a34a8b2de32","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9"}
{"type":"system","subtype":"task_started","task_id":"a698b52e54d130644","tool_use_id":"toolu_01RdiPt4sCzRoqkeyECTFnFA","description":"Study src/stop-conditions.ts","task_type":"local_agent","uuid":"7eaf9a67-c64f-48ff-b42a-c8ca5653a857","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9"}
{"type":"system","subtype":"task_started","task_id":"ac3f7dfad8f3bb1ad","tool_use_id":"toolu_011gS8qvRtDZ9acZv5a9H5Tq","description":"Study src/middleware.ts","task_type":"local_agent","uuid":"73d0b14f-662e-4ece-ac93-da20a661e770","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9"}
{"type":"system","subtype":"task_started","task_id":"a16332779cadf7d5a","tool_use_id":"toolu_0179bA5dJmNgHuytE2MjrkaY","description":"Study src/context-manager.ts","task_type":"local_agent","uuid":"a630b901-7383-4848-9129-a4b2ba807168","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9"}
{"type":"system","subtype":"task_started","task_id":"a2bc1b8cd4939a53c","tool_use_id":"toolu_01Fyi7ihU6HMVxVWk8StkCMJ","description":"Study src/human-in-the-loop.ts","task_type":"local_agent","uuid":"feda536a-f7a7-4555-9b3d-9201a9bc9e1c","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9"}
{"type":"system","subtype":"task_started","task_id":"a3311f4fba71fb5c5","tool_use_id":"toolu_01ReqGnN35y2QyYNvyYcjPwx","description":"Study package.json","task_type":"local_agent","uuid":"5a5f8299-91db-4063-86e3-c4e4e3fc1279","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9"}
{"type":"system","subtype":"task_started","task_id":"a3e8b27659affd8fc","tool_use_id":"toolu_01ACkEwXt8qgrSgRdPX6gTub","description":"Verify README examples compile","task_type":"local_agent","uuid":"c40e2906-6157-4850-878e-1e4b671b6e5b","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9"}
{"type":"system","subtype":"task_started","task_id":"a59ea651a37efb35f","tool_use_id":"toolu_01DCBiDRq47Zg9siwd2BFKHf","description":"Run tests to verify","task_type":"local_agent","uuid":"bc1342d8-7947-4584-a248-7d7c4bcd149b","session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9"}
{"type":"result","subtype":"success","is_error":false,"duration_ms":314316,"duration_api_ms":405378,"num_turns":34,"result":"All done. Here's a summary of what was completed:\n\n**Tier 9 — README Documentation** is complete and tagged `v0.0.2`.\n\n### What was authored in `README.md`:\n- **Overview** — what the library does and why loop-based agents matter\n- **Installation** — `pnpm add deep-factor-agent ai zod` with peer dependency note (Zod v4+, AI SDK v6+)\n- **Quick Start** — minimal `createDeepFactorAgent` + `loop()` example\n- **7 usage examples** — minimal agent, tools+verification, stop conditions, human-in-the-loop, built-in & custom middleware, streaming, context management\n- **Defaults table** — all `createDeepFactorAgent` defaults documented\n- **API Reference** — all public exports organized by category (Factory, Agent Class, Stop Conditions, Middleware, Context Management, HITL, Types)\n- **12-Factor Agent alignment** — maps all 12 factors to library features\n- **Development section** — build/test/type-check commands\n\n### Issues found during verification and fixed:\n1. **`VerifyContext.result` is `unknown`** — README example now uses `typeof` guard instead of calling `.includes()` directly\n2. **`PendingResult` discriminant narrowing** — README uses `\"resume\" in result` type guard instead of `stopReason` check (which doesn't narrow due to the union type)\n3. **`stream()` is synchronous** — removed misleading `await`\n\nBoth type notes are documented in `IMPLEMENTATION_PLAN.md` for future consideration.","stop_reason":null,"session_id":"43e0f9e1-a14f-4bb2-a8b5-e897764793f9","total_cost_usd":1.6492870000000002,"usage":{"input_tokens":27,"cache_creation_input_tokens":26449,"cache_read_input_tokens":881697,"output_tokens":11421,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":26449,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"},"modelUsage":{"claude-opus-4-6":{"inputTokens":32,"outputTokens":16047,"cacheReadInputTokens":936406,"cacheCreationInputTokens":48939,"webSearchRequests":0,"costUSD":1.1754067500000003,"contextWindow":200000,"maxOutputTokens":32000},"claude-sonnet-4-6":{"inputTokens":46,"outputTokens":7409,"cacheReadInputTokens":231663,"cacheCreationInputTokens":27615,"webSearchRequests":0,"costUSD":0.47388025,"contextWindow":200000,"maxOutputTokens":32000}},"permission_denials":[],"uuid":"4e1f2360-fdc4-4f68-903c-eb334270f07e"}
Everything up-to-date


======================== LOOP 1 ========================

