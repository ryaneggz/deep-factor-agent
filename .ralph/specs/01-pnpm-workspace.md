# SPEC-01: pnpm Workspace Conversion

## CONTEXT

### Problem Statement

The repo currently has a single package (`packages/deep-factor-agent`) with its own `pnpm-lock.yaml`. Adding a second package (`packages/deep-factor-cli`) that depends on the agent via `workspace:*` requires converting to a pnpm workspace monorepo with a root lock file.

### RELEVANT SOURCES
- [pnpm Workspaces](https://pnpm.io/workspaces)
- [pnpm-workspace.yaml](https://pnpm.io/pnpm-workspace_yaml)

### RELEVANT FILES
- `packages/deep-factor-agent/pnpm-lock.yaml` — current per-package lock (to be removed)
- `packages/deep-factor-agent/package.json` — existing package
- `.gitignore` — currently has package-specific paths
- `Makefile` — currently has package-specific targets

---

## OVERVIEW

Enable pnpm workspace linking so the CLI package can consume the agent via `"deep-factor-agent": "workspace:*"`.

---

## USER STORIES

### US-01: Create Workspace Root

**As a** developer
**I want to** have a pnpm workspace root that links all packages
**So that** `workspace:*` dependencies resolve locally and there is a single lock file

#### Acceptance Criteria

- [ ] `/pnpm-workspace.yaml` exists with `packages: ["packages/*"]`
- [ ] `/package.json` exists as private root with workspace-wide scripts
- [ ] `packages/deep-factor-agent/pnpm-lock.yaml` is removed
- [ ] Root `pnpm-lock.yaml` is generated by `pnpm install`
- [ ] `pnpm install` from root installs both packages
- [ ] `pnpm -C packages/deep-factor-agent build` still works
- [ ] `pnpm -C packages/deep-factor-agent test` still works (129/129 pass)

#### Implementation Details

**`/pnpm-workspace.yaml`:**
```yaml
packages:
  - "packages/*"
```

**`/package.json`:**
```json
{
  "private": true,
  "scripts": {
    "build": "pnpm -r build",
    "test": "pnpm -r test",
    "type-check": "pnpm -r type-check"
  }
}
```

---

### US-02: Generalize .gitignore

**As a** developer
**I want** `.gitignore` paths to work for any package in the workspace
**So that** new packages don't need manual `.gitignore` edits

#### Acceptance Criteria

- [ ] `node_modules/` (global pattern, not package-specific)
- [ ] `dist/` (global pattern)
- [ ] `packages/*/.env` (all package env files)
- [ ] `coverage/` (global pattern)
- [ ] `*.tsbuildinfo` (already global)
- [ ] `.ralph/logs/` (unchanged)
- [ ] Root `pnpm-lock.yaml` is NOT ignored (must be committed)

---

## DEPENDENCY ORDER

```
US-01 (workspace root)
  |
  v
US-02 (.gitignore)
```

## VERIFICATION

1. `rm -rf node_modules packages/*/node_modules` then `pnpm install` — single root lock file created
2. `pnpm -C packages/deep-factor-agent build && pnpm -C packages/deep-factor-agent test` — 129/129 pass
3. `git status` shows no `packages/deep-factor-agent/pnpm-lock.yaml`
